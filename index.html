<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>zipipo planner</title>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Gowun+Dodum&family=Kirang+Haerang&display=swap" rel="stylesheet">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* --- Cozy Theme Variables --- */
        :root {
            --bg-ivory: #FDFCF5;
            --wood-frame: #A1887F;
            --wood-text: #5D4037;
            --sage-green: #8FBC8F;
            --point-coral: #FF8A65;
            --pillow-shadow: 0 4px 15px rgba(161, 136, 127, 0.1);
        }
        
        /* Font Setting */
        body, button, input, textarea, select {
            font-family: 'Gowun Dodum', sans-serif !important;
            color: var(--wood-text);
            -webkit-tap-highlight-color: transparent;
        }
        .font-hand { font-family: 'Kirang Haerang', cursive !important; }
        body { background-color: var(--bg-ivory); }

        /* Sticky Header Wrapper */
        .sticky-header-wrapper {
            position: sticky;
            top: 0;
            z-index: 40;
            background-color: var(--bg-ivory);
            box-shadow: 0 2px 10px rgba(0,0,0,0.02);
        }

        /* Pillow Design */
        .pillow-frame {
            background-color: white;
            border-radius: 24px;
            box-shadow: var(--pillow-shadow);
            border: 1px solid #EFEBE9;
            overflow: hidden;
            position: relative;
        }
        .pillow-frame::after {
            content: '';
            position: absolute;
            top: 6px; left: 6px; right: 6px; bottom: 6px;
            border: 2px dashed #D7CCC8;
            border-radius: 20px;
            pointer-events: none;
            opacity: 0.6;
        }

        /* Timeline Style */
        .timeline-container {
            position: relative;
            padding-left: 20px;
        }
        .timeline-line {
            position: absolute;
            left: 7px;
            top: 15px;
            bottom: 0;
            width: 2px;
            background-color: var(--wood-text);
            opacity: 0.3;
            border-radius: 2px;
        }
        .timeline-item:last-child .timeline-line { display: none; }
        .timeline-dot {
            position: absolute;
            left: 3px;
            top: 6px;
            width: 10px;
            height: 10px;
            background-color: var(--wood-text);
            border-radius: 50%;
            z-index: 2;
        }
        
        /* Empty State */
        .empty-state {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem 0;
            text-align: center;
            width: 100%;
        }

        /* Wood Frame */
        .wood-frame {
            border: 2px solid var(--wood-frame);
            border-radius: 16px;
            background: white;
        }

        /* Tabs */
        .tab-btn {
            font-family: 'Kirang Haerang', cursive !important;
            font-size: 1.3rem;
            color: #D7CCC8;
            transition: color 0.2s;
        }
        .tab-active {
            color: var(--wood-text);
            position: relative;
        }
        .tab-active::after {
            content: '';
            position: absolute;
            bottom: 2px;
            left: 50%;
            transform: translateX(-50%);
            width: 6px;
            height: 6px;
            background-color: var(--point-coral);
            border-radius: 50%;
        }

        /* Custom Checkbox */
        .custom-checkbox {
            appearance: none;
            width: 20px;
            height: 20px;
            border: 2px solid #BCAAA4;
            border-radius: 6px;
            cursor: pointer;
            position: relative;
            background-color: #fff;
            transition: all 0.2s;
        }
        .custom-checkbox:checked {
            background-color: var(--sage-green);
            border-color: var(--sage-green);
        }
        .custom-checkbox:checked::after {
            content: 'âœ”';
            position: absolute;
            color: white;
            font-size: 12px;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        /* FAB */
        .fab-house {
            background-color: #A5D6A7;
            clip-path: polygon(50% 0%, 100% 35%, 100% 100%, 0% 100%, 0% 35%);
            display: flex;
            align-items: flex-end;
            justify-content: center;
            padding-bottom: 8px;
            filter: drop-shadow(2px 3px 2px rgba(0,0,0,0.1));
        }
        
        /* Modal Animation */
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .modal-content { animation: slideUp 0.3s ease-out; }

        /* Time Select Styling */
        .time-select {
            border: 1px solid #EFEBE9;
            border-radius: 8px;
            padding: 4px;
            font-size: 0.8rem;
            color: var(--wood-text);
            background-color: white;
            outline: none;
        }

        /* Mini Calendar in Modal */
        .mini-cal-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            text-align: center;
            font-size: 0.8rem;
        }
        .mini-cal-cell {
            padding: 6px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s;
        }
        .mini-cal-cell.selected {
            background-color: var(--sage-green);
            color: white;
            font-weight: bold;
        }
        .mini-cal-cell:hover:not(.selected) {
            background-color: #F1F8E9;
        }
        .modal-tab {
            padding: 8px;
            font-size: 0.9rem;
            color: #BCAAA4;
            border-bottom: 2px solid transparent;
            cursor: pointer;
        }
        .modal-tab.active {
            color: var(--wood-text);
            border-bottom: 2px solid var(--point-coral);
            font-weight: bold;
        }
        
        /* Button Wood Style */
        .btn-wood {
            background-color: var(--wood-frame);
            color: white;
            border-radius: 10px;
            transition: all 0.2s;
        }
        .btn-wood:active { transform: scale(0.96); }
        .btn-wood-outline {
             border: 1px solid var(--wood-frame);
             color: var(--wood-text);
             border-radius: 8px;
             background: #fff;
             transition: all 0.2s;
        }
        .btn-wood-outline:hover {
             background: #FDFCF5;
             color: var(--wood-text);
        }
    </style>
</head>
<body class="max-w-md mx-auto min-h-screen flex flex-col pb-28 relative bg-[#FDFCF5]">

    <!-- Sticky Header Wrapper -->
    <div class="sticky-header-wrapper">
        <!-- Header -->
        <header class="px-6 pt-8 pb-2 flex justify-between items-center bg-[#FDFCF5]">
            <div class="flex items-center gap-2">
                <!-- Flat House Icon -->
                <svg class="w-8 h-8 text-[#8D6E63]" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
                </svg>
                <!-- Text -->
                <h1 class="font-hand text-4xl text-[#5D4037] pt-1">zipipo planner</h1>
            </div>
            <div id="headerDate" class="font-hand text-xl text-[#A1887F]"></div>
        </header>

        <!-- Tabs -->
        <nav class="flex justify-around bg-[#FDFCF5] pb-2 border-b border-[#EFEBE9]">
            <button onclick="switchTab('home')" id="tab-home" class="flex-1 py-2 tab-btn tab-active">Home</button>
            <button onclick="switchTab('project')" id="tab-project" class="flex-1 py-2 tab-btn">Project</button>
            <button onclick="switchTab('achievement')" id="tab-achievement" class="flex-1 py-2 tab-btn">Achievement</button>
            <button onclick="switchTab('me')" id="tab-me" class="flex-1 py-2 tab-btn">Me !</button>
        </nav>
    </div>

    <!-- Main Content -->
    <main id="appContent" class="p-5 flex-1 space-y-6 overflow-y-auto">
        <!-- JS Render -->
    </main>

    <!-- Footer Settings & Login -->
    <footer id="homeFooter" class="mt-auto py-8 text-center hidden">
        <div class="flex justify-center gap-4 text-xs text-[#BCAAA4]">
            <!-- API Key Toggle -->
            <button onclick="toggleApiKeyInput()" class="hover:text-[#8D6E63] font-hand text-lg flex items-center gap-1">
                <!-- ì—´ì‡  ì•„ì´ì½˜ (Key SVG) -->
                <svg class="w-4 h-4 text-[#D7CCC8]" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M12.65 10C11.83 7.67 9.61 6 7 6c-3.31 0-6 2.69-6 6s2.69 6 6 6c2.61 0 4.83-1.67 5.65-4H17v4h4v-4h2v-4H12.65zM7 14c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z"/>
                </svg>
                Key Setting
            </button>
            
            <!-- Google Login (Firebase) - Cloud Icon Style -->
            <button onclick="handleAuthClick()" id="authBtn" class="hover:text-[#FF8A65] font-hand text-lg flex items-center gap-1">
               <!-- Cloud Icon -->
               <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                   <path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96z"/>
               </svg>
               Cloud Login
            </button>
        </div>

        <div id="userInfo" class="hidden text-[10px] text-[#A1887F] mt-2 font-sans font-bold"></div>

        <div id="apiKeyContainer" class="hidden mt-3 mx-8 p-4 bg-white border-2 border-[#EFEBE9] rounded-2xl">
            <input type="password" id="apiKeyInput" placeholder="API Keyë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”" 
                   class="w-full p-2 border-b border-[#D7CCC8] mb-3 text-sm bg-transparent focus:outline-none focus:border-[#8D6E63] text-center text-[#5D4037]">
            <button onclick="saveApiKey()" class="w-full bg-[#D7CCC8] text-white text-sm py-2 rounded-lg font-bold hover:bg-[#BCAAA4]">ì €ì¥í•˜ê¸°</button>
        </div>
    </footer>

    <!-- FAB -->
    <div class="fixed bottom-8 right-6 z-30">
        <button onclick="openGeneratorModal()" class="w-14 h-14 fab-house text-white hover:scale-105 transition active:scale-95 shadow-sm">
            <span class="text-2xl font-bold font-hand">+</span>
        </button>
    </div>

    <!-- Generator Modal (Main) -->
    <div id="generatorModal" class="fixed inset-0 bg-[#4E342E]/20 z-50 hidden flex items-end sm:items-center justify-center backdrop-blur-[1px]">
        <div class="bg-[#FDFCF5] w-full max-w-md p-6 rounded-t-3xl sm:rounded-3xl shadow-xl m-0 sm:m-4 wood-frame modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-hand text-2xl text-[#8D6E63]">ì¼ì • ì§“ê¸°</h3>
                <button onclick="closeModal()" class="text-[#BCAAA4] hover:text-[#8D6E63] text-xl">âœ•</button>
            </div>
            
            <div class="mb-3">
                <label class="text-xs text-[#A1887F] block mb-2">ğŸŒ± í”„ë¡œì íŠ¸ ì—°ë™ (ì—¬ëŸ¬ ê°œ ì„ íƒ ê°€ëŠ¥)</label>
                <div id="projectMultiSelect" class="w-full max-h-32 overflow-y-auto border border-[#D7CCC8] rounded-xl bg-white p-2 space-y-1">
                    <div class="text-xs text-gray-400 italic text-center">í”„ë¡œì íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤</div>
                </div>
            </div>

            <textarea id="taskPrompt" rows="3" class="w-full p-4 border-2 border-[#EFEBE9] rounded-xl mb-4 resize-none focus:outline-none focus:border-[#D7CCC8] bg-white text-sm placeholder-gray-300" placeholder="ì˜ˆ: ê³µë¶€ 2ì‹œê°„ í•˜ê³  ì‚°ì±…í•˜ê¸°"></textarea>
            
            <div class="flex gap-3 mb-3">
                <button onclick="generateSchedule('daily')" class="flex-1 py-3 bg-[#FFAB91] text-white font-bold rounded-xl hover:bg-[#FF8A65] transition shadow-sm text-sm">Daily</button>
                <button onclick="generateSchedule('weekly')" class="flex-1 py-3 bg-[#A5D6A7] text-white font-bold rounded-xl hover:bg-[#81C784] transition shadow-sm text-sm">Weekly</button>
            </div>
            
            <button onclick="openAddTaskModal(null, 'daily')" class="w-full py-2.5 border border-dashed border-[#BCAAA4] text-[#8D6E63] rounded-xl text-xs hover:bg-[#EFEBE9]">ì§ì ‘ í•˜ë‚˜ë§Œ ì¶”ê°€í•˜ê¸° (Daily)</button>
        </div>
    </div>

    <!-- Task Edit/Add Modal (Combined for Time & Date) -->
    <div id="addTaskModal" class="fixed inset-0 bg-black/20 z-[60] hidden flex items-center justify-center backdrop-blur-[1px]">
        <div class="bg-white p-6 rounded-2xl shadow-lg w-80 wood-frame modal-content text-center">
            <h3 id="taskModalTitle" class="font-hand text-xl text-[#8D6E63] mb-4">í•  ì¼ ì¶”ê°€</h3>
            
            <input type="text" id="manualTaskText" class="w-full border-b-2 border-[#D7CCC8] p-2 mb-4 focus:outline-none text-center text-sm" placeholder="í•  ì¼ ë‚´ìš©">
            
            <div id="dailyTimeInputWrapper" class="flex flex-col gap-3 mb-5">
                <div class="flex items-center justify-center gap-2">
                    <span class="text-xs text-[#A1887F] w-8">ì‹œì‘</span>
                    <select id="startHour" class="time-select"></select> : <select id="startMin" class="time-select"></select>
                </div>
                <div class="flex items-center justify-center gap-2">
                    <span class="text-xs text-[#A1887F] w-8">ì¢…ë£Œ</span>
                    <select id="endHour" class="time-select"></select> : <select id="endMin" class="time-select"></select>
                </div>
            </div>

            <div id="weeklyDateInputWrapper" class="hidden mb-5">
                <label class="text-xs text-[#A1887F] block mb-2">ìˆ˜í–‰í•  ë‚ ì§œ (ì„ íƒ)</label>
                <input type="date" id="weeklyTaskDate" class="border border-[#EFEBE9] rounded p-2 text-sm text-[#5D4037] w-full bg-white">
            </div>

            <div class="flex gap-2 justify-center">
                <button onclick="closeAddTaskModal()" class="px-4 py-2 bg-gray-100 rounded-lg text-xs text-gray-500 hover:bg-gray-200">ì·¨ì†Œ</button>
                <button onclick="confirmTaskAction()" class="px-4 py-2 bg-[#8D6E63] text-white rounded-lg text-xs font-bold hover:bg-[#6D4C41]">í™•ì¸</button>
            </div>
        </div>
    </div>

    <!-- Project Input Modal -->
    <div id="projectInputModal" class="fixed inset-0 bg-black/20 z-[60] hidden flex items-center justify-center backdrop-blur-[1px]">
        <div class="bg-white p-6 rounded-2xl shadow-lg w-80 wood-frame modal-content">
            <h3 class="font-hand text-xl text-[#8D6E63] mb-4 text-center">ìƒˆ í”„ë¡œì íŠ¸ ì‹¬ê¸° ğŸŒ±</h3>
            
            <label class="text-xs text-[#A1887F] mb-1 block">í”„ë¡œì íŠ¸ ì´ë¦„</label>
            <input type="text" id="projTitle" class="w-full border-b-2 border-[#D7CCC8] p-2 mb-3 focus:outline-none text-center text-sm" placeholder="">
            
            <label class="text-xs text-[#A1887F] mb-1 block">ë‚´ìš©</label>
            <textarea id="projDesc" class="w-full border-2 border-[#EFEBE9] rounded-xl p-2 mb-3 text-sm focus:outline-none focus:border-[#D7CCC8] resize-none" rows="2"></textarea>

            <div class="flex border-b border-[#EFEBE9] mb-3">
                <div onclick="switchProjMode('range')" id="pm-range" class="flex-1 text-center modal-tab active">ê¸°ê°„ ì§€ì •</div>
                <div onclick="switchProjMode('select')" id="pm-select" class="flex-1 text-center modal-tab">ë‚ ì§œ ì„ íƒ</div>
            </div>

            <div id="projModeRange">
                <div class="flex gap-2 mb-2">
                    <div class="flex-1">
                        <label class="text-xs text-[#A1887F] mb-1 block">ì‹œì‘ì¼</label>
                        <input type="date" id="projStart" class="w-full border border-[#EFEBE9] rounded p-1 text-xs text-[#5D4037]">
                    </div>
                    <div class="flex-1">
                        <label class="text-xs text-[#A1887F] mb-1 block">ì¢…ë£Œì¼</label>
                        <input type="date" id="projEnd" class="w-full border border-[#EFEBE9] rounded p-1 text-xs text-[#5D4037]">
                    </div>
                </div>
            </div>

            <div id="projModeSelect" class="hidden">
                <div class="flex justify-between items-center mb-2 px-2">
                    <button onclick="moveProjCal(-1)" class="text-[#8D6E63]">â—€</button>
                    <span id="projCalTitle" class="text-xs font-bold text-[#5D4037]"></span>
                    <button onclick="moveProjCal(1)" class="text-[#8D6E63]">â–¶</button>
                </div>
                <div class="mini-cal-grid mb-1">
                    <div class="text-[#A1887F]">ì¼</div><div class="text-[#A1887F]">ì›”</div><div class="text-[#A1887F]">í™”</div><div class="text-[#A1887F]">ìˆ˜</div><div class="text-[#A1887F]">ëª©</div><div class="text-[#A1887F]">ê¸ˆ</div><div class="text-[#A1887F]">í† </div>
                </div>
                <div id="projCalGrid" class="mini-cal-grid mb-2 min-h-[120px]"></div>
                <div class="text-[10px] text-right text-[#8D6E63]"><span id="selectedCount">0</span>ì¼ ì„ íƒë¨</div>
            </div>

            <div class="flex gap-2 justify-center mt-3">
                <button onclick="closeProjectModal()" class="px-4 py-2 bg-gray-100 rounded-lg text-xs text-gray-500 hover:bg-gray-200">ì·¨ì†Œ</button>
                <button onclick="confirmCreateProject()" class="px-4 py-2 bg-[#556B2F] text-white rounded-lg text-xs font-bold hover:bg-[#33691E]">ì‹¬ê¸°</button>
            </div>
        </div>
    </div>

    <!-- Simple Input Modal -->
    <div id="inputModal" class="fixed inset-0 bg-black/20 z-[60] hidden flex items-center justify-center backdrop-blur-[1px]">
        <div class="bg-white p-5 rounded-2xl shadow-lg w-80 wood-frame modal-content text-center">
            <h3 id="inputModalTitle" class="font-hand text-xl text-[#8D6E63] mb-3">ì…ë ¥</h3>
            <input type="text" id="inputModalField" class="w-full border-b-2 border-[#D7CCC8] p-2 mb-4 focus:outline-none text-center" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”">
            <div class="flex gap-2 justify-center">
                <button onclick="closeInputModal()" class="px-4 py-2 bg-gray-200 rounded-lg text-xs text-gray-500">ì·¨ì†Œ</button>
                <button onclick="confirmInput()" class="px-4 py-2 bg-[#8D6E63] text-white rounded-lg text-xs font-bold">í™•ì¸</button>
            </div>
        </div>
    </div>

<script type="module">
    // --- Firebase Integration (Stable Version) ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

    // ğŸ”´ ì¤‘ìš”: ì—¬ê¸°ì— Firebase ì½˜ì†”ì—ì„œ ë°œê¸‰ë°›ì€ ì„¤ì •ì„ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”!
    const firebaseConfig = {
      apiKey: "AIzaSyC0xDTlZb5J_ao5LNcDDPgzmtGVgJjsT7k",
      authDomain: "zipipo-planner.firebaseapp.com",
      projectId: "zipipo-planner",
      storageBucket: "zipipo-planner.firebasestorage.app",
      messagingSenderId: "686296340674",
      appId: "1:686296340674:web:26770699ef72bf65a5835b"
    };

    let auth, db, user = null;
    let isFirebaseEnabled = false;

    if (firebaseConfig.apiKey && firebaseConfig.apiKey !== "API_KEY_HERE") {
        try {
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            isFirebaseEnabled = true;
            console.log("ğŸ”¥ Firebase Enabled");
        } catch(e) { console.log("Firebase config error:", e); }
    } else {
        console.log("âš ï¸ Firebase ì„¤ì •ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤. ë¡œì»¬ ëª¨ë“œë¡œ ë™ì‘í•©ë‹ˆë‹¤.");
    }

    // --- Global Variables ---
    window.appData = { daily: {}, weekly: {}, projects: [], analysisHistory: [] };
    let currentTab = 'home';
    let selectedDate = new Date().toISOString().split('T')[0];
    let calendarDate = new Date();
    let achievementViewDate = new Date().toISOString().split('T')[0]; 
    let inputCallback = null;
    let editingTask = null;
    let projCalDate = new Date();
    let selectedProjDates = new Set();
    let projMode = 'range';
    let currentTaskTypeForAdd = 'daily'; 

    const STORAGE_KEY_API = 'zipipo_v2_apikey';
    const STORAGE_KEY_DATA = 'zipipo_v2_data'; 
    const GEMINI_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent';

    // [ì•„ì´ì½˜ SVG ì •ì˜]
    const ICON_CLOUD = `<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96z"/></svg>`;
    const ICON_EDIT = `<svg class="w-3 h-3 text-[#BCAAA4] hover:text-[#8D6E63]" fill="currentColor" viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>`;

    // --- Data Management ---
    async function loadData() {
        if (isFirebaseEnabled && user) {
            try {
                const docRef = doc(db, "users", user.uid, "planner", "data");
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    window.appData = docSnap.data();
                } 
            } catch(e) { console.error("Cloud load error", e); }
        } else {
            const json = localStorage.getItem(STORAGE_KEY_DATA);
            if (json) window.appData = JSON.parse(json);
        }
        if (!window.appData.daily) window.appData.daily = {};
        if (!window.appData.weekly) window.appData.weekly = {};
        if (!window.appData.projects) window.appData.projects = [];
        if (!window.appData.analysisHistory) window.appData.analysisHistory = [];
    }

    async function saveData() {
        localStorage.setItem(STORAGE_KEY_DATA, JSON.stringify(window.appData));
        if (isFirebaseEnabled && user) {
            try {
                await setDoc(doc(db, "users", user.uid, "planner", "data"), window.appData);
            } catch(e) { console.error("Cloud save error", e); }
        }
    }

    // --- Auth Functions ---
    async function handleAuthClick() {
        if (!isFirebaseEnabled) return alert("Firebase ì„¤ì •(firebaseConfig)ì„ ì½”ë“œì— ì…ë ¥í•´ì£¼ì„¸ìš”!");
        if (user) {
            if(confirm("ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                await signOut(auth);
                alert("ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.");
                user = null;
                updateAuthUI();
                renderApp();
            }
        } else {
            try {
                const provider = new GoogleAuthProvider();
                await signInWithPopup(auth, provider);
            } catch(e) { 
                console.error(e);
                alert("ë¡œê·¸ì¸ ì˜¤ë¥˜: " + e.message + "\n(ë„ë©”ì¸ ìŠ¹ì¸ ë¬¸ì œì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. Firebase Console > Authentication > Settings > Authorized Domainsì— í˜„ì¬ ë„ë©”ì¸ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”.)");
            }
        }
    }

    function updateAuthUI() {
        const btn = document.getElementById('authBtn');
        const info = document.getElementById('userInfo');
        if (user) {
            btn.innerHTML = `${ICON_CLOUD} Logout`; 
            info.innerHTML = user.email;
            info.classList.remove('hidden');
        } else {
            btn.innerHTML = `${ICON_CLOUD} Cloud Login`;
            info.classList.add('hidden');
        }
    }

    function saveApiKey() {
        const key = document.getElementById('apiKeyInput').value.trim();
        if (key) { localStorage.setItem(STORAGE_KEY_API, key); toggleApiKeyInput(); alert('Key ì €ì¥ ì™„ë£Œ! ğŸ—ï¸'); }
    }

    // --- Icons ---
    const ICON_LIGHT_WOOD = `<svg class="w-6 h-6 inline-block mr-1" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M12 0V6" stroke="#D7CCC8" stroke-width="1.5"/><path d="M4 14C4 9.5 7.58 6 12 6C16.42 6 20 9.5 20 14H4Z" fill="#FFF8E1" stroke="#D7CCC8" stroke-width="1.5"/><path d="M10 14H14V15C14 15.55 13.55 16 13 16H11C10.45 16 10 15.55 10 15V14Z" fill="#D7CCC8" stroke="none"/></svg>`;
    const ICON_SPEECH = `<svg class="w-4 h-4 text-[#BCAAA4] hover:text-[#8D6E63] transition" fill="currentColor" viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/></svg>`;
    const ICON_FLAT_HOUSE_SVG = `<svg class="w-20 h-20 mb-4 text-[#D7CCC8]" fill="currentColor" viewBox="0 0 24 24"><path d="M12 3L2 12h3v8h6v-6h2v6h6v-8h3L12 3z"/></svg>`;

    function renderHeader() {
        const today = new Date();
        const days = ['ì¼ìš”ì¼', 'ì›”ìš”ì¼', 'í™”ìš”ì¼', 'ìˆ˜ìš”ì¼', 'ëª©ìš”ì¼', 'ê¸ˆìš”ì¼', 'í† ìš”ì¼'];
        document.getElementById('headerDate').textContent = `${today.getMonth()+1}ì›” ${today.getDate()}ì¼ ${days[today.getDay()]}`;
    }

    // --- Core Functions ---
    function switchTab(tab) {
        currentTab = tab;
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('tab-active'));
        document.getElementById(`tab-${tab}`).classList.add('tab-active');
        renderApp();
    }

    function renderApp() {
        const container = document.getElementById('appContent');
        const footer = document.getElementById('homeFooter');
        container.innerHTML = '';
        if (currentTab === 'home') {
            renderHome(container);
            footer.classList.remove('hidden');
        } else {
            footer.classList.add('hidden');
            if (currentTab === 'achievement') renderCalendar(container);
            else if (currentTab === 'project') renderProjects(container);
            else if (currentTab === 'me') renderAnalysis(container);
        }
    }

    // [ìˆ˜ì •] renderHome í•¨ìˆ˜: Weekly ì„¹ì…˜ì„ ìº˜ë¦°ë”í˜•(ìš”ì¼ë³„)ìœ¼ë¡œ ë³€ê²½
    function renderHome(container) {
        const weekKey = getWeekKey(new Date());
        const weeklyData = window.appData.weekly[weekKey] || { tasks: [] };
        
        const secWeekly = document.createElement('section');
        secWeekly.className = 'pillow-frame mb-5 bg-[#F1F8E9]'; 
        const headerWeekly = document.createElement('div');
        headerWeekly.className = 'px-6 pt-3 pb-2 flex items-center justify-between z-10 relative';
        headerWeekly.innerHTML = `
            <div class="flex items-center gap-1">${ICON_LIGHT_WOOD} <span class="font-hand text-2xl text-[#5D4037]">Weekly</span></div>
            <div class="flex items-center gap-2">
                <span class="text-xs text-[#BCAAA4] font-sans bg-white/80 px-2 rounded-full">${getWeekRangeStr(new Date())}</span>
                <button onclick="openAddTaskModal(null, 'weekly')" class="w-6 h-6 rounded-full bg-white text-[#8D6E63] border border-[#D7CCC8] hover:bg-[#D7CCC8] hover:text-white flex items-center justify-center font-bold text-sm" title="ì§ì ‘ ì¶”ê°€">+</button>
            </div>
        `;
        secWeekly.appendChild(headerWeekly);

        // [Weekly Message Separation]
        const weeklyMessages = weeklyData.tasks.filter(t => t.isMessage);
        if (weeklyMessages.length > 0) {
            const msgDiv = document.createElement('div');
            msgDiv.className = 'mx-6 mt-1 mb-3 p-3 bg-white/60 rounded-xl border border-[#C5E1A5] text-sm text-[#556B2F] relative z-10 font-hand leading-relaxed';
            msgDiv.innerHTML = weeklyMessages.map(m => m.text).join('<br>');
            secWeekly.appendChild(msgDiv);
        }

        const weeklyRealTasks = weeklyData.tasks.filter(t => !t.isMessage);
        const contentWrap = document.createElement('div');
        contentWrap.className = 'px-6 pb-5 pt-1 relative z-10 flex flex-col gap-4'; 

        // [Weekly Day Grouping]
        const currentSun = getSunday(new Date());
        const daysOfWeek = [];
        for(let i=0; i<7; i++) {
            const d = new Date(currentSun);
            d.setDate(d.getDate() + i);
            daysOfWeek.push(d);
        }

        const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        daysOfWeek.forEach((day, idx) => {
            const dayStr = day.toISOString().split('T')[0];
            const dayTasks = weeklyRealTasks.filter(t => t.specificDate === dayStr);
            
            const daySection = document.createElement('div');
            daySection.className = 'flex flex-col';
            
            const isToday = dayStr === getTodayStr();
            const headerColor = idx === 0 ? 'text-red-400' : (idx === 6 ? 'text-blue-400' : 'text-[#8D6E63]');
            const headerBg = isToday ? 'bg-[#FFE0B2]' : 'bg-white/50';
            
            daySection.innerHTML = `
                <div class="flex items-center mb-1">
                    <span class="${headerBg} px-2 py-0.5 rounded text-xs font-bold ${headerColor} font-sans">
                        ${dayNames[idx]} ${day.getMonth()+1}.${day.getDate()}
                    </span>
                </div>
            `;
            
            if (dayTasks.length > 0) {
                const ul = document.createElement('ul');
                ul.className = 'pl-2 border-l-2 border-[#D7CCC8]/30 ml-2 space-y-2'; 
                dayTasks.forEach(t => {
                    const originalIdx = weeklyData.tasks.indexOf(t);
                    ul.appendChild(createTaskEl(t, 'weekly', weekKey, originalIdx));
                });
                daySection.appendChild(ul);
            } 
            contentWrap.appendChild(daySection);
        });

        const anytimeTasks = weeklyRealTasks.filter(t => !t.specificDate);
        if (anytimeTasks.length > 0) {
            const anytimeSection = document.createElement('div');
            anytimeSection.className = 'flex flex-col mt-2 pt-3 border-t border-dashed border-[#C5E1A5]';
            anytimeSection.innerHTML = `<div class="text-xs font-bold text-[#556B2F] mb-2 px-1">Anytime (ì´ë²ˆ ì£¼ ì–¸ì œë‚˜)</div>`;
            const ul = document.createElement('ul');
            ul.className = 'pl-2 space-y-2';
            anytimeTasks.forEach(t => {
                const originalIdx = weeklyData.tasks.indexOf(t);
                ul.appendChild(createTaskEl(t, 'weekly', weekKey, originalIdx));
            });
            anytimeSection.appendChild(ul);
            contentWrap.appendChild(anytimeSection);
        }

        if(weeklyRealTasks.length === 0) {
             contentWrap.innerHTML = `<div class="empty-state"><span class="text-xs text-[#8D6E63] opacity-60">ì´ë²ˆ ì£¼ ëª©í‘œë¥¼ ì„¸ì›Œë³´ì„¸ìš”!</span></div>`;
        }

        secWeekly.appendChild(contentWrap);
        container.appendChild(secWeekly);

        const secDaily = document.createElement('section');
        secDaily.className = 'pillow-frame mb-6 bg-[#FFF3E0]'; 
        const headerDaily = document.createElement('div');
        headerDaily.className = 'px-6 pt-3 pb-2 flex justify-between items-center z-10 relative';
        headerDaily.innerHTML = `
            <div class="flex items-center gap-1">${ICON_LIGHT_WOOD} <span class="font-hand text-2xl text-[#5D4037]">Daily</span></div>
            <input type="date" value="${selectedDate}" onchange="changeDate(this.value)" class="text-xs border-0 rounded px-2 py-1 font-sans text-gray-500 bg-white/50 focus:outline-none">
        `;
        secDaily.appendChild(headerDaily);

        const contentDaily = document.createElement('div');
        const todayTasks = window.appData.daily[selectedDate] || [];
        
        const messages = todayTasks.filter(t => t.isMessage);
        if (messages.length > 0) {
            const msgDiv = document.createElement('div');
            msgDiv.className = 'mx-6 mt-2 mb-4 p-3 bg-white/60 rounded-xl border border-[#FFE0B2] text-sm text-[#5D4037] relative z-10 font-hand leading-relaxed';
            msgDiv.innerHTML = messages.map(m => m.text).join('<br>');
            secDaily.appendChild(msgDiv);
        }

        const realTasks = todayTasks.filter(t => !t.isMessage); 

        if(realTasks.length > 0) {
            contentDaily.className = 'timeline-container px-6 pb-5 pt-1 relative z-10';
            contentDaily.innerHTML = `<div class="timeline-line"></div>`; 
            const ulDaily = document.createElement('ul');
            realTasks.sort((a,b) => {
                const timeA = a.manualTimeRange || a.startTime || '23:59';
                const timeB = b.manualTimeRange || b.startTime || '23:59';
                return timeA.localeCompare(timeB);
            });
            realTasks.forEach((t, i) => ulDaily.appendChild(createTaskEl(t, 'daily', selectedDate, i)));
            contentDaily.appendChild(ulDaily);
        } else {
            contentDaily.className = 'empty-state relative z-10';
            contentDaily.innerHTML = `<span class="text-xs text-[#8D6E63] opacity-60">ì˜¤ëŠ˜ì˜ ëª©í‘œë¥¼ ì„¸ì›Œë³´ì„¸ìš”!</span>`;
        }
        secDaily.appendChild(contentDaily);
        container.appendChild(secDaily);

        if(window.appData.projects.length > 0) {
            const secProj = document.createElement('section');
            secProj.innerHTML = `<h3 class="font-hand text-xl text-[#556B2F] mb-3 px-1 flex items-center gap-1">ğŸŒ± Growing Projects</h3>`;
            const scrollDiv = document.createElement('div');
            scrollDiv.className = 'flex gap-3 overflow-x-auto pb-4 px-1';
            window.appData.projects.forEach(p => {
                const card = document.createElement('div');
                card.className = 'min-w-[130px] wood-frame p-3 bg-white flex-shrink-0 border border-[#C5E1A5]'; 
                const doneCnt = p.tasks.filter(t=>t.done).length;
                card.innerHTML = `
                    <div class="text-xs text-[#33691E] font-bold mb-1 truncate">${p.title}</div>
                    <div class="text-[9px] text-[#A1887F] mb-1 font-sans">${p.dateDisplay || ''}</div>
                    <div class="text-[9px] text-[#8D6E63] mb-1 font-sans truncate">${p.desc || ''}</div>
                    <div class="w-full bg-[#F1F8E9] h-1.5 rounded-full mt-1 overflow-hidden">
                        <div class="bg-[#8FBC8F] h-full" style="width:${p.tasks.length ? (doneCnt/p.tasks.length)*100 : 0}%"></div>
                    </div>
                    <div class="text-[10px] text-[#558B2F] font-sans text-right mt-1">${doneCnt}/${p.tasks.length}</div>
                `;
                scrollDiv.appendChild(card);
            });
            secProj.appendChild(scrollDiv);
            container.appendChild(secProj);
        }
    }

    function getSunday(d) {
        d = new Date(d);
        var day = d.getDay();
        var diff = d.getDate() - day;
        return new Date(d.setDate(diff));
    }

    function renderCalendar(container) {
        const year = calendarDate.getFullYear();
        const month = calendarDate.getMonth();
        const wrapper = document.createElement('div');
        wrapper.className = 'wood-frame p-5 bg-white min-h-[400px] flex flex-col';
        const header = document.createElement('div');
        header.className = 'flex justify-between items-center mb-6';
        header.innerHTML = `
            <button onclick="moveMonth(-1)" class="text-[#8D6E63] hover:text-[#FF7F50] text-xl font-bold px-2">â—€</button>
            <h2 class="font-hand text-2xl text-[#5D4037]">${year}ë…„ ${month+1}ì›”</h2>
            <button onclick="moveMonth(1)" class="text-[#8D6E63] hover:text-[#FF7F50] text-xl font-bold px-2">â–¶</button>
        `;
        wrapper.appendChild(header);
        const grid = document.createElement('div');
        grid.className = 'grid grid-cols-7 gap-y-4 gap-x-1 text-center text-sm mb-6';
        ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '].forEach(d => grid.innerHTML += `<div class="font-bold text-[#A1887F] text-xs pb-2">${d}</div>`);
        const firstDay = new Date(year, month, 1).getDay();
        const lastDate = new Date(year, month + 1, 0).getDate();
        for(let i=0; i<firstDay; i++) grid.innerHTML += `<div></div>`;
        
        for(let d=1; d<=lastDate; d++) {
            const dateStr = `${year}-${(month+1).toString().padStart(2,'0')}-${d.toString().padStart(2,'0')}`;
            const tasks = window.appData.daily[dateStr] || [];
            
            let percent = 0;
            if(tasks.length > 0) {
                const doneCount = tasks.filter(t => t.done).length;
                percent = (doneCount / tasks.length) * 100;
            }
            
            const bgStyle = tasks.length > 0 
                ? `background: linear-gradient(to top, #8FBC8F ${percent}%, transparent ${percent}%);` 
                : '';
                
            const isSelected = dateStr === achievementViewDate;
            const borderClass = isSelected ? 'border-2 border-[#FF8A65] shadow-md scale-110' : (dateStr === getTodayStr() ? 'border border-[#8D6E63]' : '');
            
            const dayEl = document.createElement('div');
            dayEl.className = `${borderClass} w-8 h-8 rounded-full flex items-center justify-center mx-auto transition text-xs cursor-pointer hover:scale-110`;
            if (bgStyle) {
                dayEl.setAttribute('style', bgStyle);
                if (percent > 50) dayEl.classList.add('text-white', 'text-shadow'); 
                else dayEl.classList.add('text-[#5D4037]');
            } else {
                dayEl.classList.add('text-gray-400');
            }
            
            dayEl.innerText = d;
            dayEl.onclick = () => {
                achievementViewDate = dateStr;
                renderApp(); 
            };
            grid.appendChild(dayEl);
        }
        wrapper.appendChild(grid);
        
        const tasks = window.appData.daily[achievementViewDate] || [];
        const feedbacks = tasks.filter(t => t.feedback).map(t => t.feedback);
        const fbSection = document.createElement('div');
        fbSection.className = 'mt-auto pt-4 border-t border-[#EFEBE9]';
        
        let detailsHtml = `
            <h3 class="font-hand text-lg text-[#5D4037] mb-2 border-b border-[#EFEBE9] pb-1">
                ${achievementViewDate}
            </h3>
        `;
        
        const realTasks = tasks.filter(t => !t.isMessage); 

        if (realTasks.length === 0) {
            detailsHtml += `<p class="text-xs text-[#BCAAA4] italic text-center py-4">ì´ ë‚ ì€ ê¸°ë¡ëœ ì¼ì •ì´ ì—†ì–´ìš”.</p>`;
        } else {
            detailsHtml += `<div class="mb-4"><ul class="space-y-1">`;
            realTasks.forEach(t => {
                const checkMark = t.done ? '<span class="text-[#556B2F]">âœ”</span>' : '<span class="text-[#D7CCC8]">â¬œ</span>';
                const textStyle = t.done ? 'text-gray-400 line-through' : 'text-[#5D4037]';
                detailsHtml += `<li class="text-xs flex gap-1 items-center">${checkMark} <span class="${textStyle} truncate">${t.text}</span></li>`;
            });
            detailsHtml += `</ul></div>`;
            
            detailsHtml += `<div class="mt-3 pt-2 border-t border-dashed border-[#EFEBE9]">
                <h4 class="font-hand text-lg text-[#5D4037] mb-2">Today's Note</h4>`;
            
            if (feedbacks.length > 0) {
                detailsHtml += `<ul class="space-y-2">`;
                feedbacks.forEach(fb => {
                    detailsHtml += `<li class="text-xs text-[#5D4037] bg-[#FAF8F5] p-2 rounded-lg border border-[#F5F5DC]">"${fb}"</li>`;
                });
                detailsHtml += `</ul>`;
            } else {
                detailsHtml += `<p class="text-xs text-[#BCAAA4] italic">ë‚¨ê²¨ì§„ ë©”ëª¨ê°€ ì—†ì–´ìš”.</p>`;
            }
            detailsHtml += `</div>`;
        }
        
        fbSection.innerHTML = detailsHtml;
        wrapper.appendChild(fbSection);
        container.appendChild(wrapper);
    }
    
    function moveMonth(d) { calendarDate.setMonth(calendarDate.getMonth() + d); renderApp(); }

    function renderProjects(container) {
        const btnAdd = document.createElement('button');
        // [ìˆ˜ì •] ë²„íŠ¼ ìŠ¤íƒ€ì¼: í´ë¦­ ì‹œ ëˆŒë¦° ëŠë‚Œì´ ë‚˜ë„ë¡ active ë°°ê²½ìƒ‰ì„ ì§„í•˜ê²Œ ë³€ê²½
        btnAdd.className = 'w-full py-4 border-2 border-dashed border-[#A1887F] text-[#8D6E63] font-hand text-xl rounded-2xl mb-6 hover:bg-[#FDFCF5] active:bg-[#D7CCC8] active:text-white transition bg-white shadow-sm';
        btnAdd.textContent = '+ ìƒˆë¡œìš´ í”„ë¡œì íŠ¸ ì‹¬ê¸°';
        btnAdd.setAttribute('onclick', 'openProjectModal()');
        
        container.appendChild(btnAdd);

        if(window.appData.projects.length === 0) {
            container.innerHTML += `<div class="text-center text-[#BCAAA4] font-hand text-xl mt-12 opacity-70">ì—¬ê¸°ì— ì¥ê¸° ëª©í‘œë¥¼ ì‹¬ì–´ë³´ì„¸ìš” ğŸŒ±</div>`;
            return;
        }

        window.appData.projects.forEach(p => {
            const card = document.createElement('div');
            card.className = 'wood-frame p-5 bg-white mb-5';
            const header = document.createElement('div');
            header.className = 'flex flex-col gap-1 mb-3 pb-2 border-b border-[#F1F8E9]';
            header.innerHTML = `
                <div class="flex justify-between items-center">
                    <h3 class="font-bold text-lg text-[#556B2F]">ğŸŒ¿ ${p.title}</h3>
                    <div class="flex gap-1">
                        <button onclick="generateProjectTasks('${p.id}', '${p.title}')" class="text-xs bg-[#8D6E63] text-white px-2 py-1 rounded hover:bg-[#6D4C41]">ìƒì„±</button>
                        <button onclick="deleteProject('${p.id}')" class="text-[#D7CCC8] hover:text-[#FF7F50] px-1">âœ•</button>
                    </div>
                </div>
                <div class="text-xs text-[#A1887F] font-sans">${p.dateDisplay || ''}</div>
                <div class="text-xs text-[#8D6E63] font-sans">${p.desc || ''}</div>
            `;
            card.appendChild(header);
            const ul = document.createElement('ul');
            ul.className = 'pl-1 space-y-2'; 
            if(p.tasks.length === 0) ul.innerHTML = `<li class="text-xs text-gray-300 italic text-center py-2">AIì—ê²Œ ê³„íšì„ ìš”ì²­í•´ë³´ì„¸ìš”</li>`;
            p.tasks.forEach((t, i) => ul.appendChild(createTaskEl(t, 'project', p.id, i)));
            card.appendChild(ul);
            container.appendChild(card);
        });
    }

    function renderAnalysis(container) {
        const wrapper = document.createElement('div');
        wrapper.className = 'wood-frame p-6 bg-white flex flex-col items-center text-center min-h-[400px] justify-center';
        wrapper.innerHTML = `
            <div class="mb-4 text-[#D7CCC8]">${ICON_FLAT_HOUSE_SVG}</div>
            <h2 class="font-hand text-3xl mb-3 text-[#8D6E63]">ë‚˜ì˜ ì„±í–¥ì€?</h2>
            <p class="text-sm text-[#A1887F] mb-8 leading-relaxed">zipipoê°€ ë‹¹ì‹ ì˜ ì¼ìƒì„ ë³´ê³ <br>ë”°ëœ»í•œ ì¡°ì–¸ì„ í•´ë“œë¦´ê²Œìš”.</p>
            <button onclick="runAnalysis()" class="btn-wood-outline px-8 py-3 mb-8 shadow-sm font-bold text-sm">ë¶„ì„ ìš”ì²­í•˜ê¸°</button>
            <div id="analysisLoading" class="hidden text-[#8D6E63] text-xs animate-pulse mb-4">
                zipipoê°€ ì—´ì‹¬íˆ ë¶„ì„í•˜ê³  ìˆì–´ìš”... ğŸ’­
            </div>
        `;
        const historyDiv = document.createElement('div');
        historyDiv.id = 'analysisResultArea';
        historyDiv.className = 'w-full space-y-4';
        if (window.appData.analysisHistory && window.appData.analysisHistory.length > 0) {
            const latest = window.appData.analysisHistory[window.appData.analysisHistory.length - 1];
            historyDiv.innerHTML = `
                <div class="text-left text-sm bg-[#FAF8F5] p-5 rounded-xl border border-[#EFEBE9] text-[#5D4037] leading-relaxed">
                    <div class="text-xs text-[#FF8A65] mb-2 font-bold">${latest.date}ì˜ ê¸°ë¡</div>
                    ${latest.text.replace(/\n/g, '<br>')}
                </div>
            `;
        }
        wrapper.appendChild(historyDiv);
        container.appendChild(wrapper);
    }

    function createTaskEl(task, type, key, index) {
        const li = document.createElement('li');
        li.className = 'timeline-container flex flex-col mb-4'; 
        const dot = document.createElement('div');
        dot.className = 'timeline-dot';
        li.appendChild(dot);
        const line = document.createElement('div');
        line.className = 'timeline-line';
        li.appendChild(line);
        const content = document.createElement('div');
        content.className = 'flex items-start justify-between w-full pl-2';
        const textGroup = document.createElement('div');
        textGroup.className = 'flex flex-col flex-1 mr-2';
        let timeStr = "";
        if(task.manualTimeRange) timeStr = task.manualTimeRange;
        
        if(task.startTime && task.endTime) {
            const diff = Math.round((new Date(task.endTime)-new Date(task.startTime))/60000);
            timeStr = `${formatTime(task.startTime)}~${formatTime(task.endTime)} (${diff}m)`;
        } else if(task.startTime) {
            timeStr = `${formatTime(task.startTime)} ~`;
        } else if(task.text && task.text.match(/\d{2}:\d{2}/)) {
             const match = task.text.match(/(\d{2}:\d{2})~(\d{2}:\d{2})/);
             if(match) timeStr = match[0];
        }

        if(timeStr) {
            const timeSpan = document.createElement('button');
            timeSpan.className = 'text-[10px] text-[#A1887F] font-bold mb-0.5 text-left hover:text-[#FF8A65]';
            timeSpan.textContent = timeStr.replace('â° ', ''); 
            timeSpan.onclick = () => openEditTimeModal(type, key, index, task); 
            textGroup.appendChild(timeSpan);
        }
        
        const txt = document.createElement('span');
        txt.className = `text-sm outline-none ${task.done ? 'text-gray-400 line-through' : 'text-[#4E342E]'}`;
        txt.contentEditable = false; 
        
        let displayText = task.text;
        displayText = displayText.replace(/\|?\s*\d{1,2}:\d{2}.*?\d{1,2}:\d{2}\s*\|?/g, '').trim();
        displayText = displayText.replace(/\|?---+\|?/g, '').trim();
        displayText = displayText.replace(/^\|\s*/, '').replace(/\s*\|$/, '');

        txt.textContent = displayText;
        textGroup.appendChild(txt);

        if(task.feedback) {
            const fbDiv = document.createElement('div');
            fbDiv.className = 'text-[11px] text-[#556B2F] mt-1 bg-[#F1F8E9] p-1.5 rounded inline-block';
            fbDiv.innerHTML = `â”” ${task.feedback}`;
            textGroup.appendChild(fbDiv);
        }
        content.appendChild(textGroup);
        const actionGroup = document.createElement('div');
        actionGroup.className = 'flex items-center gap-2 shrink-0 h-6 mt-1';
        
        const editBtn = document.createElement('button');
        editBtn.innerHTML = ICON_EDIT;
        editBtn.onclick = () => openEditTimeModal(type, key, index, task);
        actionGroup.appendChild(editBtn);

        const fbBtn = document.createElement('button');
        fbBtn.innerHTML = ICON_SPEECH;
        fbBtn.onclick = () => openInputModal('í”¼ë“œë°±ì„ ë‚¨ê²¨ì£¼ì„¸ìš”', (val) => {
            if(val) updateTask(type, key, index, {feedback: val});
        });
        actionGroup.appendChild(fbBtn);
        const chk = document.createElement('input');
        chk.type = 'checkbox';
        chk.className = 'custom-checkbox';
        chk.checked = task.done;
        chk.onchange = () => updateTask(type, key, index, {done: chk.checked});
        actionGroup.appendChild(chk);
        content.appendChild(actionGroup);
        li.appendChild(content);
        
        if(type === 'daily') {
             const timerRow = document.createElement('div');
             timerRow.className = 'flex items-center gap-2 mt-2 pl-2';
             if(!task.actualStartTime) {
                const btn = document.createElement('button');
                btn.className = 'font-hand text-sm text-[#A1887F] hover:text-[#FF8A65] border border-[#D7CCC8] px-2 py-0.5 rounded-full bg-white';
                btn.textContent = 'start !';
                btn.onclick = () => updateTask(type, key, index, {actualStartTime: new Date().toISOString()});
                timerRow.appendChild(btn);
             } else if (!task.actualEndTime) {
                const btn = document.createElement('button');
                btn.className = 'font-hand text-sm text-white bg-[#FFAB91] hover:bg-[#FF8A65] px-2 py-0.5 rounded-full';
                btn.textContent = 'stop !';
                btn.onclick = () => updateTask(type, key, index, {actualEndTime: new Date().toISOString()});
                timerRow.appendChild(btn);
             } else {
                 const diff = Math.round((new Date(task.actualEndTime)-new Date(task.actualStartTime))/60000);
                 const tStart = formatTime(task.actualStartTime);
                 const tEnd = formatTime(task.actualEndTime);
                 const recTime = document.createElement('button');
                 recTime.className = 'font-hand text-xs text-[#8D6E63] ml-1 hover:underline';
                 recTime.textContent = `${tStart}~${tEnd} (${diff}m)`;
                 recTime.onclick = () => { if(confirm('ê¸°ë¡ì„ ì´ˆê¸°í™”í• ê¹Œìš”?')) updateTask(type, key, index, {actualStartTime: null, actualEndTime: null}); };
                 timerRow.appendChild(recTime);
             }
             const delBtn = document.createElement('button');
             delBtn.innerHTML = 'âœ•';
             delBtn.className = 'text-[10px] text-[#D7CCC8] hover:text-[#FF8A65] ml-auto mr-1';
             delBtn.onclick = () => { if(confirm('ì‚­ì œí• ê¹Œìš”?')) deleteTaskItem(type, key, index); };
             timerRow.appendChild(delBtn);
             li.appendChild(timerRow);
        } else {
            const delBtn = document.createElement('button');
            delBtn.innerHTML = 'âœ•';
            delBtn.className = 'text-[10px] text-[#D7CCC8] hover:text-[#FF8A65] self-end mr-1 mt-1';
            delBtn.onclick = () => { if(confirm('ì‚­ì œí• ê¹Œìš”?')) deleteTaskItem(type, key, index); };
            li.appendChild(delBtn);
        }
        return li;
    }

    function getTodayStr() { return new Date().toISOString().split('T')[0]; }
    
    function parseTasks(text) { 
        return text.split('\n').map(l=>l.trim()).filter(l=>l.length>0 && !l.startsWith('---')); 
    }

    function getWeekKey(d) {
        const date = new Date(d.getTime());
        date.setHours(0,0,0,0);
        date.setDate(date.getDate() + 3 - (date.getDay() + 6) % 7);
        const week1 = new Date(date.getFullYear(), 0, 4);
        return 1 + Math.round(((date.getTime() - week1.getTime()) / 86400000 - 3 + (week1.getDay() + 6) % 7) / 7) + '';
    }
    function getWeekRangeStr(d) {
        const curr = new Date(d);
        const first = curr.getDate() - curr.getDay();
        const last = first + 6;
        const f = new Date(curr.setDate(first));
        const l = new Date(curr.setDate(last));
        return `${f.getMonth()+1}.${f.getDate()} ~ ${l.getMonth()+1}.${l.getDate()}`;
    }
    function formatTime(iso) {
        const d = new Date(iso);
        return `${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`;
    }
    function changeDate(v) { selectedDate = v; renderApp(); }
    function toggleApiKeyInput() { document.getElementById('apiKeyContainer').classList.toggle('hidden'); }
    function initTimeSelects() {
        const hours = Array.from({length:24}, (_,i) => i.toString().padStart(2,'0'));
        const mins = ['00', '15', '30', '45'];
        ['startHour', 'endHour'].forEach(id => {
            const el = document.getElementById(id);
            if(el) el.innerHTML = '<option value="">--</option>' + hours.map(h => `<option value="${h}">${h}</option>`).join('');
        });
        ['startMin', 'endMin'].forEach(id => {
            const el = document.getElementById(id);
            if(el) el.innerHTML = '<option value="">--</option>' + mins.map(m => `<option value="${m}">${m}</option>`).join('');
        });
    }
    
    // --- Define Async Functions ---
    async function generateSchedule(type) {
        const key = localStorage.getItem(STORAGE_KEY_API);
        if(!key) return alert('API Keyê°€ í•„ìš”í•´ìš”!');
        const promptText = document.getElementById('taskPrompt').value;
        const selectedProjIds = [];
        document.querySelectorAll('input[name="projSelect"]:checked').forEach(cb => selectedProjIds.push(cb.value));
        
        if(!promptText) return alert('ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
        closeModal();
        let sysPrompt = "";
        const todayStr = getTodayStr();
        // Feedback Context
        let feedbackContext = "";
        const sortedDates = Object.keys(window.appData.daily).sort().reverse();
        let pastFeedbacks = [];
        for (let d of sortedDates) {
            if (d < todayStr && pastFeedbacks.length < 5) {
                window.appData.daily[d].forEach(t => {
                    if (t.feedback) pastFeedbacks.push(`[${d}] ${t.feedback}`);
                });
            }
        }
        if (pastFeedbacks.length > 0) feedbackContext = "ìµœê·¼ í”¼ë“œë°± ì°¸ê³ : " + pastFeedbacks.join(", ");
        
        let projCtx = "";
        if(selectedProjIds.length > 0) {
            const projTitles = window.appData.projects.filter(x => selectedProjIds.includes(x.id)).map(x => x.title);
            projCtx = `(ì—°ê´€ í”„ë¡œì íŠ¸: ${projTitles.join(', ')})`;
        }
        
        // í˜„ì¬ ì‹œê°„ êµ¬í•˜ê¸° (HH:MM)
        const now = new Date();
        const currentTimeStr = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;

        if (type === 'daily') {
            // [ìˆ˜ì •] í”„ë¡¬í”„íŠ¸ ê°•í™”: í˜„ì¬ ì‹œê°„ ì´í›„ ì¼ì • ìƒì„±, ê¿€íŒ ì œê³µ, ìê¸°ì†Œê°œ ê¸ˆì§€
            sysPrompt = `
                ì—­í• : íš¨ìœ¨ì ì´ê³  ì‹¤ìš©ì ì¸ í”Œë˜ë„ˆ (MBTI T ì„±í–¥). 
                í˜„ì¬ ì‹œê°: ${todayStr} ${currentTimeStr}.
                ìš”ì²­: "${promptText}" ${projCtx}. 
                
                [í•„ìˆ˜ ê·œì¹™]
                1. ì¸ì‚¬ë§ì´ë‚˜ ìê¸°ì†Œê°œ("ë”°ëœ»í•œ í”Œë˜ë„ˆì…ë‹ˆë‹¤" ë“±) ì ˆëŒ€ ê¸ˆì§€. ë°”ë¡œ ì¼ì •ì´ë‚˜ íŒìœ¼ë¡œ ì‹œì‘í•  ê²ƒ.
                2. í˜„ì¬ ì‹œê°(${currentTimeStr}) ì´í›„ì˜ ì¼ì •ë§Œ ê³„íší•  ê²ƒ. ì´ë¯¸ ì§€ë‚œ ì‹œê°„ì€ í¬í•¨í•˜ì§€ ë§ˆì‹œì˜¤.
                3. ê°ì„±ì ì¸ ì‘ì›ë³´ë‹¤ëŠ” ëª©í‘œ ë‹¬ì„±ì„ ìœ„í•œ ì‹¤ì§ˆì ì´ê³  êµ¬ì²´ì ì¸ 'ê¿€íŒ'ì„ 1~2ë¬¸ì¥ ì œê³µí•  ê²ƒ.
                4. í•  ì¼ í˜•ì‹: 'HH:MM~HH:MM í• ì¼ë‚´ìš©' (í•œ ì¤„ì— í•˜ë‚˜ì”©).
                5. í‘œ(table), êµ¬ë¶„ì„ , ë§ˆí¬ë‹¤ìš´ ë³¼ë“œì²´(**) ì‚¬ìš© ê¸ˆì§€. í…ìŠ¤íŠ¸ë¡œë§Œ ì¶œë ¥.
                ${feedbackContext}
            `;
        } else {
            // [ìˆ˜ì •] Weekly í”„ë¡¬í”„íŠ¸ ê°•í™”
            sysPrompt = `
                ì—­í• : íš¨ìœ¨ì ì¸ ì£¼ê°„ í”Œë˜ë„ˆ.
                ìš”ì²­: "${promptText}" ${projCtx}.
                ê·œì¹™:
                1. ì¸ì‚¬ë§ ìƒëµ.
                2. ì£¼ê°„ ëª©í‘œ ë‹¬ì„±ì„ ìœ„í•œ í•µì‹¬ ì „ëµì´ë‚˜ íŒì„ í•œ ë¬¸ë‹¨ìœ¼ë¡œ ë¨¼ì € ì œì‹œí•  ê²ƒ.
                3. ê·¸ í›„ í•  ì¼ì„ í•œ ì¤„ì— í•˜ë‚˜ì”© ë‚˜ì—´.
            `;
        }

        await callGemini(sysPrompt, (text) => {
            const lines = parseTasks(text);
            const newTasks = [];
            
            lines.forEach(line => {
                // ì‹œê°„ í¬ë§·ì´ ìˆëŠ” ì¤„ì€ í•  ì¼ë¡œ ì²˜ë¦¬
                if (/\d{1,2}:\d{2}/.test(line)) {
                    newTasks.push({ text: line, done: false, isMessage: false });
                } else if (line.length > 5 && !line.includes('|')) {
                    // ì‹œê°„ì´ ì—†ê³  ê¸¸ì´ê°€ ê¸´ ë¬¸ì¥ì€ íŒ/ë©”ì‹œì§€ë¡œ ì²˜ë¦¬
                    newTasks.push({ text: line, done: false, isMessage: true });
                }
            });

            if (type === 'daily') {
                if(!window.appData.daily[selectedDate]) window.appData.daily[selectedDate] = [];
                window.appData.daily[selectedDate].push(...newTasks);
            } else {
                const wk = getWeekKey(new Date());
                if(!window.appData.weekly[wk]) window.appData.weekly[wk] = { tasks: [] };
                // WeeklyëŠ” ë©”ì‹œì§€ êµ¬ë¶„ ì—†ì´ ë‹¤ ë„£ìŒ (ë‹¨ìˆœí™”)
                window.appData.weekly[wk].tasks.push(...newTasks.map(t => ({...t, isMessage: false})));
            }
            saveData();
            renderApp();
        });
    }

    async function generateProjectTasks(pid, ptitle) {
        const key = localStorage.getItem(STORAGE_KEY_API);
        if(!key) return alert('API Keyê°€ í•„ìš”í•´ìš”!');
        await callGemini(`í”„ë¡œì íŠ¸ '${ptitle}' ë‹¨ê³„ë³„ í•  ì¼ 5ê°œ.`, (text) => {
            const lines = parseTasks(text);
            const p = window.appData.projects.find(x => x.id === pid);
            p.tasks.push(...lines.map(t => ({text: t, done: false})));
            saveData();
            renderApp();
        });
    }

    async function runAnalysis() {
        const key = localStorage.getItem(STORAGE_KEY_API);
        if(!key) return alert('API Keyê°€ í•„ìš”í•´ìš”!');
        document.getElementById('analysisLoading').classList.remove('hidden');
        const allTasks = Object.values(window.appData.daily).flat();
        const done = allTasks.filter(t=>t.done).length;
        const feedbacks = allTasks.filter(t=>t.feedback).map(t=>t.feedback).join(", ");
        const sys = `ì™„ë£Œ: ${done}ê°œ. í”¼ë“œë°±: [${feedbacks}]. ì„±ì·¨ íŒ¨í„´ê³¼ ìƒí™œ ìŠµê´€ ë¶„ì„, ë”°ëœ»í•œ ì¡°ì–¸ 3ë¬¸ì¥.`;
        await callGemini(sys, (text) => {
            document.getElementById('analysisLoading').classList.add('hidden');
            const today = new Date().toLocaleDateString('ko-KR');
            if(!window.appData.analysisHistory) window.appData.analysisHistory = [];
            window.appData.analysisHistory.push({ date: today, text: text });
            saveData();
            renderApp(); 
        });
    }

    async function callGemini(prompt, cb) {
        const key = localStorage.getItem(STORAGE_KEY_API);
        try {
            const res = await fetch(`${GEMINI_URL}?key=${key}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }] }],
                    generationConfig: { temperature: 0.7 }
                })
            });
            const data = await res.json();
            if(!res.ok) throw new Error(data.error?.message);
            cb(data.candidates[0].content.parts[0].text);
        } catch(e) {
            console.error(e);
            alert('ì˜¤ë¥˜ ë°œìƒ: ' + e.message);
            document.getElementById('analysisLoading')?.classList.add('hidden');
        }
    }

    function updateTask(type, key, index, changes) {
        let targetArr;
        if(type==='daily') targetArr = window.appData.daily[key];
        else if(type==='weekly') targetArr = window.appData.weekly[key].tasks;
        else targetArr = window.appData.projects.find(p=>p.id===key).tasks;
        Object.assign(targetArr[index], changes);
        saveData();
        renderApp();
    }

    function deleteTaskItem(type, key, index) {
        if(type==='daily') window.appData.daily[key].splice(index,1);
        else if(type==='weekly') window.appData.weekly[key].tasks.splice(index,1);
        else window.appData.projects.find(p=>p.id===key).tasks.splice(index,1);
        saveData();
        renderApp();
    }

    function deleteProject(id) {
        if(confirm('ì´ í”„ë¡œì íŠ¸ë¥¼ ì‚­ì œí• ê¹Œìš”?')) {
            window.appData.projects = window.appData.projects.filter(p=>p.id!==id);
            saveData();
            renderApp();
        }
    }

    function openAddTaskModal(existingData, type) {
        currentTaskTypeForAdd = type || 'daily';
        
        if (existingData) {
            currentTaskTypeForAdd = existingData.type;
        }

        document.getElementById('addTaskModal').classList.remove('hidden');
        document.getElementById('taskModalTitle').innerText = existingData ? 'ìˆ˜ì •' : (currentTaskTypeForAdd === 'weekly' ? 'ì£¼ê°„ í•  ì¼ ì¶”ê°€' : 'í•  ì¼ ì¶”ê°€');
        
        document.getElementById('manualTaskText').value = '';
        ['startHour','startMin','endHour','endMin'].forEach(id => document.getElementById(id).value = '');
        document.getElementById('weeklyTaskDate').value = '';

        if (existingData) {
            editingTask = existingData;
            document.getElementById('manualTaskText').value = existingData.task.text;
            if (existingData.task.specificDate) {
                document.getElementById('weeklyTaskDate').value = existingData.task.specificDate;
            }
        } else {
            editingTask = null;
            document.getElementById('manualTaskText').focus();
        }

        const dailyWrapper = document.getElementById('dailyTimeInputWrapper');
        const weeklyWrapper = document.getElementById('weeklyDateInputWrapper');

        if (currentTaskTypeForAdd === 'weekly') {
            dailyWrapper.classList.add('hidden');
            weeklyWrapper.classList.remove('hidden');
        } else {
            dailyWrapper.classList.remove('hidden');
            weeklyWrapper.classList.add('hidden');
        }
    }
    
    function openEditTimeModal(type, key, index, task) {
        openAddTaskModal({type, key, index, task}, type);
    }

    function closeAddTaskModal() {
        document.getElementById('addTaskModal').classList.add('hidden');
        editingTask = null;
    }
    
    function confirmTaskAction() {
        const text = document.getElementById('manualTaskText').value;
        if (!text) return alert('ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');

        const sh = document.getElementById('startHour').value;
        const sm = document.getElementById('startMin').value;
        const eh = document.getElementById('endHour').value;
        const em = document.getElementById('endMin').value;
        let timeStr = null;
        if(sh && sm && eh && em) timeStr = `${sh}:${sm} ~ ${eh}:${em}`;
        else if(sh && sm) timeStr = `${sh}:${sm} ~`;

        const specificDate = document.getElementById('weeklyTaskDate').value;

        if (editingTask) {
            const changes = { text: text };
            if (currentTaskTypeForAdd === 'weekly') {
                changes.specificDate = specificDate; 
                changes.manualTimeRange = null;      
            } else {
                changes.manualTimeRange = timeStr;   
                changes.specificDate = null;         
            }
            updateTask(editingTask.type, editingTask.key, editingTask.index, changes);
        } else {
            if (currentTaskTypeForAdd === 'weekly') {
                const wk = getWeekKey(new Date());
                if(!window.appData.weekly[wk]) window.appData.weekly[wk] = { tasks: [] };
                window.appData.weekly[wk].tasks.push({
                    text: text, 
                    done: false, 
                    manualTimeRange: null,
                    specificDate: specificDate, 
                    feedback: null,
                    isMessage: false
                });
            } else {
                if(!window.appData.daily[selectedDate]) window.appData.daily[selectedDate] = [];
                window.appData.daily[selectedDate].push({
                    text: text, 
                    done: false, 
                    manualTimeRange: timeStr, 
                    feedback: null,
                    isMessage: false
                });
            }
            saveData();
            renderApp();
        }
        closeAddTaskModal();
    }

    function openInputModal(title, cb) {
        document.getElementById('inputModalTitle').innerText = title;
        document.getElementById('inputModalField').value = '';
        document.getElementById('inputModal').classList.remove('hidden');
        document.getElementById('inputModalField').focus();
        inputCallback = cb;
    }
    function closeInputModal() {
        document.getElementById('inputModal').classList.add('hidden');
        inputCallback = null;
    }
    function confirmInput() {
        const val = document.getElementById('inputModalField').value;
        if(val && inputCallback) {
            inputCallback(val);
            closeInputModal();
        }
    }
    
    function openProjectModal() {
        console.log("Opening Project Modal");
        document.getElementById('projectInputModal').classList.remove('hidden');
        document.getElementById('projTitle').value = '';
        document.getElementById('projDesc').value = ''; 
        document.getElementById('projStart').value = '';
        document.getElementById('projEnd').value = '';
        projCalDate = new Date();
        selectedProjDates = new Set();
        switchProjMode('range');
    }
    
    function closeProjectModal() {
        document.getElementById('projectInputModal').classList.add('hidden');
    }
    function switchProjMode(mode) {
        projMode = mode;
        document.querySelectorAll('.modal-tab').forEach(el => el.classList.remove('active'));
        document.getElementById('pm-'+mode).classList.add('active');
        if(mode === 'range') {
            document.getElementById('projModeRange').classList.remove('hidden');
            document.getElementById('projModeSelect').classList.add('hidden');
        } else {
            document.getElementById('projModeRange').classList.add('hidden');
            document.getElementById('projModeSelect').classList.remove('hidden');
            renderProjCal();
        }
    }
    function renderProjCal() {
        const y = projCalDate.getFullYear();
        const m = projCalDate.getMonth();
        document.getElementById('projCalTitle').innerText = `${y}.${m+1}`;
        const container = document.getElementById('projCalGrid');
        container.innerHTML = '';
        const firstDay = new Date(y, m, 1).getDay();
        const lastDate = new Date(y, m+1, 0).getDate();
        for(let i=0; i<firstDay; i++) container.innerHTML += `<div></div>`;
        for(let d=1; d<=lastDate; d++) {
            const dateStr = `${y}-${(m+1).toString().padStart(2,'0')}-${d.toString().padStart(2,'0')}`;
            const el = document.createElement('div');
            el.className = 'mini-cal-cell';
            if(selectedProjDates.has(dateStr)) el.classList.add('selected');
            el.innerText = d;
            el.onclick = () => {
                if(selectedProjDates.has(dateStr)) selectedProjDates.delete(dateStr);
                else selectedProjDates.add(dateStr);
                renderProjCal();
                document.getElementById('selectedCount').innerText = selectedProjDates.size;
            };
            container.appendChild(el);
        }
    }
    function moveProjCal(d) { projCalDate.setMonth(projCalDate.getMonth() + d); renderProjCal(); }
    
    function confirmCreateProject() {
        const title = document.getElementById('projTitle').value;
        const desc = document.getElementById('projDesc').value; 
        if(!title) return alert('í”„ë¡œì íŠ¸ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
        let dateDisplay = '';
        let type = '';
        if(projMode === 'range') {
            const start = document.getElementById('projStart').value;
            const end = document.getElementById('projEnd').value;
            if(!start || !end) return alert('ê¸°ê°„ì„ ì„¤ì •í•´ì£¼ì„¸ìš”');
            dateDisplay = `${start} ~ ${end}`;
            type = 'range';
        } else {
            if(selectedProjDates.size === 0) return alert('ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”');
            const sorted = Array.from(selectedProjDates).sort();
            dateDisplay = `ì´ ${selectedProjDates.size}ì¼ (${sorted[0]}...)`;
            type = 'select';
        }
        window.appData.projects.push({
            id: Date.now()+'', 
            title: title, 
            desc: desc, 
            dateDisplay: dateDisplay,
            dates: type === 'select' ? Array.from(selectedProjDates).sort() : null,
            tasks:[]
        });
        saveData();
        renderApp();
        closeProjectModal();
    }
    
    function openGeneratorModal() {
        document.getElementById('generatorModal').classList.remove('hidden');
        const container = document.getElementById('projectMultiSelect');
        container.innerHTML = '';
        
        if (window.appData.projects.length === 0) {
            container.innerHTML = '<div class="text-xs text-gray-400 italic text-center p-2">ìƒì„±ëœ í”„ë¡œì íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
        } else {
            window.appData.projects.forEach(p => {
                const label = document.createElement('label');
                label.className = 'flex items-center gap-2 p-1 hover:bg-[#F5F5DC] rounded cursor-pointer';
                label.innerHTML = `
                    <input type="checkbox" name="projSelect" value="${p.id}" class="custom-checkbox w-4 h-4">
                    <span class="text-sm text-[#5D4037]">${p.title}</span>
                `;
                container.appendChild(label);
            });
        }
        document.getElementById('taskPrompt').value = '';
    }
    
    function closeModal() { document.getElementById('generatorModal').classList.add('hidden'); }
    function addManualTask() { openAddTaskModal(null, 'daily'); }

    window.toggleApiKeyInput = toggleApiKeyInput;
    window.handleAuthClick = handleAuthClick;
    window.saveApiKey = saveApiKey;
    window.openGeneratorModal = openGeneratorModal;
    window.closeModal = closeModal;
    window.generateSchedule = generateSchedule;
    window.openAddTaskModal = openAddTaskModal;
    window.closeAddTaskModal = closeAddTaskModal;
    window.confirmTaskAction = confirmTaskAction;
    window.openProjectModal = openProjectModal;
    window.closeProjectModal = closeProjectModal;
    window.switchProjMode = switchProjMode;
    window.confirmCreateProject = confirmCreateProject;
    window.moveProjCal = moveProjCal;
    window.openInputModal = openInputModal;
    window.closeInputModal = closeInputModal;
    window.confirmInput = confirmInput;
    window.switchTab = switchTab;
    window.moveMonth = moveMonth;
    window.runAnalysis = runAnalysis;
    window.generateProjectTasks = generateProjectTasks;
    window.deleteProject = deleteProject;
    window.addManualTask = addManualTask;
    window.changeDate = changeDate; 

    // --- Execution Start ---
    renderHeader();
    initTimeSelects();
    
    if(isFirebaseEnabled) {
        onAuthStateChanged(auth, async (u) => {
            user = u;
            updateAuthUI();
            await loadData(); 
            renderApp();
        });
    } else {
        loadData(); 
        renderApp();
    }

    const savedKey = localStorage.getItem(STORAGE_KEY_API);
    if(savedKey) document.getElementById('apiKeyInput').value = savedKey;

</script>
</body>
</html>
