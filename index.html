<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="zipipo">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üìÖ</text></svg>">
    <link rel="shortcut icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üìÖ</text></svg>">

    <title>zipipo planner</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Gowun+Dodum&family=Kirang+Haerang&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* --- Theme Variables --- */
        :root {
            --bg-ivory: #FDFCF5;
            --wood-frame: #A1887F;
            --wood-text: #5D4037;
            --sage-green: #8FBC8F;
            --point-coral: #FF8A65;
        }
        
        /* Font: S-Core Dream (Light) */
        @font-face {
            font-family: 'S-CoreDream';
            src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_six@1.2/S-CoreDream-3Light.woff') format('woff');
            font-weight: normal;
            font-style: normal;
        }
        
        body, button, input, textarea, select {
            font-family: 'Gowun Dodum', sans-serif !important;
            color: var(--wood-text);
            -webkit-tap-highlight-color: transparent;
        }
        .font-hand { font-family: 'Kirang Haerang', cursive !important; }
        .font-wando { font-family: 'S-CoreDream', sans-serif !important; } 
        
        body { background-color: var(--bg-ivory); }

        /* Sticky Header */
        .sticky-header-wrapper {
            position: sticky;
            top: 0;
            z-index: 40;
            background-color: var(--bg-ivory);
            border-bottom: 1px solid #EFEBE9;
            padding-top: env(safe-area-inset-top);
        }

        /* Timeline - Daily */
        .timeline-container {
            position: relative;
            padding-left: 20px;
            padding-bottom: 10px; 
        }
        .timeline-line {
            position: absolute;
            left: 7px;
            top: 10px; 
            bottom: -10px; 
            width: 2px;
            background-color: var(--wood-text);
            opacity: 0.2;
            border-radius: 2px;
        }
        .timeline-container:last-child .timeline-line { display: none; }
        .timeline-dot {
            position: absolute;
            left: 4px;
            top: 7px;
            width: 8px;
            height: 8px;
            background-color: var(--wood-text);
            border-radius: 50%;
            z-index: 2;
        }

        /* Timeline - Weekly */
        .weekly-item .timeline-line { display: none !important; }
        .weekly-item .timeline-dot {
            width: 5px;
            height: 5px;
            left: 6px;
            top: 9px;
            background-color: var(--sage-green);
        }
        .weekly-item.timeline-container { padding-left: 18px; }
        
        .empty-state {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem 0;
            text-align: center;
            width: 100%;
        }

        .wood-frame {
            border: 2px solid var(--wood-frame);
            border-radius: 16px;
            background: white;
        }

        /* Tabs */
        .tab-btn {
            font-family: 'Kirang Haerang', cursive !important;
            font-size: 1.3rem;
            color: #D7CCC8;
            transition: color 0.2s;
        }
        .tab-active {
            color: var(--wood-text);
            position: relative;
        }
        .tab-active::after {
            content: '';
            position: absolute;
            bottom: 2px;
            left: 50%;
            transform: translateX(-50%);
            width: 6px;
            height: 6px;
            background-color: var(--point-coral);
            border-radius: 50%;
        }

        /* Checkbox */
        .custom-checkbox {
            appearance: none;
            width: 18px;
            height: 18px;
            border: 2px solid #BCAAA4;
            border-radius: 5px;
            cursor: pointer;
            position: relative;
            background-color: #fff;
            transition: all 0.2s;
            flex-shrink: 0;
        }
        .custom-checkbox:checked {
            background-color: var(--sage-green);
            border-color: var(--sage-green);
        }
       .custom-checkbox:checked::after {
            content: '';
            display: none;
        }

        /* FAB */
        .fab-house {
            background-color: #A5D6A7;
            clip-path: polygon(50% 0%, 100% 35%, 100% 100%, 0% 100%, 0% 35%);
            display: flex;
            align-items: flex-end;
            justify-content: center;
            padding-bottom: 8px;
        }
        
        /* Modals & Animations */
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .modal-content { animation: slideUp 0.3s ease-out; }
        
        /* Time Select & Mini Cal */
        .time-select {
            border: 1px solid #EFEBE9;
            border-radius: 8px;
            padding: 4px;
            font-size: 0.8rem;
            color: var(--wood-text);
            background-color: white;
            outline: none;
        }
        .mini-cal-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            text-align: center;
            font-size: 0.8rem;
        }
        .mini-cal-cell {
            padding: 6px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s;
        }
        .mini-cal-cell.selected {
            background-color: var(--sage-green);
            color: white;
            font-weight: bold;
        }
        .modal-tab {
            padding: 8px;
            font-size: 0.9rem;
            color: #BCAAA4;
            border-bottom: 2px solid transparent;
            cursor: pointer;
        }
        .modal-tab.active {
            color: var(--wood-text);
            border-bottom: 2px solid var(--point-coral);
            font-weight: bold;
        }

        /* Task Styles */
        .task-time-label {
            font-size: 0.7rem;
            color: #BCAAA4;
            margin-bottom: -2px;
            display: block;
        }
        .task-sub-text {
            font-size: 0.75rem;
            color: #8D6E63;
            margin-top: 2px;
            display: block;
            margin-left: 26px; 
        }
        
        /* Project Specifics */
        .proj-date-header {
            font-size: 0.8rem;
            font-weight: bold;
            color: #556B2F;
            background-color: #F1F8E9;
            padding: 4px 10px;
            border-radius: 8px;
            display: inline-block;
            margin-bottom: 6px;
            margin-top: 12px;
            border: 1px solid #DCEDC8;
        }
        .proj-tip-box {
            background-color: #FFF8E1;
            border: 1px solid #FFE0B2;
            border-radius: 12px;
            padding: 10px;
            margin-top: 10px; 
            margin-bottom: 12px;
            font-size: 0.8rem;
            color: #E65100;
            line-height: 1.5;
        }
        .proj-tip-label {
            font-weight: bold;
            font-size: 0.7rem;
            color: #FFB74D;
            display: block;
            margin-bottom: 2px;
        }
        .task-depth-1 { margin-left: 1rem; }
        .task-depth-2 { margin-left: 2rem; }
        .proj-msg-box {
            font-size: 0.8rem;
            color: #795548;
            background-color: #EFEBE9;
            padding: 6px 10px;
            border-radius: 8px;
            margin-bottom: 4px;
            font-weight: bold;
        }
        .proj-memo-area {
            width: 100%;
            background-color: #FDFCF5;
            border: 1px solid #D7CCC8;
            border-radius: 12px;
            padding: 10px;
            font-size: 0.8rem;
            color: #5D4037;
            resize: none;
            margin-top: 10px;
            outline: none;
            transition: border-color 0.2s;
        }
        .proj-memo-area:focus {
            border-color: #8D6E63;
        }
    </style>
</head>
<body class="max-w-md mx-auto min-h-screen flex flex-col pb-28 relative bg-[#FDFCF5]">

    <div class="sticky-header-wrapper">
        <header class="px-6 pt-8 pb-2 flex justify-between items-center bg-[#FDFCF5]">
            <div class="flex items-center gap-2">
                <svg class="w-8 h-8 text-[#8D6E63]" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
                </svg>
                <h1 class="font-hand text-4xl text-[#5D4037] pt-1">zipipo planner</h1>
            </div>
            <div id="headerDate" class="font-hand text-lg text-[#A1887F]"></div>
        </header>

        <nav class="flex justify-around bg-[#FDFCF5] pb-2 border-b border-[#EFEBE9]">
            <button onclick="switchTab('home')" id="tab-home" class="flex-1 py-2 tab-btn tab-active">Home</button>
            <button onclick="switchTab('project')" id="tab-project" class="flex-1 py-2 tab-btn">Project</button>
            <button onclick="switchTab('achievement')" id="tab-achievement" class="flex-1 py-2 tab-btn">Achievement</button>
        </nav>
    </div>

    <main id="appContent" class="p-5 flex-1 space-y-6 overflow-y-auto"></main>

    <div id="saveToast" class="fixed bottom-24 left-1/2 transform -translate-x-1/2 bg-[#5D4037] text-white text-xs px-4 py-2 rounded-full shadow-none opacity-0 transition-opacity duration-300 pointer-events-none z-50 bg-opacity-90 backdrop-blur-sm">
        Ï†ÄÏû•Îê®
    </div>

    <div id="aiLoadingPopup" class="fixed inset-0 bg-black/10 z-[70] hidden flex items-center justify-center backdrop-blur-[1px]">
        <div class="bg-white px-8 py-6 rounded-3xl shadow-lg border-2 border-[#EFEBE9] w-[280px] mx-4 text-center">
            <div class="text-[#5D4037] font-hand text-xl mb-1 whitespace-nowrap">
                zipipoÍ∞Ä ÎßåÎì§Í≥† ÏûàÏñ¥Ïöî<span id="loadingDots" class="inline-block w-6 text-left"></span>
            </div>
            <div class="text-[10px] text-[#A1887F]">Ïû†ÏãúÎßå Í∏∞Îã§Î†§Ï£ºÏÑ∏Ïöî</div>
        </div>
    </div>

    <footer id="homeFooter" class="mt-auto py-8 text-center">
        <div class="flex justify-center gap-4 text-xs text-[#BCAAA4]">
            <button onclick="toggleApiKeyInput()" class="hover:text-[#8D6E63] font-hand text-lg flex items-center gap-1">
                <svg class="w-4 h-4 text-[#D7CCC8]" fill="currentColor" viewBox="0 0 24 24"><path d="M12.65 10C11.83 7.67 9.61 6 7 6c-3.31 0-6 2.69-6 6s2.69 6 6 6c2.61 0 4.83-1.67 5.65-4H17v4h4v-4h2v-4H12.65zM7 14c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z"/></svg>
                Key Setting
            </button>
        </div>
        <div id="apiKeyContainer" class="hidden mt-3 mx-8 p-4 bg-white border-2 border-[#EFEBE9] rounded-2xl">
            <input type="password" id="apiKeyInput" placeholder="API KeyÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî" 
                   class="w-full p-2 border-b border-[#D7CCC8] mb-3 text-sm bg-transparent focus:outline-none focus:border-[#8D6E63] text-center text-[#5D4037]">
            <button onclick="saveApiKey()" class="w-full bg-[#D7CCC8] text-white text-sm py-2 rounded-lg font-bold hover:bg-[#BCAAA4]">Ï†ÄÏû•ÌïòÍ∏∞</button>
        </div>
    </footer>

    <div class="fixed bottom-8 right-6 z-30">
        <button onclick="openGeneratorModal('new')" class="w-14 h-14 fab-house text-white hover:scale-105 transition active:scale-95 shadow-sm">
            <span class="text-2xl font-bold font-hand">+</span>
        </button>
    </div>

    <div id="generatorModal" class="fixed inset-0 bg-[#4E342E]/20 z-50 hidden flex items-end sm:items-center justify-center backdrop-blur-[1px]">
        <div class="bg-[#FDFCF5] w-full max-w-md p-6 rounded-t-3xl sm:rounded-3xl shadow-none border-2 border-[#EFEBE9] m-0 sm:m-4 wood-frame modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-hand text-2xl text-[#8D6E63]">ÏùºÏ†ï ÏßìÍ∏∞</h3>
                <button onclick="closeModal('generatorModal')" class="text-[#BCAAA4] hover:text-[#8D6E63] text-xl">‚úï</button>
            </div>
            <textarea id="taskPrompt" rows="3" class="w-full p-4 border-2 border-[#EFEBE9] rounded-xl mb-4 resize-none focus:outline-none focus:border-[#D7CCC8] bg-white text-sm placeholder-gray-300" placeholder="Ïòà: Í≥µÎ∂Ä 2ÏãúÍ∞Ñ ÌïòÍ≥† ÏÇ∞Ï±ÖÌïòÍ∏∞"></textarea>
            <div class="flex gap-3 mb-3">
                <button onclick="generateSchedule('daily')" class="flex-1 py-3 bg-[#FFAB91] text-white font-bold rounded-xl hover:bg-[#FF8A65] transition shadow-sm text-sm">Daily</button>
                <button onclick="generateSchedule('weekly')" class="flex-1 py-3 bg-[#A5D6A7] text-white font-bold rounded-xl hover:bg-[#81C784] transition shadow-sm text-sm">Weekly</button>
            </div>
        </div>
    </div>

    <div id="routineModal" class="fixed inset-0 bg-[#4E342E]/20 z-50 hidden flex items-center justify-center backdrop-blur-[1px]">
        <div class="bg-[#FDFCF5] w-full max-w-md p-6 rounded-2xl shadow-none border-2 border-[#EFEBE9] m-4 wood-frame modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-hand text-xl text-[#8D6E63]">Î£®Ìã¥ Í¥ÄÎ¶¨</h3>
                <button onclick="closeModal('routineModal')" class="text-[#BCAAA4] hover:text-[#8D6E63] text-xl">‚úï</button>
            </div>
            <div class="flex gap-2 mb-4">
                <input type="text" id="newRoutineInput" class="flex-1 border-b-2 border-[#D7CCC8] p-1 text-sm focus:outline-none bg-transparent" placeholder="ÏÉà Î£®Ìã¥ (Ïòà: üßò Ïä§Ìä∏Î†àÏπ≠)">
                <button onclick="addRoutine()" class="bg-[#D7CCC8] text-white px-3 py-1 rounded-lg text-xs font-bold hover:bg-[#A1887F]">+</button>
            </div>
            <div id="routineList" class="max-h-60 overflow-y-auto space-y-2">
            </div>
        </div>
    </div>

    <div id="projectPlanModal" class="fixed inset-0 bg-[#4E342E]/20 z-50 hidden flex items-center justify-center backdrop-blur-[1px]">
        <div class="bg-[#FDFCF5] w-full max-w-md p-6 rounded-2xl shadow-none border-2 border-[#EFEBE9] m-4 wood-frame modal-content">
            <h3 class="font-hand text-xl text-[#8D6E63] mb-2">ÌîÑÎ°úÏ†ùÌä∏ Í≥ÑÌöç ÏßúÍ∏∞</h3>
            <p class="text-xs text-[#A1887F] mb-4">Íµ¨Ï≤¥Ï†ÅÏù∏ Ïã§Ìñâ Í≥ÑÌöçÏùÑ ÏöîÏ≤≠ÌïòÏÑ∏Ïöî.</p>
            <textarea id="projectPlanPrompt" rows="6" class="w-full p-4 border-2 border-[#EFEBE9] rounded-xl mb-4 resize-none focus:outline-none focus:border-[#D7CCC8] bg-white text-sm text-[#5D4037] leading-relaxed"></textarea>
            <div class="flex gap-3">
                <button onclick="closeModal('projectPlanModal')" class="flex-1 py-3 bg-gray-100 text-[#8D6E63] rounded-xl text-xs hover:bg-gray-200">Ï∑®ÏÜå</button>
                <button onclick="confirmProjectPlan()" class="flex-1 py-3 bg-[#8D6E63] text-white rounded-xl text-xs font-bold hover:bg-[#6D4C41]">Í≥ÑÌöç ÏÉùÏÑ±ÌïòÍ∏∞</button>
            </div>
        </div>
    </div>

    <div id="addTaskModal" class="fixed inset-0 bg-black/20 z-[60] hidden flex items-center justify-center backdrop-blur-[1px]">
        <div class="bg-white p-6 rounded-2xl shadow-lg w-80 wood-frame modal-content text-center">
            <h3 id="taskModalTitle" class="font-hand text-xl text-[#8D6E63] mb-4">Ìï† Ïùº Ï∂îÍ∞Ä</h3>
            <input type="text" id="manualTaskText" class="w-full border-b-2 border-[#D7CCC8] p-2 mb-4 focus:outline-none text-center text-sm" placeholder="Ìï† Ïùº ÎÇ¥Ïö©">
            <div id="dailyTimeInputWrapper" class="flex flex-col gap-3 mb-5">
                <div class="flex items-center justify-center gap-2">
                    <span class="text-xs text-[#A1887F] w-8">ÏãúÏûë</span>
                    <select id="startHour" class="time-select"></select> : <select id="startMin" class="time-select"></select>
                </div>
                <div class="flex items-center justify-center gap-2">
                    <span class="text-xs text-[#A1887F] w-8">Ï¢ÖÎ£å</span>
                    <select id="endHour" class="time-select"></select> : <select id="endMin" class="time-select"></select>
                </div>
            </div>
            <div id="weeklyDateInputWrapper" class="hidden mb-5">
                <label class="text-xs text-[#A1887F] block mb-2">ÏàòÌñâÌï† ÎÇ†Ïßú (ÏÑ†ÌÉù)</label>
                <input type="date" id="weeklyTaskDate" class="border border-[#EFEBE9] rounded p-2 text-sm text-[#5D4037] w-full bg-white">
            </div>
            <div class="flex gap-2 justify-center items-center relative w-full">
                <button id="modalDeleteBtn" onclick="deleteTaskFromModal()" class="absolute left-0 text-[#FF8A65] text-xs font-bold px-2 py-2 hover:bg-red-50 rounded hidden">
                    ÏÇ≠Ï†ú
                </button>
                
                <button onclick="closeModal('addTaskModal')" class="px-4 py-2 bg-gray-100 rounded-lg text-xs text-gray-500 hover:bg-gray-200">Ï∑®ÏÜå</button>
                <button onclick="confirmTaskAction()" class="px-4 py-2 bg-[#8D6E63] text-white rounded-lg text-xs font-bold hover:bg-[#6D4C41]">ÌôïÏù∏</button>
            </div>
        </div>
    </div>

    <div id="projectInputModal" class="fixed inset-0 bg-black/20 z-[60] hidden flex items-center justify-center backdrop-blur-[1px]">
        <div class="bg-white p-6 rounded-2xl shadow-lg w-80 wood-frame modal-content">
            <h3 class="font-hand text-xl text-[#8D6E63] mb-4 text-center">ÏÉà ÌîÑÎ°úÏ†ùÌä∏ Ïã¨Í∏∞</h3>
            <label class="text-xs text-[#A1887F] mb-1 block">ÌîÑÎ°úÏ†ùÌä∏ Ïù¥Î¶Ñ</label>
            <input type="text" id="projTitle" class="w-full border-b-2 border-[#D7CCC8] p-2 mb-3 focus:outline-none text-center text-sm" placeholder="">
            <label class="text-xs text-[#A1887F] mb-1 block">ÎÇ¥Ïö©</label>
            <textarea id="projDesc" class="w-full border-2 border-[#EFEBE9] rounded-xl p-2 mb-3 text-sm focus:outline-none focus:border-[#D7CCC8] resize-none" rows="2"></textarea>
            <div class="flex border-b border-[#EFEBE9] mb-3">
                <div onclick="switchProjMode('range')" id="pm-range" class="flex-1 text-center modal-tab active">Í∏∞Í∞Ñ ÏßÄÏ†ï</div>
                <div onclick="switchProjMode('select')" id="pm-select" class="flex-1 text-center modal-tab">ÎÇ†Ïßú ÏÑ†ÌÉù</div>
            </div>
            <div id="projModeRange">
                <div class="flex gap-2 mb-2">
                    <div class="flex-1">
                        <label class="text-xs text-[#A1887F] mb-1 block">ÏãúÏûëÏùº</label>
                        <input type="date" id="projStart" class="w-full border border-[#EFEBE9] rounded p-1 text-xs text-[#5D4037]">
                    </div>
                    <div class="flex-1">
                        <label class="text-xs text-[#A1887F] mb-1 block">Ï¢ÖÎ£åÏùº</label>
                        <input type="date" id="projEnd" class="w-full border border-[#EFEBE9] rounded p-1 text-xs text-[#5D4037]">
                    </div>
                </div>
            </div>
            <div id="projModeSelect" class="hidden">
                <div class="flex justify-between items-center mb-2 px-2">
                    <button onclick="moveProjCal(-1)" class="text-[#8D6E63]">‚óÄ</button>
                    <span id="projCalTitle" class="text-xs font-bold text-[#5D4037]"></span>
                    <button onclick="moveProjCal(1)" class="text-[#8D6E63]">‚ñ∂</button>
                </div>
                <div class="mini-cal-grid mb-1" id="projCalGrid"></div>
                <div class="text-[10px] text-right text-[#8D6E63]"><span id="selectedCount">0</span>Ïùº ÏÑ†ÌÉùÎê®</div>
            </div>
            
            <div class="flex gap-2 justify-center mt-3">
                <button onclick="closeModal('projectInputModal')" class="px-4 py-2 bg-gray-100 rounded-lg text-xs text-gray-500 hover:bg-gray-200">Ï∑®ÏÜå</button>
                <button onclick="confirmCreateProject()" class="px-4 py-2 bg-[#556B2F] text-white rounded-lg text-xs font-bold hover:bg-[#33691E]">Ïã¨Í∏∞</button>
            </div>
        </div>
    </div>

    <div id="inputModal" class="fixed inset-0 bg-black/20 z-[60] hidden flex items-center justify-center backdrop-blur-[1px]">
        <div class="bg-white p-5 rounded-2xl shadow-lg w-80 wood-frame modal-content text-center">
            <h3 id="inputModalTitle" class="font-hand text-xl text-[#8D6E63] mb-3">ÏûÖÎ†•</h3>
            <textarea id="inputModalField" rows="3" class="w-full border-2 border-[#EFEBE9] rounded-xl p-2 mb-4 focus:outline-none focus:border-[#D7CCC8] text-center resize-none bg-transparent" placeholder="ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî"></textarea>
            <div class="flex gap-2 justify-center">
                <button onclick="closeModal('inputModal')" class="px-4 py-2 bg-gray-200 rounded-lg text-xs text-gray-500">Ï∑®ÏÜå</button>
                <button onclick="confirmInput()" class="px-4 py-2 bg-[#8D6E63] text-white rounded-lg text-xs font-bold">ÌôïÏù∏</button>
            </div>
        </div>
    </div>

<script>
    // 1. CONSTANTS
    const STORAGE_KEY_API = 'zipipo_v2_apikey';
    const STORAGE_KEY_DATA = 'zipipo_v2_data'; 
    const GEMINI_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent';
    
    const ICONS = {
        check: `<svg class="w-4 h-4 text-[#8D6E63] hover:text-[#5D4037]" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"></path></svg>`,
        undo: `<svg class="w-4 h-4 text-[#8D6E63] hover:text-[#5D4037]" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"></path></svg>`,
        closeX: `<svg class="w-4 h-4 text-[#D7CCC8] hover:text-[#FF7F50]" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path></svg>`,
        speech: `<svg class="w-4 h-4 text-[#BCAAA4] hover:text-[#8D6E63] transition" fill="currentColor" viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/></svg>`,
        edit: `<svg class="w-3 h-3 text-[#BCAAA4] hover:text-[#8D6E63]" fill="currentColor" viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>`,
        refresh: `<svg class="w-3 h-3" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>`
    };
    // 2. STATE
    let appData = { daily: {}, weekly: {}, projects: [], dailySummaries: {}, dailyPrompts: {}, weeklyPrompts: {}, routines: [] };
    let currentTab = 'home';
    let selectedDate = new Date().toISOString().split('T')[0];
    let lastKnownToday = new Date().toISOString().split('T')[0]; 
    let currentWeekBaseDate = new Date();
    let achievementViewDate = new Date().toISOString().split('T')[0];
    let inputCallback = null;
    let editingTask = null;
    // [ÏàòÏ†ï] ÏàòÏ†ï Ïª®ÌÖçÏä§Ìä∏ Ï†ÄÏû• Î≥ÄÏàò Ï∂îÍ∞Ä
    let currentEditContext = null; 

    let activeProjectId = null;
    let projCalDate = new Date();
    let selectedProjDates = new Set();
    let projMode = 'range';
    let currentTaskTypeForAdd = 'daily'; 
    let loadingInterval;
    let calendarDate = new Date();
    
    // To maintain scroll position in projects
    let lastProjectScrollTop = 0; 

    // 3. HELPER FUNCTIONS
    function getLocalDateStr(d) {
        return `${d.getFullYear()}-${(d.getMonth()+1).toString().padStart(2,'0')}-${d.getDate().toString().padStart(2,'0')}`;
    }
    function formatTimeSimple(iso) {
        const d = new Date(iso);
        return `${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`;
    }
    function cleanMarkdown(text) {
        if (!text) return "";
        return text.replace(/\*\*/g, '').replace(/\*/g, '').replace(/###/g, '').replace(/##/g, '').replace(/#/g, '').replace(/-/g, '').trim();
    }
    function getTodayStr() {
        return getLocalDateStr(new Date());
    }
    function parseTasks(text) {
        return text.split('\n').map(l=>l).filter(l=>l.trim().length>0 && !l.trim().startsWith('---'));
    }
    function getWeekKey(d) {
        const date = new Date(d);
        const diff = date.getDate() - date.getDay(); 
        const sunday = new Date(date.setDate(diff));
        return getLocalDateStr(sunday);
    }
    function getWeekRangeStr(d) {
        const curr = new Date(d); 
        const day = curr.getDay(); 
        // Sunday (Start)
        const first = new Date(curr);
        first.setDate(curr.getDate() - day);
        // Saturday (End)
        const last = new Date(first);
        last.setDate(first.getDate() + 6);
        return `${getLocalDateStr(first)} ~ ${getLocalDateStr(last)}`;
    }
    function getTaskTimeVal(task) {
        const match = task.text.match(/^(\d{1,2}):(\d{2})/);
        if(match) return parseInt(match[1])*60 + parseInt(match[2]);
        return 9999; 
    }
    function showLoading(msg) {
        document.getElementById('aiLoadingPopup').classList.remove('hidden');
        document.querySelector('#aiLoadingPopup .font-hand').firstChild.textContent = msg;
        let dots = '';
        const el = document.getElementById('loadingDots');
        loadingInterval = setInterval(() => {
            dots += '.';
            if(dots.length > 3) dots = '';
            el.innerText = dots;
        }, 500);
    }
    function hideLoading() {
        clearInterval(loadingInterval);
        document.getElementById('aiLoadingPopup').classList.add('hidden');
    }
    function closeModal(id) {
        document.getElementById(id).classList.add('hidden');
        if(id === 'addTaskModal') {
            editingTask = null;
            currentEditContext = null; // Ï¥àÍ∏∞Ìôî
        }
    }
    function toggleApiKeyInput() {
        const c = document.getElementById('apiKeyContainer');
        c.classList.toggle('hidden');
    }
    
    // 4. STORAGE
    function loadData() {
        const raw = localStorage.getItem(STORAGE_KEY_DATA);
        if(raw) {
            appData = JSON.parse(raw);
        }
        if (!appData.daily) appData.daily = {};
        if (!appData.weekly) appData.weekly = {};
        if (!appData.projects) appData.projects = [];
        if (!appData.dailySummaries) appData.dailySummaries = {};
        if (!appData.dailyPrompts) appData.dailyPrompts = {};
        if (!appData.weeklyPrompts) appData.weeklyPrompts = {};
        if (!appData.routines) appData.routines = [];
    }
    function saveData() {
        localStorage.setItem(STORAGE_KEY_DATA, JSON.stringify(appData));
        const toast = document.getElementById('saveToast');
        if(toast) {
            toast.style.opacity = '1';
            setTimeout(() => { toast.style.opacity = '0'; }, 2000);
        }
    }
    function saveApiKey() {
        const key = document.getElementById('apiKeyInput').value;
        if(key) {
            localStorage.setItem(STORAGE_KEY_API, key);
            alert('Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§');
            toggleApiKeyInput();
        }
    }

    // 5. API INTERACTION
    async function callGemini(sysPrompt, cb) {
        const key = localStorage.getItem(STORAGE_KEY_API);
        if (!key) {
            alert("API KeyÍ∞Ä ÏóÜÏäµÎãàÎã§. ÌïòÎã® Key SettingÏóêÏÑú ÌÇ§Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.");
            hideLoading();
            return;
        }
        try {
            const res = await fetch(`${GEMINI_URL}?key=${key}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    contents: [{ parts: [{ text: sysPrompt }] }]
                })
            });
            const data = await res.json();
            if(data.candidates && data.candidates[0].content) {
                cb(data.candidates[0].content.parts[0].text);
            } else {
                console.error("Gemini Error:", data);
                alert("Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.");
                hideLoading();
            }
        } catch(e) {
            console.error(e);
            alert("ÌÜµÏã† Ïò§Î•ò");
            hideLoading();
        }
    }

    async function generateSchedule(mode) {
        const promptText = document.getElementById('taskPrompt').value;
        if(!promptText) return alert('ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
        
        closeModal('generatorModal');
        showLoading("zipipoÍ∞Ä ÏùºÏ†ïÏùÑ ÏßìÍ≥† ÏûàÏñ¥Ïöî");

        let sysPrompt = "";
        
        // [ÏàòÏ†ï] Î≥¥Ï°¥Ìï† ÏùºÏ†ï Î≥ÄÏàò ÏÑ†Ïñ∏
        let preservedTasks = [];
        let preservedContext = "";

        if (mode === 'daily') {
            appData.dailyPrompts[selectedDate] = promptText;
            
            // [ÏàòÏ†ï] Í∏∞Ï°¥ ÏôÑÎ£å Ìï≠Î™© ÎòêÎäî ÌîºÎìúÎ∞± ÏûàÎäî Ìï≠Î™© Î≥¥Ï°¥ Î°úÏßÅ
            const currentTasks = appData.daily[selectedDate] || [];
            preservedTasks = currentTasks.filter(t => t.done || (t.feedback && t.feedback.trim()));
            
            if (preservedTasks.length > 0) {
                const listStr = preservedTasks.map(t => `- ${t.text} (${t.done ? 'ÏôÑÎ£å' : 'ÏßÑÌñâÏ§ë'})`).join('\n');
                preservedContext = `\n[ÌòÑÏû¨ ÏÉÅÌô©]\nÏù¥ÎØ∏ Ï≤òÎ¶¨ÎêòÏóàÍ±∞ÎÇò Ïú†ÏßÄÌï¥Ïïº Ìï† ÏùºÏ†ïÏù¥ ÏûàÏäµÎãàÎã§:\n${listStr}\n\nÏúÑ ÏùºÏ†ïÎì§ÏùÄ Í∑∏ÎåÄÎ°ú Îëò Í≤ÉÏù¥Îãà, Ïù¥Î•º Í≥†Î†§ÌïòÏó¨(Ï§ëÎ≥µÎêòÏßÄ ÏïäÍ≤å) ÎÇòÎ®∏ÏßÄ ÏãúÍ∞ÑÎåÄÏùò ÏùºÏ†ïÏùÑ Í≥ÑÌöçÌï¥Ï£ºÏÑ∏Ïöî.`;
            }

            const routines = appData.routines.map(r => r.text).join(', ');
            let contextInfo = `[Î£®Ìã¥] ${routines}\n`;
            
            // Ïñ¥Ï†ú ÌöåÍ≥†
            const yest = new Date(selectedDate);
            yest.setDate(yest.getDate()-1);
            const yestStr = getLocalDateStr(yest);
            if(appData.dailySummaries[yestStr]) {
                contextInfo += `[Ïñ¥Ï†ú ÌöåÍ≥†] ${appData.dailySummaries[yestStr]}\n`;
            }

            const today = new Date();
            const isToday = selectedDate === getLocalDateStr(today);
            let timeConstraint = "";
            if(isToday) {
                const nowHour = today.getHours();
                timeConstraint = `2. ÌòÑÏû¨ ÏãúÍ∞ÅÏùÄ ${nowHour}ÏãúÏûÖÎãàÎã§. ÏßÄÎÇòÍ∞Ñ ÏãúÍ∞ÑÏùò ÏùºÏ†ïÏùÄ Ïû°ÏßÄ ÎßêÍ≥†, ÎÇ®ÏùÄ ÏãúÍ∞Ñ ÏúÑÏ£ºÎ°ú Í≥ÑÌöçÌïòÏÑ∏Ïöî.`;
            } else {
                timeConstraint = `2. ÌïòÎ£® Ï†ÑÏ≤¥ ÏùºÏ†ïÏùÑ Í≥ÑÌöçÌï† Í≤É.`;
            }

            // [ÏàòÏ†ï] ÌîÑÎ°¨ÌîÑÌä∏Ïóê preservedContext Ï∂îÍ∞Ä
            sysPrompt = `Ïó≠Ìï†: ÌîåÎûòÎÑà (MBTI T). ÎÇ†Ïßú: ${selectedDate}. ÏöîÏ≤≠: "${promptText}".
${contextInfo}
${preservedContext}
[Í∑úÏπô] 1. Ïù∏ÏÇ¨Îßê Í∏àÏßÄ. ${timeConstraint} 3. ÍøÄÌåÅ 1~2Î¨∏Ïû•. 4. ÌòïÏãù: 'HH:MM~HH:MM Ìï†Ïùº'. 5. ÎßàÌÅ¨Îã§Ïö¥ Í∏àÏßÄ.`;
            
        } else {
            const wk = getWeekKey(currentWeekBaseDate);
            appData.weeklyPrompts[wk] = promptText;
            const weekRangeStr = getWeekRangeStr(currentWeekBaseDate);
            
            sysPrompt = `Ïó≠Ìï†: Ï£ºÍ∞Ñ ÌîåÎûòÎÑà. Í∏∞Í∞Ñ: ${weekRangeStr}. ÏöîÏ≤≠: "${promptText}".
[Í∑úÏπô] 1. ÏÇ¨Ïö©ÏûêÏùò ÏöîÏ≤≠ ÎÇ¥Ïö©ÏùÑ Î∞îÌÉïÏúºÎ°ú, ÏùºÏ£ºÏùº Ïπò Í∑†Ìòï Ïû°Ìûå Í≥ÑÌöçÏùÑ ÏÑ∏ÏõåÏ£ºÏÑ∏Ïöî.
2. ÏöîÏ≤≠Ìïú ÏùºÏ†ïÏùÑ Îã®ÏàúÌûà ÎÇòÏó¥ÌïòÏßÄ ÎßêÍ≥†, Í¥ÄÎ†®Îêú Ï∂îÏ≤ú ÌôúÎèôÏù¥ÎÇò ÌïòÏúÑ Ìï≠Î™©ÏùÑ Ï∂îÍ∞ÄÌïòÏó¨ ÌíçÏÑ±ÌïòÍ≤å Ï±ÑÏõåÏ£ºÏÑ∏Ïöî.
(Ïòà: 'Ïö¥Îèô' -> 'Ïö¥Îèô', 'Îã®Î∞±Ïßà ÏÑ≠Ï∑®', 'Ïä§Ìä∏Î†àÏπ≠') 3. Ïù∏ÏÇ¨ÎßêÏù¥ÎÇò ÏÑúÎ°† ÏóÜÏù¥ Î∞îÎ°ú ÏùºÏ†ïÎßå Ï∂úÎ†•ÌïòÏÑ∏Ïöî.
4. ÌòïÏãù: 'YYYY-MM-DD: Ìï†Ïùº' (Ìïú Ï§ÑÏóê ÌïòÎÇòÏî©) 5. ÏúÑ Í∏∞Í∞Ñ(${weekRangeStr}) ÎÇ¥Ïùò ÎÇ†ÏßúÎ°úÎßå ÏÉùÏÑ±ÌïòÏÑ∏Ïöî.`;
        }

        await callGemini(sysPrompt, (text) => {
            const lines = parseTasks(text);
            const newTasks = [];
            
            lines.forEach(line => {
                const trimLine = line.trim();
                if (/\d{1,2}:\d{2}/.test(trimLine)) {
                     newTasks.push({ text: trimLine, done: false });
                } else if (/^\d{4}-\d{2}-\d{2}:/.test(trimLine)) {
                    // Weekly
                     const parts = trimLine.split(':');
                     const d = parts[0].trim();
                     const t = parts.slice(1).join(':').trim();
                     if(d && t) newTasks.push({ text: t, done: false, date: d });
                } else if(trimLine.length > 5) {
                    // Maybe Tip or plain text
                    newTasks.push({ text: trimLine, done: false, isTip: true });
                }
            });

            if (mode === 'daily') {
                // [ÏàòÏ†ï] Î≥ëÌï© Î°úÏßÅ
                if (preservedTasks.length > 0) {
                    // Í∏∞Ï°¥ Î≥¥Ï°¥ Ìï≠Î™© + AIÍ∞Ä ÏÉàÎ°ú Ïß† Ìï≠Î™© (ÏãúÍ∞ÑÏàú Ï†ïÎ†¨ÏùÄ Î†åÎçîÎßÅ Ïãú Ï≤òÎ¶¨Îê®)
                    appData.daily[selectedDate] = [...preservedTasks, ...newTasks];
                } else {
                    if ((appData.daily[selectedDate] || []).length > 0 && !confirm('Í∏∞Ï°¥ ÏùºÏ†ïÏùÑ Î™®Îëê ÏßÄÏö∞Í≥† ÎçÆÏñ¥ÏîåÏö∏ÍπåÏöî?')) {
                        appData.daily[selectedDate].push(...newTasks);
                    } else {
                        appData.daily[selectedDate] = newTasks;
                    }
                }
            } else {
                const wk = getWeekKey(currentWeekBaseDate);
                if (!appData.weekly[wk]) appData.weekly[wk] = { tasks: [] };
                
                if (appData.weekly[wk].tasks.length > 0 && !confirm('Í∏∞Ï°¥ Ï£ºÍ∞Ñ ÏùºÏ†ïÏùÑ Î™®Îëê ÏßÄÏö∞Í≥† ÎçÆÏñ¥ÏîåÏö∏ÍπåÏöî?')) {
                     appData.weekly[wk].tasks.push(...newTasks);
                } else {
                     appData.weekly[wk].tasks = newTasks;
                }
            }
            hideLoading();
            saveData();
            renderApp();
        });
    }

    async function confirmProjectPlan() {
        const pid = activeProjectId;
        const promptText = document.getElementById('projectPlanPrompt').value;
        if(!promptText) return alert('ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');

        closeModal('projectPlanModal');
        showLoading("ÌîÑÎ°úÏ†ùÌä∏ Í≥ÑÌöçÏùÑ ÏÑ∏Ïö∞Îäî Ï§ë");
        
        const proj = appData.projects.find(p => p.id === pid);
        const sysPrompt = `Ïó≠Ìï†: ÌîÑÎ°úÏ†ùÌä∏ Îß§ÎãàÏ†Ä. ÌîÑÎ°úÏ†ùÌä∏: "${proj.title}" (${proj.desc}). Í∏∞Í∞Ñ: ${proj.dateDisplay}.
ÏöîÏ≤≠: "${promptText}".
[Í∑úÏπô] 1. ÌîÑÎ°úÏ†ùÌä∏ Í∏∞Í∞Ñ ÎÇ¥ÏóêÏÑú Ïã§Ìñâ Í∞ÄÎä•Ìïú Íµ¨Ï≤¥Ï†ÅÏù∏ Í≥ÑÌöçÏùÑ ÎÇ†ÏßúÎ≥ÑÎ°ú ÏàòÎ¶ΩÌïòÏÑ∏Ïöî.
2. ÌòïÏãù: '- YYYY-MM-DD: Ìï†Ïùº' (ÎÇ†ÏßúÎäî Î∞òÎìúÏãú ÌîÑÎ°úÏ†ùÌä∏ Í∏∞Í∞Ñ ÎÇ¥Ïó¨Ïïº Ìï®).
3. ÌîÑÎ°úÏ†ùÌä∏ Í∏∞Í∞ÑÍ≥º ÏÉÅÍ¥ÄÏóÜÎäî ÌåÅÏù¥ÎÇò Ï°∞Ïñ∏ÏùÄ 'Tip: ÎÇ¥Ïö©' ÌòïÏãùÏúºÎ°ú ÎßàÏßÄÎßâÏóê Ï∂îÍ∞ÄÌïòÏÑ∏Ïöî.`;

        await callGemini(sysPrompt, (text) => {
            const lines = parseTasks(text);
            const newTasks = [];
            lines.forEach(line => {
                let taskText = line.trim();
                let taskDate = null;
                let depth = 0;
                
                if (taskText.startsWith('Tip:')) {
                    newTasks.push({ text: taskText.replace('Tip:', '').trim(), done: false, isTip: true });
                    return;
                }
                
                const dateMatch = taskText.match(/^[-*‚Ä¢]?\s*(\d{4}-\d{2}-\d{2})[:\s](.*)/);
                if (dateMatch) {
                    taskDate = dateMatch[1];
                    taskText = dateMatch[2].trim();
                }
                taskText = taskText.replace(/^[-*‚Ä¢]\s*/, '');
                
                if(!taskDate && taskText.length > 50 && !taskText.includes('-')) {
                    return; 
                }
                
                newTasks.push({ text: taskText, done: false, date: taskDate, depth: depth });
            });

            const p = appData.projects.find(x => x.id === pid);
            if(p.tasks.length > 0 && confirm('ÎçÆÏñ¥ÏîåÏö∏ÍπåÏöî?')) p.tasks = newTasks;
            else if(p.tasks.length === 0) p.tasks = newTasks;
            else p.tasks.push(...newTasks);

            hideLoading();
            saveData();
            renderApp();
        });
    }

    async function generateDailySummary(dateStr) {
        const key = localStorage.getItem(STORAGE_KEY_API);
        if(!key) return alert('API KeyÍ∞Ä ÌïÑÏöîÌï¥Ïöî!');
        
        try {
            const tasks = appData.daily[dateStr] || [];
            let summaryContext = "";
            tasks.forEach(t => {
                if (t.isMessage) return;
                const status = t.done ? "ÏôÑÎ£å" : "ÎØ∏ÏôÑÎ£å";
                const fb = t.feedback ? `(ÌîºÎìúÎ∞±: ${t.feedback})` : "";
                summaryContext += `- ${t.text} [${status}] ${fb}\n`;
            });

            showLoading("zipipoÍ∞Ä ÌöåÍ≥† Ï§ë");
            
            const sysPrompt = `ÎÇ†Ïßú: ${dateStr}. [Ïò§ÎäòÏùò ÌôúÎèô ÎÇ¥Ïó≠]
${summaryContext}

ÏúÑ ÎÇ¥Ïö©ÏùÑ Î∞îÌÉïÏúºÎ°ú ÏïÑÎûò 4Í∞ÄÏßÄ Ìï≠Î™©ÏúºÎ°ú Ï†ïÎ¶¨Ìï¥Ï§ò.
1. Ïò§Îäò ÏûòÌïú Ï†ê
2. ÏïÑÏâ¨Ïö¥ Ï†ê (ÎØ∏ÏôÑÎ£å ÏõêÏù∏ Îì±)
3. ÎßàÏù∏ÎìúÏÖã (ÎèôÍ∏∞Î∂ÄÏó¨)
4. ÎÇ¥Ïùº Í≥ÑÌöç Î∞òÏòÅ (Íµ¨Ï≤¥Ï†ÅÏù∏ Ï°∞Ïñ∏)

[Í∑úÏπô]
- Í∞Å Ìï≠Î™©Ïùò Ï†úÎ™©Í≥º ÎÇ¥Ïö©ÏùÄ Î∞òÎìúÏãú Ï§ÑÎ∞îÍøàÏúºÎ°ú Íµ¨Î∂ÑÌïòÏÑ∏Ïöî.
- ÎßàÌÅ¨Îã§Ïö¥ ÏóÜÏù¥ Ï§ÑÍ∏ÄÎ°ú ÏûëÏÑ±ÌïòÏÑ∏Ïöî.`;

            await callGemini(sysPrompt, (text) => {
                appData.dailySummaries[dateStr] = cleanMarkdown(text);
                hideLoading();
                saveData();
                renderApp();
            });
        } catch(e) {
            console.error(e);
            hideLoading();
        }
    }

    // 6. UI Interaction
    function switchTab(tab) {
        currentTab = tab;
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('tab-active'));
        document.getElementById(`tab-${tab}`).classList.add('tab-active');
        renderApp();
    }
    
    function changeDate(delta) {
        const d = new Date(selectedDate);
        d.setDate(d.getDate() + delta);
        selectedDate = getLocalDateStr(d);
        renderApp();
    }
    
    function editDailyMessage(dateStr) {
        const tasks = appData.daily[dateStr] || [];
        const msgTask = tasks.find(t => t.isMessage);
        const currentMsg = msgTask ? msgTask.text : "";
        
        openInputModal('ÎÇòÏóêÍ≤å ÌïúÎßàÎîî', currentMsg, 'ÏàòÏ†ï', (newText) => {
            appData.daily[dateStr] = tasks.filter(t => !t.isMessage);
            if(newText.trim()) {
                appData.daily[dateStr].unshift({ text: newText, done: false, isMessage: true });
            }
            saveData();
            renderApp();
        });
        document.getElementById('inputModalField').value = combinedText; 
    }

    // Routine Logic
    window.openRoutineModal = openRoutineModal;
    window.addRoutine = addRoutine;
    window.deleteRoutine = deleteRoutine;

    function openRoutineModal() {
        document.getElementById('routineModal').classList.remove('hidden');
        renderRoutineList();
    }
    function renderRoutineList() {
        const list = document.getElementById('routineList');
        list.innerHTML = '';
        (appData.routines || []).forEach((r, i) => {
            list.innerHTML += `
                <div class="flex justify-between items-center bg-white border border-[#EFEBE9] p-2 rounded">
                    <span class="text-sm">${r.text}</span>
                    <button onclick="window.deleteRoutine(${i})" class="text-[#D7CCC8] hover:text-[#FF8A65]">x</button>
                </div>`;
        });
    }
    function addRoutine() {
        const input = document.getElementById('newRoutineInput');
        const text = input.value.trim();
        if(text) {
            appData.routines.push({ text: text });
            input.value = '';
            saveData();
            renderRoutineList();
        }
    }
    function deleteRoutine(i) {
        appData.routines.splice(i, 1);
        saveData();
        renderRoutineList();
    }

    // 7. Modals & Interaction
    function openProjectModal() {
        document.getElementById('projTitle').value = '';
        document.getElementById('projDesc').value = '';
        document.getElementById('projStart').value = '';
        document.getElementById('projEnd').value = '';
        selectedProjDates.clear();
        switchProjMode('range');
        document.getElementById('projectInputModal').classList.remove('hidden');
    }
    function openProjectPlanModal(pid) {
        activeProjectId = pid;
        const p = appData.projects.find(x => x.id === pid);
        document.getElementById('projectPlanPrompt').placeholder = `"${p.title}" ÌîÑÎ°úÏ†ùÌä∏Î•º Îã¨ÏÑ±ÌïòÍ∏∞ ÏúÑÌïú Íµ¨Ï≤¥Ï†ÅÏù∏ Í≥ÑÌöçÏùÑ ÏöîÏ≤≠Ìï¥Î≥¥ÏÑ∏Ïöî.\n(Ïòà: ÏùºÏ£ºÏùºÏóê 3Î≤à Ïö¥ÎèôÌïòÎäî Ïä§ÏºÄÏ§Ñ ÏßúÏ§ò)`;
        document.getElementById('projectPlanPrompt').value = '';
        document.getElementById('projectPlanModal').classList.remove('hidden');
    }
    function openInputModal(title, defaultText, btnText, cb) {
        document.getElementById('inputModalTitle').innerText = title;
        document.getElementById('inputModalField').value = defaultText || '';
        const btn = document.querySelector('#inputModal button:last-child');
        btn.innerText = btnText;
        inputCallback = cb;
        document.getElementById('inputModal').classList.remove('hidden');
    }
    function confirmInput() {
        const val = document.getElementById('inputModalField').value;
        if(inputCallback) inputCallback(val);
        closeModal('inputModal');
    }
    
    // [ÏàòÏ†ï] ÏàòÏ†ï Î™®Îã¨ Ïò§Ìîà Ìï®Ïàò
    function openEditTimeModal(task, type, key, index) {
        editingTask = task;
        currentEditContext = { type, key, index }; // Ï†ÄÏû•

        const timeVal = getTaskTimeVal(task);
        if (timeVal < 9999) {
            const h = Math.floor(timeVal / 60);
            const m = timeVal % 60;
            document.getElementById('startHour').value = h.toString().padStart(2,'0');
            document.getElementById('startMin').value = m.toString().padStart(2,'0');
        } else {
             document.getElementById('startHour').value = '';
             document.getElementById('startMin').value = '';
        }
        
        // ÏãúÍ∞Ñ Î≤îÏúÑ ÌååÏã± (Ïòà: 10:00 ~ 11:00)
        document.getElementById('endHour').value = ''; 
        document.getElementById('endMin').value = '';

        if(task.text.includes('~')) {
            const parts = task.text.match(/(\d{1,2}:\d{2})\s*~\s*(\d{1,2}:\d{2})/);
            if(parts) {
                const start = parts[1].split(':');
                const end = parts[2].split(':');
                document.getElementById('startHour').value = start[0];
                document.getElementById('startMin').value = start[1];
                document.getElementById('endHour').value = end[0];
                document.getElementById('endMin').value = end[1];
            }
        }
        
        document.getElementById('manualTaskText').value = task.text;
        
        // UI ÏÑ§Ï†ï
        document.getElementById('taskModalTitle').innerText = 'Ìï† Ïùº ÏàòÏ†ï';
        document.getElementById('addTaskModal').classList.remove('hidden');

        // [ÏàòÏ†ï] ÏÇ≠Ï†ú Î≤ÑÌäº Î≥¥Ïó¨Ï£ºÍ∏∞
        const delBtn = document.getElementById('modalDeleteBtn');
        if(delBtn) delBtn.classList.remove('hidden');

        const dailyWrapper = document.getElementById('dailyTimeInputWrapper');
        const weeklyWrapper = document.getElementById('weeklyDateInputWrapper');
        
        if (type === 'weekly') {
            dailyWrapper.classList.add('hidden');
            weeklyWrapper.classList.remove('hidden');
            if(task.date) document.getElementById('weeklyTaskDate').value = task.date;
        } else {
            dailyWrapper.classList.remove('hidden');
            weeklyWrapper.classList.add('hidden');
        }
    }
    
    // [ÏàòÏ†ï] Î™®Îã¨ ÎÇ¥ ÏÇ≠Ï†ú Í∏∞Îä•
    window.deleteTaskFromModal = function() {
        if (!currentEditContext) return;
        if (confirm('Ï†ïÎßê ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
            window.deleteTaskItem(currentEditContext.type, currentEditContext.key, currentEditContext.index);
            closeModal('addTaskModal');
        }
    };

    function confirmTaskAction() {
        const text = document.getElementById('manualTaskText').value;
        if (!text) return alert('ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');

        const sh = document.getElementById('startHour').value;
        const sm = document.getElementById('startMin').value;
        const eh = document.getElementById('endHour').value;
        const em = document.getElementById('endMin').value;
        
        let timeStr = null;
        if(sh && sm && eh && em) timeStr = `${sh}:${sm} ~ ${eh}:${em}`;
        else if(sh && sm) timeStr = `${sh}:${sm} ~`;

        const specificDate = document.getElementById('weeklyTaskDate').value;
        
        if (editingTask) {
            const changes = { text: text };
            if (currentTaskTypeForAdd === 'weekly') {
                 changes.specificDate = specificDate;
                 changes.manualTimeRange = null;
            } else {
                 changes.manualTimeRange = timeStr;
                 changes.specificDate = null;
            }
            updateTask(editingTask.type, editingTask.key, editingTask.index, changes);
        } else {
            if (currentTaskTypeForAdd === 'weekly') {
                const wk = getWeekKey(new Date());
                if(!appData.weekly[wk]) appData.weekly[wk] = { tasks:[] };
                appData.weekly[wk].tasks.push({
                    text: text,
                    done: false,
                    date: specificDate || null
                });
            } else {
                if(!appData.daily[selectedDate]) appData.daily[selectedDate] = [];
                let newText = text;
                if(timeStr) newText = `${timeStr} ${text}`;
                appData.daily[selectedDate].push({ text: newText, done: false });
            }
            saveData();
            renderApp();
        }
        closeModal('addTaskModal');
    }

    function switchProjMode(mode) {
        projMode = mode;
        document.querySelectorAll('.modal-tab').forEach(t => t.classList.remove('active'));
        document.getElementById(`pm-${mode}`).classList.add('active');
        if(mode === 'range') {
            document.getElementById('projModeRange').classList.remove('hidden');
            document.getElementById('projModeSelect').classList.add('hidden');
        } else {
            document.getElementById('projModeRange').classList.add('hidden');
            document.getElementById('projModeSelect').classList.remove('hidden');
            renderProjCalendar();
        }
    }
    
    function renderProjCalendar() {
        const y = projCalDate.getFullYear();
        const m = projCalDate.getMonth();
        document.getElementById('projCalTitle').innerText = `${y}.${m+1}`;
        
        const firstDay = new Date(y, m, 1).getDay();
        const lastDate = new Date(y, m+1, 0).getDate();
        
        const grid = document.getElementById('projCalGrid');
        grid.innerHTML = '';
        
        for(let i=0; i<firstDay; i++) {
            grid.innerHTML += `<div></div>`;
        }
        for(let d=1; d<=lastDate; d++) {
            const dateStr = `${y}-${(m+1).toString().padStart(2,'0')}-${d.toString().padStart(2,'0')}`;
            const isSelected = selectedProjDates.has(dateStr);
            const el = document.createElement('div');
            el.className = `mini-cal-cell ${isSelected ? 'selected' : ''}`;
            el.innerText = d;
            el.onclick = () => {
                if(selectedProjDates.has(dateStr)) selectedProjDates.delete(dateStr);
                else selectedProjDates.add(dateStr);
                renderProjCalendar();
                document.getElementById('selectedCount').innerText = selectedProjDates.size;
            };
            grid.appendChild(el);
        }
    }
    function moveProjCal(delta) {
        projCalDate.setMonth(projCalDate.getMonth() + delta);
        renderProjCalendar();
    }
    
    function confirmCreateProject() {
        const title = document.getElementById('projTitle').value;
        const desc = document.getElementById('projDesc').value;
        if(!title) return alert('ÌîÑÎ°úÏ†ùÌä∏ Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî');
        
        let dateDisplay = '';
        let type = '';
        let dateArray = null;
        let startDate = null;
        let endDate = null;
        
        if(projMode === 'range') {
            const start = document.getElementById('projStart').value;
            const end = document.getElementById('projEnd').value;
            if(!start || !end) return alert('Í∏∞Í∞ÑÏùÑ ÏÑ§Ï†ïÌï¥Ï£ºÏÑ∏Ïöî');
            dateDisplay = `${start} ~ ${end}`;
            type = 'range';
            startDate = start;
            endDate = end;
        } else {
            if(selectedProjDates.size === 0) return alert('ÎÇ†ÏßúÎ•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî');
            const sorted = Array.from(selectedProjDates).sort();
            dateDisplay = `Ï¥ù ${selectedProjDates.size}Ïùº (${sorted[0]}...)`;
            type = 'select';
            dateArray = sorted;
            startDate = sorted[0];
            endDate = sorted[sorted.length-1];
        }
        
        appData.projects.push({
            id: Date.now()+'',
            title: title,
            desc: desc,
            dateDisplay: dateDisplay,
            dates: type === 'select' ? dateArray : null,
            startDate: startDate,
            endDate: endDate,
            tasks:[],
            completed: false
        });
        saveData();
        renderApp();
        closeModal('projectInputModal');
    }

    function openGeneratorModal(mode) {
        document.getElementById('generatorModal').classList.remove('hidden');
        const txt = document.getElementById('taskPrompt');
        if (mode === 'new') {
            txt.value = '';
            // [ÏàòÏ†ï] Î™®Îã¨ ÌÉÄÏù¥ÌãÄÏùÑ 'ÏùºÏ†ï ÏßìÍ∏∞'Î°ú Ï¥àÍ∏∞Ìôî (ÌòπÏãú Î≥ÄÍ≤ΩÎêòÏóàÏùÑ Í≤ΩÏö∞)
        } else if (mode === 'daily') {
            txt.value = appData.dailyPrompts[selectedDate] || '';
        } else if (mode === 'weekly') {
            const wk = getWeekKey(currentWeekBaseDate);
            txt.value = appData.weeklyPrompts[wk] || '';
        }
    }

    function openWeeklyGenerator() {
        const wk = getWeekKey(currentWeekBaseDate);
        if(!appData.weeklyPrompts[wk]) appData.weeklyPrompts[wk] = '';
        document.getElementById('taskPrompt').value = appData.weeklyPrompts[wk];
        openGeneratorModal('weekly');
    }

    // 8. RENDERERS
    function renderApp() {
        const container = document.getElementById('appContent');
        container.innerHTML = '';
        
        if(currentTab === 'home') renderDaily(container);
        else if(currentTab === 'project') renderProjects(container);
        else if(currentTab === 'achievement') renderCalendar(container);
    }
    
    function renderDaily(container) {
        document.getElementById('headerDate').innerText = selectedDate;
        
        const nav = document.createElement('div');
        nav.className = 'flex justify-between items-center mb-4';
        nav.innerHTML = `
            <button onclick="window.changeDate(-1)" class="p-2 text-[#8D6E63] hover:bg-[#EFEBE9] rounded-full">‚óÄ</button>
            <span class="text-sm font-bold text-[#5D4037]">${selectedDate === getTodayStr() ? 'Ïò§Îäò' : ''}</span>
            <button onclick="window.changeDate(1)" class="p-2 text-[#8D6E63] hover:bg-[#EFEBE9] rounded-full">‚ñ∂</button>
        `;
        container.appendChild(nav);

        // Daily Content
        const dailyData = appData.daily[selectedDate] || [];
        const dailyMsgs = dailyData.filter(t => t.isMessage);
        
        const secDaily = document.createElement('section');
        if (dailyMsgs.length > 0) {
            const msgBox = document.createElement('div');
            msgBox.className = 'mx-6 mt-1 mb-3 p-3 bg-white/60 rounded-xl border border-[#C5E1A5] text-sm text-[#556B2F] relative z-10 font-wando leading-relaxed cursor-pointer hover:bg-white/80 transition';
            msgBox.onclick = () => editDailyMessage(selectedDate);
            msgBox.innerHTML = dailyMsgs.map(m => m.text).join('<br>');
            secDaily.appendChild(msgBox);
        }
        
        const contentDaily = document.createElement('div');
        contentDaily.className = 'bg-white rounded-[24px] border border-[#EFEBE9] p-5 relative min-h-[300px] shadow-sm';
        
        const promptBtn = document.createElement('button');
        promptBtn.className = 'absolute top-3 right-3 text-[10px] text-[#A1887F] bg-[#FDFCF5] border border-[#D7CCC8] px-2 py-1 rounded-full hover:bg-[#EFEBE9] z-20 flex items-center gap-1';
        promptBtn.innerHTML = `ÏàòÏ†ï`;
        promptBtn.onclick = () => openGeneratorModal('daily');
        contentDaily.appendChild(promptBtn);

        const gridBg = document.createElement('div');
        gridBg.className = 'absolute inset-0 pointer-events-none opacity-30';
        gridBg.style.backgroundImage = 'linear-gradient(#EFEBE9 1px, transparent 1px)';
        gridBg.style.backgroundSize = '100% 24px';
        contentDaily.appendChild(gridBg);

        const realDailyTasks = dailyData.filter(t => !t.isMessage);
        if (realDailyTasks.length > 0) {
            const ulDaily = document.createElement('ul');
            // ÏãúÍ∞ÑÏàú Ï†ïÎ†¨
            realDailyTasks.sort((a,b) => getTaskTimeVal(a) - getTaskTimeVal(b));
            
            realDailyTasks.forEach((t) => {
                const originalIndex = dailyData.indexOf(t); 
                ulDaily.appendChild(createTaskEl(t, 'daily', selectedDate, originalIndex));
            });
            contentDaily.appendChild(ulDaily);
        } else {
            const empty = document.createElement('div');
            empty.className = 'empty-state text-[#BCAAA4] text-xs';
            empty.innerHTML = `ÏïÑÏßÅ ÏùºÏ†ïÏù¥ ÏóÜÏñ¥Ïöî.<br>Ïö∞Ï∏° ÌïòÎã® + Î≤ÑÌäºÏùÑ ÎàåÎü¨ ÏùºÏ†ïÏùÑ ÏßÄÏñ¥Î≥¥ÏÑ∏Ïöî!`;
            contentDaily.appendChild(empty);
        }
        secDaily.appendChild(contentDaily);
        
        // Summary Area
        if (realDailyTasks.length > 0) {
            const summaryDiv = document.createElement('div');
            summaryDiv.className = 'mt-4 p-4 bg-[#EFEBE9]/30 rounded-xl';
            const hasSummary = !!appData.dailySummaries[selectedDate];
            summaryDiv.innerHTML = `
                <div class="flex justify-between items-center mb-2">
                    <span class="text-xs font-bold text-[#8D6E63]">ÌïòÎ£® ÌöåÍ≥†</span>
                    <button onclick="generateDailySummary('${selectedDate}')" class="text-[10px] bg-white border border-[#D7CCC8] px-2 py-1 rounded text-[#5D4037] hover:bg-[#EFEBE9]">${hasSummary ? 'Îã§Ïãú Ïì∞Í∏∞' : 'ÌöåÍ≥† ÌïòÍ∏∞'}</button>
                </div>
                <div class="text-xs text-[#5D4037] whitespace-pre-line leading-relaxed">${appData.dailySummaries[selectedDate] || 'Ïò§Îäò ÌïòÎ£®Îäî Ïñ¥Îï†ÎÇòÏöî?'}</div>
            `;
            secDaily.appendChild(summaryDiv);
        }

        container.appendChild(secDaily);
        
        // Weekly Preview (Bottom)
        const weekKey = getWeekKey(selectedDate);
        const weeklyData = appData.weekly[weekKey];
        if(weeklyData && weeklyData.tasks.length > 0) {
            const secWeekly = document.createElement('section');
            secWeekly.className = 'mt-8 pt-6 border-t border-[#EFEBE9]';
            secWeekly.innerHTML = `<h3 class="font-hand text-xl text-[#8D6E63] mb-3 px-1">Ïù¥Î≤à Ï£º Ìï† Ïùº</h3>`;
            
            const contentWrap = document.createElement('div');
            contentWrap.className = 'bg-[#F1F8E9] rounded-2xl p-4 border border-[#DCEDC8]';
            
            // 1. Date specific
            const dateSpecific = weeklyData.tasks.filter(t => t.date);
            if(dateSpecific.length > 0) {
                dateSpecific.sort((a,b) => new Date(a.date) - new Date(b.date));
                const ul = document.createElement('ul');
                ul.className = 'pl-2 space-y-2';
                dateSpecific.forEach(t => {
                   const idx = weeklyData.tasks.indexOf(t);
                   const el = createTaskEl(t, 'weekly', weekKey, idx);
                   el.classList.add('weekly-item');
                   // Prepend date badge
                   const dBadge = document.createElement('span');
                   dBadge.className = 'text-[10px] bg-white text-[#556B2F] px-1 rounded mr-1 border border-[#C5E1A5]';
                   dBadge.innerText = t.date.slice(5);
                   el.querySelector('.relative').prepend(dBadge);
                   ul.appendChild(el);
                });
                contentWrap.appendChild(ul);
            }
            // 2. Anytime
            const anytimeTasks = weeklyData.tasks.filter(t => !t.date && !t.specificDate);
            if (anytimeTasks.length > 0) {
                 const anytimeSection = document.createElement('div');
                 anytimeSection.className = 'flex flex-col mt-2 pt-3 border-t border-dashed border-[#C5E1A5]';
                 anytimeSection.innerHTML = `<div class="text-xs text-[#8D6E63] font-bold mb-2">Anytime</div>`;
                 const ulAny = document.createElement('ul');
                 ulAny.className = 'pl-2 space-y-2';
                 anytimeTasks.forEach(t => {
                    const originalIdx = weeklyData.tasks.indexOf(t);
                    const taskEl = createTaskEl(t, 'weekly', weekKey, originalIdx);
                    taskEl.classList.add('weekly-item');
                    ulAny.appendChild(taskEl);
                 });
                 anytimeSection.appendChild(ulAny);
                 contentWrap.appendChild(anytimeSection);
            }
            secWeekly.appendChild(contentWrap);
            container.appendChild(secWeekly);
        }
    }

    function renderProjects(container) {
        const secProj = document.createElement('section');
        secProj.innerHTML = `<h3 class="font-hand text-xl text-[#556B2F] mb-3 px-1 flex items-center gap-1">ÎèÑÏ†ÑÏ§ëÏù∏ ÌîÑÎ°úÏ†ùÌä∏</h3>`;
        
        const addBtnContainer = document.createElement('div');
        addBtnContainer.className = 'mb-6';
        addBtnContainer.innerHTML = `<button onclick="window.openProjectModal()" class="w-full py-4 border-2 border-dashed border-[#A1887F] text-[#8D6E63] font-hand text-xl rounded-2xl hover:bg-[#FDFCF5] active:bg-[#D7CCC8] active:text-white transition bg-white shadow-none flex items-center justify-center gap-2"><span class="text-2xl">+</span> ÏÉàÎ°úÏö¥ ÌîÑÎ°úÏ†ùÌä∏ Ïã¨Í∏∞</button>`;
        container.appendChild(addBtnContainer);
        
        // [FIX] Add Scroll ID
        const scrollDiv = document.createElement('div');
        scrollDiv.id = 'projectScrollContainer';
        scrollDiv.className = 'space-y-6 max-h-[600px] overflow-y-auto pr-1';
        // scroll event listener
        scrollDiv.addEventListener('scroll', () => {
             lastProjectScrollTop = scrollDiv.scrollTop;
        });

        const activeProjs = appData.projects.filter(p => !p.completed);
        activeProjs.forEach(p => {
             const card = document.createElement('div');
             card.className = 'wood-frame p-5 relative shadow-sm';
             
             // Header
             const header = document.createElement('div');
             header.className = 'flex justify-between items-start mb-2';
             header.innerHTML = `
                <div>
                    <h4 class="font-bold text-lg text-[#5D4037]">${p.title}</h4>
                    <div class="text-xs text-[#A1887F] mt-1">${p.dateDisplay}</div>
                </div>
                <button onclick="if(confirm('ÌîÑÎ°úÏ†ùÌä∏Î•º ÏôÑÎ£å Ï≤òÎ¶¨ÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) window.completeProject('${p.id}', true)" class="text-[#8D6E63] hover:text-[#556B2F] text-xs border border-[#D7CCC8] px-2 py-1 rounded-full">ÏôÑÎ£åÌïòÍ∏∞</button>
             `;
             card.appendChild(header);
             
             if(p.desc) {
                 const desc = document.createElement('div');
                 desc.className = 'text-xs text-[#795548] bg-[#EFEBE9]/50 p-2 rounded-lg mb-4';
                 desc.innerText = p.desc;
                 card.appendChild(desc);
             }
             
             // Content (Tasks)
             const contentContainer = document.createElement('div');
             contentContainer.className = 'bg-[#FDFCF5] rounded-xl border border-[#D7CCC8] p-3';
             
             const planControl = document.createElement('div');
             planControl.className = 'flex justify-end mb-2';
             planControl.innerHTML = `<div class="flex gap-2">
                 <button onclick="openProjectPlanModal('${p.id}')" class="text-[10px] bg-white border border-[#D7CCC8] px-2 py-1 rounded text-[#8D6E63] hover:bg-[#EFEBE9]">Í≥ÑÌöç ÏßúÍ∏∞</button>
             </div>`;
             contentContainer.appendChild(planControl);
             
             const taskListContainer = document.createElement('div');
             taskListContainer.className = 'max-h-80 overflow-y-auto pl-1 text-sm';
             contentContainer.appendChild(taskListContainer);
             card.appendChild(contentContainer);
             
             let deadline = p.endDate;
             if (!deadline && p.dates && p.dates.length > 0) {
                 const sorted = [...p.dates].sort();
                 deadline = sorted[sorted.length-1];
             }
             if (!deadline && p.dateDisplay && p.dateDisplay.includes('~')) {
                 const parts = p.dateDisplay.split('~');
                 if(parts.length===2) deadline = parts[1].trim();
             }
             
             const sortedDates = [...new Set(p.tasks.filter(t=>t.date).map(t=>t.date))].sort();
             const noDateTasks = p.tasks.filter(t=>!t.date && !t.isTip);
             const tips = p.tasks.filter(t=>t.isTip);

             // Render Date Groups
             sortedDates.forEach(date => {
                 const displayDate = date;
                 let dDayLabel = '';
                 
                 if (deadline && /\d{4}-\d{2}-\d{2}/.test(date)) {
                     const target = new Date(deadline);
                     target.setHours(0,0,0,0);
                     const [y,m,d] = date.split('-').map(Number);
                     const current = new Date(y, m-1, d);
                     const diffTime = target - current;
                     const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                     
                     if (diffDays > 0) dDayLabel = ` <span class="text-[#FF8A65] ml-1 text-[10px] font-normal">(D-${diffDays})</span>`;
                     else if (diffDays === 0) dDayLabel = ` <span class="text-[#FF8A65] ml-1 text-[10px] font-normal">(D-Day)</span>`;
                     else dDayLabel = ` <span class="text-[#FF8A65] ml-1 text-[10px] font-normal">(D+${Math.abs(diffDays)})</span>`;
                 }
                 
                 const dateHeader = document.createElement('div');
                 dateHeader.className = 'proj-date-header';
                 dateHeader.innerHTML = displayDate + dDayLabel;
                 taskListContainer.appendChild(dateHeader);
                 
                 const ul = document.createElement('ul');
                 const tasksInDate = p.tasks.filter(t => t.date === date);
                 tasksInDate.forEach(t => {
                     const originalIdx = p.tasks.indexOf(t);
                     ul.appendChild(createTaskEl(t, 'project', p.id, originalIdx, null));
                 });
                 taskListContainer.appendChild(ul);
             });
             
             if(noDateTasks.length > 0) {
                 const header = document.createElement('div');
                 header.className = 'proj-msg-box mt-3';
                 header.innerText = 'General Tasks';
                 taskListContainer.appendChild(header);
                 
                 const ul = document.createElement('ul');
                 noDateTasks.forEach(t => {
                     const originalIdx = p.tasks.indexOf(t);
                     ul.appendChild(createTaskEl(t, 'project', p.id, originalIdx));
                 });
                 taskListContainer.appendChild(ul);
             }
             
             if(tips.length > 0) {
                 const tipBox = document.createElement('div');
                 tipBox.className = 'proj-tip-box';
                 tipBox.innerHTML = `<span class="proj-tip-label">üí° Tips</span>`;
                 const ul = document.createElement('ul');
                 ul.className = 'list-disc pl-4 space-y-1';
                 tips.forEach(t => {
                      const li = document.createElement('li');
                      li.innerText = t.text;
                      ul.appendChild(li);
                 });
                 tipBox.appendChild(ul);
                 taskListContainer.appendChild(tipBox);
             }
             
             // Memo
             const memoArea = document.createElement('textarea');
             memoArea.className = 'proj-memo-area';
             memoArea.placeholder = 'Î©îÎ™®Î•º ÎÇ®Í≤®Î≥¥ÏÑ∏Ïöî...';
             memoArea.rows = 2;
             memoArea.value = p.memo || '';
             memoArea.onblur = (e) => window.updateProjectMemo(p.id, e.target.value);
             card.appendChild(memoArea);
             
             // Delete Project Button
             const delPBtn = document.createElement('button');
             delPBtn.className = 'absolute top-3 right-3 text-[#D7CCC8] hover:text-[#FF8A65] text-sm';
             delPBtn.innerHTML = 'x';
             delPBtn.onclick = (e) => {
                 if(confirm('ÌîÑÎ°úÏ†ùÌä∏Î•º ÏÇ≠Ï†úÌï†ÍπåÏöî?')) {
                     appData.projects = appData.projects.filter(x => x.id !== p.id);
                     saveData();
                     renderApp();
                 }
             };
             card.appendChild(delPBtn);
             
             scrollDiv.appendChild(card);
        });
        container.appendChild(scrollDiv);

        // Completed Projects
        const completedProjs = appData.projects.filter(p => p.completed);
        if (completedProjs.length > 0) {
             const secProj = document.createElement('div');
             secProj.className = 'mt-8 border-t border-[#EFEBE9] pt-6';
             secProj.innerHTML = `<h3 class="font-hand text-lg text-[#BCAAA4] mb-3 px-1">ÏôÑÎ£åÎêú ÌîÑÎ°úÏ†ùÌä∏</h3>`;
             const completedSec = document.createElement('div');
             completedSec.className = 'space-y-3 opacity-70 grayscale hover:grayscale-0 transition duration-300';
             
             const list = document.createElement('ul');
             completedProjs.forEach(p => {
                 const item = document.createElement('li');
                 const titleRow = document.createElement('div');
                 titleRow.className = 'flex justify-between items-center bg-white border border-[#EFEBE9] p-3 rounded-xl cursor-pointer hover:bg-[#FDFCF5]';
                 titleRow.innerHTML = `<span class="font-bold text-[#5D4037] text-sm">${p.title}</span> <span class="text-[10px] text-[#A1887F]">ÏôÑÎ£åÎê®</span>`;
                 
                 const detailDiv = document.createElement('div');
                 detailDiv.className = 'hidden mt-2 pl-3 pr-1 py-2 border-l-2 border-[#D7CCC8]/30 ml-2 bg-white/50 rounded-r-xl text-xs space-y-2';
                 detailDiv.innerHTML = `<button class="flex items-center gap-1 text-[#8D6E63] hover:text-[#5D4037] mb-2 text-[11px] font-bold" onclick="event.stopPropagation(); window.completeProject('${p.id}', false)">${ICONS.undo} Î≥µÍµ¨</button>`;
                 
                 if (p.desc) detailDiv.innerHTML += `<div class="text-[#A1887F] mb-2">${p.desc}</div>`;
                 
                 const taskList = document.createElement('ul');
                 taskList.className = 'pl-2 space-y-1 mt-2 border-t border-dashed border-[#EFEBE9] pt-2';
                 if(p.tasks.length > 0) {
                     p.tasks.forEach(t => {
                         if(t.isTip) {
                             taskList.innerHTML += `<li class="text-xs text-[#FF8A65] flex items-start gap-1">Tip: ${t.text}</li>`;
                         } else {
                             taskList.innerHTML += `<li class="text-xs text-[#5D4037] flex items-start gap-1"><div class="w-0.5 h-3 bg-[#D7CCC8] mt-1"></div> ${t.text}</li>`;
                         }
                     });
                 }
                 detailDiv.appendChild(taskList);
                 
                 titleRow.onclick = () => { detailDiv.classList.toggle('hidden'); };
                 item.append(titleRow, detailDiv);
                 list.appendChild(item);
             });
             completedSec.appendChild(list);
             secProj.appendChild(completedSec);
             container.appendChild(secProj);
        }
        
        // [FIX] Restore Scroll
        if(lastProjectScrollTop > 0) {
            scrollDiv.scrollTop = lastProjectScrollTop;
        }
    }

    function renderCalendar(container) {
        const year = calendarDate.getFullYear();
        const month = calendarDate.getMonth();
        
        const wrapper = document.createElement('div');
        wrapper.className = 'wood-frame p-6 min-h-[400px]';
        
        const header = document.createElement('div');
        header.className = 'flex justify-between items-center mb-6';
        header.innerHTML = `
            <button onclick="window.moveWeek(-1)" class="text-[#8D6E63] text-xl font-bold">‚Äπ</button>
            <h3 class="font-hand text-2xl text-[#5D4037]">${year}ÎÖÑ ${month+1}Ïõî</h3>
            <button onclick="window.moveWeek(1)" class="text-[#8D6E63] text-xl font-bold">‚Ä∫</button>
        `;
        wrapper.appendChild(header);
        
        const grid = document.createElement('div');
        grid.className = 'grid grid-cols-7 gap-2 text-center text-xs mb-6';
        
        const days = ['Ïùº','Ïõî','Ìôî','Ïàò','Î™©','Í∏à','ÌÜ†'];
        days.forEach(d => grid.innerHTML += `<div class="text-[#A1887F] font-bold mb-2">${d}</div>`);
        
        const firstDay = new Date(year, month, 1).getDay();
        const lastDate = new Date(year, month+1, 0).getDate();
        
        for(let i=0; i<firstDay; i++) grid.innerHTML += `<div></div>`;
        
        for(let d=1; d<=lastDate; d++) {
            const dateStr = `${year}-${(month+1).toString().padStart(2,'0')}-${d.toString().padStart(2,'0')}`;
            const isToday = dateStr === getTodayStr();
            const dailyData = appData.daily[dateStr] || [];
            const doneCount = dailyData.filter(t => t.done).length;
            const totalCount = dailyData.filter(t => !t.isMessage).length;
            
            let achievementColor = 'bg-[#EFEBE9]'; 
            let textColor = 'text-[#BCAAA4]';
            
            if (totalCount > 0) {
                const ratio = doneCount / totalCount;
                if (ratio === 1) { achievementColor = 'bg-[#A5D6A7]'; textColor = 'text-white'; }
                else if (ratio >= 0.5) { achievementColor = 'bg-[#FFCC80]'; textColor = 'text-white'; }
                else { achievementColor = 'bg-[#FFAB91]'; textColor = 'text-white'; }
            } else {
                // No task
            }

            const cell = document.createElement('div');
            cell.className = `aspect-square flex flex-col items-center justify-center rounded-xl cursor-pointer transition ${isToday ? 'border-2 border-[#8D6E63]' : ''} hover:bg-gray-50`;
            cell.onclick = () => {
                achievementViewDate = dateStr;
                renderApp();
            };
            
            cell.innerHTML = `
                <div class="${achievementColor} w-6 h-6 rounded-full flex items-center justify-center mb-1 shadow-sm">
                   <span class="${textColor} text-[10px] font-bold">${d}</span>
                </div>
            `;
            grid.appendChild(cell);
        }
        wrapper.appendChild(grid);
        
        // Detail View for selected date in Achievement
        const detailSec = document.createElement('div');
        detailSec.className = 'mt-6 border-t border-[#EFEBE9] pt-4';
        
        const selectedDaily = appData.daily[achievementViewDate] || [];
        const completedTasks = selectedDaily.filter(t => t.done);
        
        detailSec.innerHTML = `
            <h4 class="font-hand text-lg text-[#5D4037] mb-2 text-center">${achievementViewDate} Îã¨ÏÑ± ÎÇ¥Ïó≠</h4>
            <div class="text-center text-xs text-[#A1887F] mb-4">
                ÏôÑÎ£å ${completedTasks.length} / Ï†ÑÏ≤¥ ${selectedDaily.filter(t=>!t.isMessage).length}
            </div>
        `;
        
        const fbSection = document.createElement('div');
        fbSection.className = 'bg-[#FDFCF5] p-4 rounded-xl border border-[#D7CCC8]';
        
        let detailsHtml = '';
        const summary = appData.dailySummaries[achievementViewDate];
        if (summary) {
            detailsHtml += `<div class="mb-4 text-xs text-[#5D4037] bg-white p-3 rounded-lg border border-[#EFEBE9] leading-relaxed">${summary}</div>`;
        } else if (achievementViewDate === getTodayStr()) {
             // Show button if today
        } else {
             // Pass
        }
        
        detailsHtml += `<ul class="space-y-2 mb-4">`;
        if(completedTasks.length === 0) detailsHtml += `<li class="text-xs text-[#BCAAA4] italic text-center">ÏôÑÎ£åÎêú ÏùºÏ†ïÏù¥ ÏóÜÏñ¥Ïöî.</li>`;
        else {
            completedTasks.forEach(t => {
                let cleanText = t.text.replace(/(\d{1,2}:\d{2})?(~)?(\d{1,2}:\d{2})?(\s*\(.*?m\))?/, '').trim();
                detailsHtml += `<li class="text-xs flex gap-2 items-start text-[#5D4037]"><span class="w-1.5 h-1.5 rounded-full bg-[#A1887F] mt-1.5"></span> ${cleanText}</li>`;
            });
        }
        detailsHtml += `</ul>`;
        
        fbSection.innerHTML = detailsHtml;
        wrapper.appendChild(detailSec);
        wrapper.appendChild(fbSection);
        
        container.appendChild(wrapper);
    }

    function createTaskEl(task, type, key, index, numberPrefix = null) {
        const li = document.createElement('li');
        li.className = 'timeline-container flex flex-col mb-4';
        
        const isProject = type === 'project';
        if (!isProject) {
            const dot = document.createElement('div');
            dot.className = 'timeline-dot';
            const line = document.createElement('div');
            line.className = 'timeline-line';
            li.appendChild(line);
            li.appendChild(dot);
        }
        
        const content = document.createElement('div');
        content.className = 'relative z-10 w-full';
        
        if (isProject) {
            li.style.paddingLeft = '0';
            li.style.marginBottom = '0.5rem';
        }

        let displayTime = '';
        let displayText = task.text;
        let subText = '';
        
        if (isProject && numberPrefix) {
            if (task.depth && task.depth > 0) li.classList.add(`task-depth-${task.depth}`);
        }

        if (type === 'daily') {
             // Time parsing logic (simplified)
             const timeMatch = task.text.match(/^(\d{1,2}:\d{2})(\s*~\s*\d{1,2}:\d{2})?/);
             if (timeMatch) {
                 displayTime = timeMatch[0];
                 displayText = task.text.replace(displayTime, '').trim();
                 if (displayText.startsWith(':')) displayText = displayText.substring(1).trim();
             }
        }

        if (type === 'daily') {
            const timeSpan = document.createElement('span');
            timeSpan.className = 'task-time-label';
            timeSpan.innerText = displayTime || 'Anytime';
            content.appendChild(timeSpan);
        }

        const actionGroup = document.createElement('div');
        actionGroup.className = 'flex items-start justify-between gap-2 group';
        
        // Text Area with Click to Edit
        const title = document.createElement('span');
        title.className = `text-sm cursor-pointer flex-1 leading-tight ${task.done ? 'text-[#BCAAA4] line-through' : 'text-[#5D4037]'}`;
        title.innerText = numberPrefix ? `${numberPrefix} ${displayText}` : displayText;
        
        // [ÏàòÏ†ï] ÏàòÏ†ï Î™®Îã¨ Ïò§Ìîà Ïó∞Í≤∞
        title.onclick = () => {
             // openEditTimeModal
             if(type === 'daily') window.openEditTimeModal(task, 'daily', key, index);
             else if(type === 'weekly') window.openEditTimeModal(task, 'weekly', key, index);
             // Projects might not have edit modal or different logic
        };

        const chk = document.createElement('input');
        chk.type = 'checkbox';
        chk.className = 'custom-checkbox mt-0.5';
        chk.checked = task.done;
        chk.onchange = () => {
            const newState = chk.checked;
            window.updateTask(type, key, index, { done: newState });
        };
        
        let fbBtn = null;
        if(type === 'daily') {
            fbBtn = document.createElement('button');
            fbBtn.className = `text-xs px-1 ${task.feedback ? 'text-[#FF8A65]' : 'text-[#D7CCC8] hover:text-[#8D6E63]'}`;
            fbBtn.innerHTML = ICONS.speech;
            fbBtn.onclick = (e) => {
                e.stopPropagation();
                openInputModal('ÌîºÎìúÎ∞± ÎÇ®Í∏∞Í∏∞', task.feedback || '', 'Ï†ÄÏû•', (val) => window.updateTask(type, key, index, {feedback: val}));
            };
        }

        actionGroup.appendChild(title);
        
        // [ÏàòÏ†ï] ÏÇ≠Ï†ú Î≤ÑÌäº ÏÉùÏÑ± ÏΩîÎìú Ï†úÍ±∞ (Ï£ºÏÑù Ï≤òÎ¶¨ ÎòêÎäî ÏÇ≠Ï†ú)
        /*
        const delBtn = document.createElement('button');
        delBtn.className = 'text-[#D7CCC8] hover:text-[#FF7F50] text-xs px-1';
        delBtn.innerHTML = 'x';
        delBtn.onclick = (e) => {
            e.stopPropagation();
            if(confirm('ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                window.deleteTaskItem(type, key, index);
            }
        };
        actionGroup.appendChild(delBtn);
        */

        if (fbBtn) actionGroup.appendChild(fbBtn);
        actionGroup.appendChild(chk);
        
        content.appendChild(actionGroup);
        
        if (type === 'daily' && subText) {
             const subDiv = document.createElement('div');
             subDiv.className = 'task-sub-text';
             subDiv.innerText = subText;
             content.appendChild(subDiv);
        }
        
        li.appendChild(content);

        if(type === 'daily') {
             // Optional: visual duration or routine tag?
        }
        
        return li;
    }

    // 9. DATA MANIPULATION
    window.updateTask = function(type, key, index, changes) {
        const previousScrollY = window.scrollY;
        let list = [];
        if(type === 'daily') list = appData.daily[key];
        else if(type === 'weekly') list = appData.weekly[key].tasks;
        else if(type === 'project') {
             const p = appData.projects.find(x => x.id === key);
             if(p) list = p.tasks;
        }

        if(list && list[index]) {
            // Apply changes
            Object.keys(changes).forEach(k => {
                 if(k === 'manualTimeRange') {
                     // ÎçÆÏñ¥Ïì∞Í∏∞ or append?
                     // If manualTimeRange is present, replace time part in text
                     const oldText = list[index].text;
                     const newTime = changes[k];
                     const oldTimeMatch = oldText.match(/^(\d{1,2}:\d{2})(~\d{1,2}:\d{2})?/);
                     
                     let cleanText = oldText;
                     if(oldTimeMatch) cleanText = oldText.replace(oldTimeMatch[0], '').trim();
                     
                     if(newTime) list[index].text = `${newTime} ${cleanText}`;
                     else list[index].text = cleanText;
                 } else if (k === 'specificDate') {
                     list[index].date = changes[k];
                 } else {
                     list[index][k] = changes[k];
                 }
            });
            saveData();
            renderApp();
            window.scrollTo(0, previousScrollY);
        }
    };

    window.deleteTaskItem = function(type, key, index) {
        if(type === 'daily') {
            appData.daily[key].splice(index, 1);
        } else if(type === 'weekly') {
            appData.weekly[key].tasks.splice(index, 1);
        } else if(type === 'project') {
             const p = appData.projects.find(x => x.id === key);
             if(p) p.tasks.splice(index, 1);
        }
        saveData();
        renderApp();
    };

    window.updateProjectMemo = function(pid, val) {
        const p = appData.projects.find(x => x.id === pid);
        if(p) {
            p.memo = val;
            saveData();
        }
    }
    
    function completeProject(pid, isComplete) {
        const p = appData.projects.find(x => x.id === pid);
        if(p) {
            p.completed = isComplete;
            saveData();
            renderApp();
        }
    }
    
    function moveWeek(delta) {
        calendarDate.setMonth(calendarDate.getMonth() + delta);
        renderApp();
    }
    
    // Globals for external calls
    window.changeDate = changeDate;
    window.openGeneratorModal = openGeneratorModal;
    window.generateSchedule = generateSchedule;
    window.closeModal = closeModal;
    window.switchTab = switchTab;
    window.toggleApiKeyInput = toggleApiKeyInput;
    window.saveApiKey = saveApiKey;
    window.confirmInput = confirmInput;
    window.switchProjMode = switchProjMode;
    window.moveProjCal = moveProjCal;
    window.confirmCreateProject = confirmCreateProject;
    window.openProjectModal = openProjectModal;
    window.openProjectPlanModal = openProjectPlanModal;
    window.closeProjectPlanModal = () => closeModal('projectPlanModal');
    window.confirmProjectPlan = confirmProjectPlan;
    window.completeProject = completeProject;
    window.moveWeek = moveWeek;
    window.openEditTimeModal = openEditTimeModal;
    window.updateTask = updateTask;
    window.confirmTaskAction = confirmTaskAction;
    window.deleteTaskItem = deleteTaskItem;
    window.addManualTask = () => {
         // Manual add task trigger
         currentTaskTypeForAdd = 'daily';
         document.getElementById('taskModalTitle').innerText = 'Ìï† Ïùº Ï∂îÍ∞Ä';
         document.getElementById('manualTaskText').value = '';
         document.getElementById('startHour').value = '';
         document.getElementById('startMin').value = '';
         document.getElementById('endHour').value = '';
         document.getElementById('endMin').value = '';
         document.getElementById('weeklyTaskDate').value = '';
         
         document.getElementById('addTaskModal').classList.remove('hidden');
         // [ÏàòÏ†ï] Ï∂îÍ∞Ä Ïãú ÏÇ≠Ï†ú Î≤ÑÌäº Ïà®ÍπÄ
         document.getElementById('modalDeleteBtn').classList.add('hidden');
         editingTask = null;
         currentEditContext = null;
    };
    
    // INIT
    loadData();
    renderApp();
</script>
</body>
</html>

