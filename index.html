<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>zipipo planner</title>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Gowun+Dodum&family=Kirang+Haerang&display=swap" rel="stylesheet">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* --- Theme Variables --- */
        :root {
            --bg-ivory: #FDFCF5;
            --wood-frame: #A1887F;
            --wood-text: #5D4037;
            --sage-green: #8FBC8F;
            --point-coral: #FF8A65;
        }
        
        @font-face {
            font-family: 'WandoCleanSea';
            src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_20-04@2.1/WandoCleanSea.woff') format('woff');
            font-weight: normal;
            font-style: normal;
        }
        
        body, button, input, textarea, select {
            font-family: 'Gowun Dodum', sans-serif !important;
            color: var(--wood-text);
            -webkit-tap-highlight-color: transparent;
        }
        .font-hand { font-family: 'Kirang Haerang', cursive !important; }
        .font-wando { font-family: 'WandoCleanSea', sans-serif !important; } 
        
        body { background-color: var(--bg-ivory); }

        /* Sticky Header */
        .sticky-header-wrapper {
            position: sticky;
            top: 0;
            z-index: 40;
            background-color: var(--bg-ivory);
            border-bottom: 1px solid #EFEBE9;
        }

        /* Pillow Frame (Flat) */
        .pillow-frame {
            background-color: white;
            border-radius: 24px;
            border: 1px solid #D7CCC8;
            overflow: hidden;
            position: relative;
        }
        .pillow-frame::after {
            content: '';
            position: absolute;
            top: 6px; left: 6px; right: 6px; bottom: 6px;
            border: 2px dashed #D7CCC8;
            border-radius: 20px;
            pointer-events: none;
            opacity: 0.4;
        }

        /* Timeline - Daily */
        .timeline-container {
            position: relative;
            padding-left: 20px;
            padding-bottom: 10px; 
        }
        .timeline-line {
            position: absolute;
            left: 7px;
            top: 10px; 
            bottom: -10px; 
            width: 2px;
            background-color: var(--wood-text);
            opacity: 0.2;
            border-radius: 2px;
        }
        .timeline-container:last-child .timeline-line { display: none; }
        .timeline-dot {
            position: absolute;
            left: 4px;
            top: 7px;
            width: 8px; /* Small dot */
            height: 8px;
            background-color: var(--wood-text);
            border-radius: 50%;
            z-index: 2;
        }

        /* Timeline - Weekly (No Line, Small Dot) */
        .weekly-item .timeline-line { display: none !important; }
        .weekly-item .timeline-dot {
            width: 5px;
            height: 5px;
            left: 6px;
            top: 9px;
            background-color: var(--sage-green);
        }
        .weekly-item.timeline-container {
            padding-left: 18px; 
        }
        
        .empty-state {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem 0;
            text-align: center;
            width: 100%;
        }

        .wood-frame {
            border: 2px solid var(--wood-frame);
            border-radius: 16px;
            background: white;
        }

        /* Tabs */
        .tab-btn {
            font-family: 'Kirang Haerang', cursive !important;
            font-size: 1.3rem;
            color: #D7CCC8;
            transition: color 0.2s;
        }
        .tab-active {
            color: var(--wood-text);
            position: relative;
        }
        .tab-active::after {
            content: '';
            position: absolute;
            bottom: 2px;
            left: 50%;
            transform: translateX(-50%);
            width: 6px;
            height: 6px;
            background-color: var(--point-coral);
            border-radius: 50%;
        }

        /* Checkbox (Flat) */
        .custom-checkbox {
            appearance: none;
            width: 18px;
            height: 18px;
            border: 2px solid #BCAAA4;
            border-radius: 5px;
            cursor: pointer;
            position: relative;
            background-color: #fff;
            transition: all 0.2s;
        }
        .custom-checkbox:checked {
            background-color: var(--sage-green);
            border-color: var(--sage-green);
        }
        .custom-checkbox:checked::after {
            content: '✔';
            position: absolute;
            color: white;
            font-size: 11px;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        /* FAB (Flat) */
        .fab-house {
            background-color: #A5D6A7;
            clip-path: polygon(50% 0%, 100% 35%, 100% 100%, 0% 100%, 0% 35%);
            display: flex;
            align-items: flex-end;
            justify-content: center;
            padding-bottom: 8px;
        }
        
        /* Modals */
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .modal-content { animation: slideUp 0.3s ease-out; }
        .toast-enter { animation: slideUp 0.3s ease-out forwards; }

        .time-select {
            border: 1px solid #EFEBE9;
            border-radius: 8px;
            padding: 4px;
            font-size: 0.8rem;
            color: var(--wood-text);
            background-color: white;
            outline: none;
        }

        .mini-cal-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            text-align: center;
            font-size: 0.8rem;
        }
        .mini-cal-cell {
            padding: 6px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s;
        }
        .mini-cal-cell.selected {
            background-color: var(--sage-green);
            color: white;
            font-weight: bold;
        }
        .mini-cal-cell:hover:not(.selected) {
            background-color: #F1F8E9;
        }
        .modal-tab {
            padding: 8px;
            font-size: 0.9rem;
            color: #BCAAA4;
            border-bottom: 2px solid transparent;
            cursor: pointer;
        }
        .modal-tab.active {
            color: var(--wood-text);
            border-bottom: 2px solid var(--point-coral);
            font-weight: bold;
        }
    </style>
</head>
<body class="max-w-md mx-auto min-h-screen flex flex-col pb-28 relative bg-[#FDFCF5]">

    <!-- Header -->
    <div class="sticky-header-wrapper">
        <header class="px-6 pt-8 pb-2 flex justify-between items-center bg-[#FDFCF5]">
            <div class="flex items-center gap-2">
                <!-- House Icon -->
                <svg class="w-8 h-8 text-[#8D6E63]" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
                </svg>
                <h1 class="font-hand text-4xl text-[#5D4037] pt-1">zipipo planner</h1>
            </div>
            <div id="headerDate" class="font-hand text-lg text-[#A1887F]"></div>
        </header>

        <nav class="flex justify-around bg-[#FDFCF5] pb-2 border-b border-[#EFEBE9]">
            <button onclick="switchTab('home')" id="tab-home" class="flex-1 py-2 tab-btn tab-active">Home</button>
            <button onclick="switchTab('project')" id="tab-project" class="flex-1 py-2 tab-btn">Project</button>
            <button onclick="switchTab('achievement')" id="tab-achievement" class="flex-1 py-2 tab-btn">Achievement</button>
        </nav>
    </div>

    <!-- Main Content -->
    <main id="appContent" class="p-5 flex-1 space-y-6 overflow-y-auto"></main>

    <!-- Save Toast -->
    <div id="saveToast" class="fixed bottom-24 left-1/2 transform -translate-x-1/2 bg-[#5D4037] text-white text-xs px-4 py-2 rounded-full shadow-none opacity-0 transition-opacity duration-300 pointer-events-none z-50 bg-opacity-90 backdrop-blur-sm">
        저장됨 ✨
    </div>

    <!-- Loading Popup -->
    <div id="aiLoadingPopup" class="fixed inset-0 bg-black/20 z-[70] hidden flex items-center justify-center backdrop-blur-[2px]">
        <div class="bg-white p-8 rounded-3xl shadow-lg border-2 border-[#EFEBE9] max-w-xs w-full mx-4 text-center">
            <div class="mb-4 flex justify-center text-[#FF8A65]">
                <svg class="animate-spin h-8 w-8" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            </div>
            <div class="text-[#5D4037] font-hand text-2xl mb-1">
                zipipo가 만들고 있어요<span id="loadingDots" class="inline-block w-6 text-left"></span>
            </div>
            <div class="text-xs text-[#A1887F]">잠시만 기다려주세요 ✨</div>
        </div>
    </div>

    <!-- Footer -->
    <footer id="homeFooter" class="mt-auto py-8 text-center">
        <div class="flex justify-center gap-4 text-xs text-[#BCAAA4]">
            <button onclick="toggleApiKeyInput()" class="hover:text-[#8D6E63] font-hand text-lg flex items-center gap-1">
                <svg class="w-4 h-4 text-[#D7CCC8]" fill="currentColor" viewBox="0 0 24 24"><path d="M12.65 10C11.83 7.67 9.61 6 7 6c-3.31 0-6 2.69-6 6s2.69 6 6 6c2.61 0 4.83-1.67 5.65-4H17v4h4v-4h2v-4H12.65zM7 14c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z"/></svg>
                Key Setting
            </button>
        </div>
        <div id="apiKeyContainer" class="hidden mt-3 mx-8 p-4 bg-white border-2 border-[#EFEBE9] rounded-2xl">
            <input type="password" id="apiKeyInput" placeholder="API Key를 입력해주세요" 
                   class="w-full p-2 border-b border-[#D7CCC8] mb-3 text-sm bg-transparent focus:outline-none focus:border-[#8D6E63] text-center text-[#5D4037]">
            <button onclick="saveApiKey()" class="w-full bg-[#D7CCC8] text-white text-sm py-2 rounded-lg font-bold hover:bg-[#BCAAA4]">저장하기</button>
        </div>
    </footer>

    <!-- FAB -->
    <div class="fixed bottom-8 right-6 z-30">
        <button onclick="openGeneratorModal()" class="w-14 h-14 fab-house text-white hover:scale-105 transition active:scale-95 shadow-sm">
            <span class="text-2xl font-bold font-hand">+</span>
        </button>
    </div>

    <!-- Generator Modal -->
    <div id="generatorModal" class="fixed inset-0 bg-[#4E342E]/20 z-50 hidden flex items-end sm:items-center justify-center backdrop-blur-[1px]">
        <div class="bg-[#FDFCF5] w-full max-w-md p-6 rounded-t-3xl sm:rounded-3xl shadow-none border-2 border-[#EFEBE9] m-0 sm:m-4 wood-frame modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-hand text-2xl text-[#8D6E63]">일정 짓기</h3>
                <button onclick="closeModal('generatorModal')" class="text-[#BCAAA4] hover:text-[#8D6E63] text-xl">✕</button>
            </div>
            <div class="mb-3">
                <label class="text-xs text-[#A1887F] block mb-2">프로젝트 연동</label>
                <div id="projectMultiSelect" class="w-full max-h-32 overflow-y-auto border border-[#D7CCC8] rounded-xl bg-white p-2 space-y-1">
                    <div class="text-xs text-gray-400 italic text-center">프로젝트가 없습니다</div>
                </div>
            </div>
            <textarea id="taskPrompt" rows="3" class="w-full p-4 border-2 border-[#EFEBE9] rounded-xl mb-4 resize-none focus:outline-none focus:border-[#D7CCC8] bg-white text-sm placeholder-gray-300" placeholder="예: 공부 2시간 하고 산책하기"></textarea>
            <div class="flex gap-3 mb-3">
                <button onclick="generateSchedule('daily')" class="flex-1 py-3 bg-[#FFAB91] text-white font-bold rounded-xl hover:bg-[#FF8A65] transition shadow-sm text-sm">Daily</button>
                <button onclick="generateSchedule('weekly')" class="flex-1 py-3 bg-[#A5D6A7] text-white font-bold rounded-xl hover:bg-[#81C784] transition shadow-sm text-sm">Weekly</button>
            </div>
        </div>
    </div>

    <!-- Project Plan Edit Modal -->
    <div id="projectPlanModal" class="fixed inset-0 bg-[#4E342E]/20 z-50 hidden flex items-center justify-center backdrop-blur-[1px]">
        <div class="bg-[#FDFCF5] w-full max-w-md p-6 rounded-2xl shadow-none border-2 border-[#EFEBE9] m-4 wood-frame modal-content">
            <h3 class="font-hand text-xl text-[#8D6E63] mb-2">프로젝트 계획 짜기</h3>
            <p class="text-xs text-[#A1887F] mb-4">zipipo에게 요청할 내용을 확인하세요.</p>
            <textarea id="projectPlanPrompt" rows="5" class="w-full p-4 border-2 border-[#EFEBE9] rounded-xl mb-4 resize-none focus:outline-none focus:border-[#D7CCC8] bg-white text-sm text-[#5D4037]"></textarea>
            <div class="flex gap-3">
                <button onclick="closeModal('projectPlanModal')" class="flex-1 py-3 bg-gray-100 text-[#8D6E63] rounded-xl text-xs hover:bg-gray-200">취소</button>
                <button onclick="confirmProjectPlan()" class="flex-1 py-3 bg-[#8D6E63] text-white rounded-xl text-xs font-bold hover:bg-[#6D4C41]">계획 생성하기</button>
            </div>
        </div>
    </div>

    <!-- Task Edit/Add Modal -->
    <div id="addTaskModal" class="fixed inset-0 bg-black/20 z-[60] hidden flex items-center justify-center backdrop-blur-[1px]">
        <div class="bg-white p-6 rounded-2xl shadow-lg w-80 wood-frame modal-content text-center">
            <h3 id="taskModalTitle" class="font-hand text-xl text-[#8D6E63] mb-4">할 일 추가</h3>
            <input type="text" id="manualTaskText" class="w-full border-b-2 border-[#D7CCC8] p-2 mb-4 focus:outline-none text-center text-sm" placeholder="할 일 내용">
            <div id="dailyTimeInputWrapper" class="flex flex-col gap-3 mb-5">
                <div class="flex items-center justify-center gap-2">
                    <span class="text-xs text-[#A1887F] w-8">시작</span>
                    <select id="startHour" class="time-select"></select> : <select id="startMin" class="time-select"></select>
                </div>
                <div class="flex items-center justify-center gap-2">
                    <span class="text-xs text-[#A1887F] w-8">종료</span>
                    <select id="endHour" class="time-select"></select> : <select id="endMin" class="time-select"></select>
                </div>
            </div>
            <div id="weeklyDateInputWrapper" class="hidden mb-5">
                <label class="text-xs text-[#A1887F] block mb-2">수행할 날짜 (선택)</label>
                <input type="date" id="weeklyTaskDate" class="border border-[#EFEBE9] rounded p-2 text-sm text-[#5D4037] w-full bg-white">
            </div>
            <div class="flex gap-2 justify-center">
                <button onclick="closeModal('addTaskModal')" class="px-4 py-2 bg-gray-100 rounded-lg text-xs text-gray-500 hover:bg-gray-200">취소</button>
                <button onclick="confirmTaskAction()" class="px-4 py-2 bg-[#8D6E63] text-white rounded-lg text-xs font-bold hover:bg-[#6D4C41]">확인</button>
            </div>
        </div>
    </div>

    <!-- Project Input Modal -->
    <div id="projectInputModal" class="fixed inset-0 bg-black/20 z-[60] hidden flex items-center justify-center backdrop-blur-[1px]">
        <div class="bg-white p-6 rounded-2xl shadow-lg w-80 wood-frame modal-content">
            <h3 class="font-hand text-xl text-[#8D6E63] mb-4 text-center">새 프로젝트 심기</h3>
            <label class="text-xs text-[#A1887F] mb-1 block">프로젝트 이름</label>
            <input type="text" id="projTitle" class="w-full border-b-2 border-[#D7CCC8] p-2 mb-3 focus:outline-none text-center text-sm" placeholder="">
            <label class="text-xs text-[#A1887F] mb-1 block">내용</label>
            <textarea id="projDesc" class="w-full border-2 border-[#EFEBE9] rounded-xl p-2 mb-3 text-sm focus:outline-none focus:border-[#D7CCC8] resize-none" rows="2"></textarea>
            <div class="flex border-b border-[#EFEBE9] mb-3">
                <div onclick="switchProjMode('range')" id="pm-range" class="flex-1 text-center modal-tab active">기간 지정</div>
                <div onclick="switchProjMode('select')" id="pm-select" class="flex-1 text-center modal-tab">날짜 선택</div>
            </div>
            <div id="projModeRange">
                <div class="flex gap-2 mb-2">
                    <div class="flex-1">
                        <label class="text-xs text-[#A1887F] mb-1 block">시작일</label>
                        <input type="date" id="projStart" class="w-full border border-[#EFEBE9] rounded p-1 text-xs text-[#5D4037]">
                    </div>
                    <div class="flex-1">
                        <label class="text-xs text-[#A1887F] mb-1 block">종료일</label>
                        <input type="date" id="projEnd" class="w-full border border-[#EFEBE9] rounded p-1 text-xs text-[#5D4037]">
                    </div>
                </div>
            </div>
            <div id="projModeSelect" class="hidden">
                <div class="flex justify-between items-center mb-2 px-2">
                    <button onclick="moveProjCal(-1)" class="text-[#8D6E63]">◀</button>
                    <span id="projCalTitle" class="text-xs font-bold text-[#5D4037]"></span>
                    <button onclick="moveProjCal(1)" class="text-[#8D6E63]">▶</button>
                </div>
                <div class="mini-cal-grid mb-1" id="projCalGrid"></div>
                <div class="text-[10px] text-right text-[#8D6E63]"><span id="selectedCount">0</span>일 선택됨</div>
            </div>
            <div class="flex gap-2 justify-center mt-3">
                <button onclick="closeModal('projectInputModal')" class="px-4 py-2 bg-gray-100 rounded-lg text-xs text-gray-500 hover:bg-gray-200">취소</button>
                <button onclick="confirmCreateProject()" class="px-4 py-2 bg-[#556B2F] text-white rounded-lg text-xs font-bold hover:bg-[#33691E]">심기</button>
            </div>
        </div>
    </div>

    <!-- Simple Input Modal -->
    <div id="inputModal" class="fixed inset-0 bg-black/20 z-[60] hidden flex items-center justify-center backdrop-blur-[1px]">
        <div class="bg-white p-5 rounded-2xl shadow-lg w-80 wood-frame modal-content text-center">
            <h3 id="inputModalTitle" class="font-hand text-xl text-[#8D6E63] mb-3">입력</h3>
            <input type="text" id="inputModalField" class="w-full border-b-2 border-[#D7CCC8] p-2 mb-4 focus:outline-none text-center" placeholder="내용을 입력하세요">
            <div class="flex gap-2 justify-center">
                <button onclick="closeModal('inputModal')" class="px-4 py-2 bg-gray-200 rounded-lg text-xs text-gray-500">취소</button>
                <button onclick="confirmInput()" class="px-4 py-2 bg-[#8D6E63] text-white rounded-lg text-xs font-bold">확인</button>
            </div>
        </div>
    </div>

<!-- SCRIPT -->
<script>
    // 1. CONSTANTS & CONFIG
    const STORAGE_KEY_API = 'zipipo_v2_apikey';
    const STORAGE_KEY_DATA = 'zipipo_v2_data'; 
    const GEMINI_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent';
    
    const ICONS = {
        lightWood: `<svg class="w-6 h-6 inline-block mr-1" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M12 0V6" stroke="#D7CCC8" stroke-width="1.5"/><path d="M4 14C4 9.5 7.58 6 12 6C16.42 6 20 9.5 20 14H4Z" fill="#FFF8E1" stroke="#D7CCC8" stroke-width="1.5"/><path d="M10 14H14V15C14 15.55 13.55 16 13 16H11C10.45 16 10 15.55 10 15V14Z" fill="#D7CCC8" stroke="none"/></svg>`,
        check: `<svg class="w-4 h-4 text-[#8D6E63] hover:text-[#5D4037]" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"></path></svg>`,
        undo: `<svg class="w-4 h-4 text-[#8D6E63] hover:text-[#5D4037]" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"></path></svg>`,
        closeX: `<svg class="w-4 h-4 text-[#D7CCC8] hover:text-[#FF7F50]" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path></svg>`,
        edit: `<svg class="w-3 h-3 text-[#BCAAA4] hover:text-[#8D6E63]" fill="currentColor" viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>`,
        speech: `<svg class="w-4 h-4 text-[#BCAAA4] hover:text-[#8D6E63] transition" fill="currentColor" viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/></svg>`
    };

    // 2. STATE
    let appData = { daily: {}, weekly: {}, projects: [], dailySummaries: {} };
    let currentTab = 'home';
    let selectedDate = new Date().toISOString().split('T')[0]; // Default to today
    let currentWeekBaseDate = new Date();
    let achievementViewDate = new Date().toISOString().split('T')[0];
    let inputCallback = null;
    let editingTask = null;
    let activeProjectId = null;
    let projCalDate = new Date();
    let selectedProjDates = new Set();
    let projMode = 'range';
    let currentTaskTypeForAdd = 'daily'; 
    let loadingInterval;
    let calendarDate = new Date();

    // 3. HELPER FUNCTIONS
    function getTodayStr() { return new Date().toISOString().split('T')[0]; }
    function parseTasks(text) { return text.split('\n').map(l=>l.trim()).filter(l=>l.length>0 && !l.startsWith('---')); }
    function getWeekKey(d) { const date = new Date(d.getTime()); date.setHours(0,0,0,0); date.setDate(date.getDate() + 3 - (date.getDay() + 6) % 7); const week1 = new Date(date.getFullYear(), 0, 4); return 1 + Math.round(((date.getTime() - week1.getTime()) / 86400000 - 3 + (week1.getDay() + 6) % 7) / 7) + ''; }
    function getWeekRangeStr(d) { const curr = new Date(d); const first = curr.getDate() - curr.getDay(); const last = first + 6; const f = new Date(curr.setDate(first)); const l = new Date(curr.setDate(last)); return `${f.getMonth()+1}.${f.getDate()} ~ ${l.getMonth()+1}.${l.getDate()}`; }
    function formatTime(iso) { const d = new Date(iso); return `${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`; }
    function getSunday(d) { d = new Date(d); var day = d.getDay(); var diff = d.getDate() - day; return new Date(d.setDate(diff)); }
    function toggleApiKeyInput() { document.getElementById('apiKeyContainer').classList.toggle('hidden'); }
    function changeDate(v) { selectedDate = v; renderApp(); }
    function moveWeek(d) { currentWeekBaseDate.setDate(currentWeekBaseDate.getDate() + (d * 7)); renderApp(); }
    function moveMonth(d) { calendarDate.setMonth(calendarDate.getMonth() + d); renderApp(); }

    function initTimeSelects() {
        const hours = Array.from({length:24}, (_,i) => i.toString().padStart(2,'0'));
        const mins = ['00', '15', '30', '45'];
        ['startHour', 'endHour'].forEach(id => { const el = document.getElementById(id); if(el) el.innerHTML = '<option value="">--</option>' + hours.map(h => `<option value="${h}">${h}</option>`).join(''); });
        ['startMin', 'endMin'].forEach(id => { const el = document.getElementById(id); if(el) el.innerHTML = '<option value="">--</option>' + mins.map(m => `<option value="${m}">${m}</option>`).join(''); });
    }

    function showLoading(msg) {
        const p = document.getElementById('aiLoadingPopup');
        p.classList.remove('hidden');
        p.querySelector('.font-hand').childNodes[0].nodeValue = msg;
        let dots = 0;
        if(loadingInterval) clearInterval(loadingInterval);
        loadingInterval = setInterval(() => { dots = (dots+1)%4; document.getElementById('loadingDots').innerText = '.'.repeat(dots); }, 500);
    }
    function hideLoading() {
        document.getElementById('aiLoadingPopup').classList.add('hidden');
        if(loadingInterval) clearInterval(loadingInterval);
    }

    // 4. DATA MANAGEMENT
    function loadData() {
        const json = localStorage.getItem(STORAGE_KEY_DATA);
        if (json) {
            try { appData = JSON.parse(json); } catch(e) { console.error(e); }
        }
        if (!appData.daily) appData.daily = {};
        if (!appData.weekly) appData.weekly = {};
        if (!appData.projects) appData.projects = [];
        if (!appData.dailySummaries) appData.dailySummaries = {};
    }
    function saveData() {
        localStorage.setItem(STORAGE_KEY_DATA, JSON.stringify(appData));
        const toast = document.getElementById('saveToast');
        if(toast) { toast.style.opacity = '1'; setTimeout(() => { toast.style.opacity = '0'; }, 2000); }
    }
    function saveApiKey() {
        const key = document.getElementById('apiKeyInput').value.trim();
        if (key) { localStorage.setItem(STORAGE_KEY_API, key); toggleApiKeyInput(); alert('저장되었습니다.'); }
    }

    // 5. API CALL
    async function callGemini(prompt, cb) {
        const key = localStorage.getItem(STORAGE_KEY_API);
        if(!key) return alert('API Key가 필요합니다.');
        try {
            const res = await fetch(`${GEMINI_URL}?key=${key}`, {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }], generationConfig: { temperature: 0.7 } })
            });
            const data = await res.json();
            if(!res.ok) throw new Error(data.error?.message || 'API Error');
            cb(data.candidates[0].content.parts[0].text);
        } catch(e) { alert('오류: ' + e.message); hideLoading(); }
    }

    // 6. CORE LOGIC
    async function generateSchedule(type) {
        const key = localStorage.getItem(STORAGE_KEY_API);
        if(!key) return alert('API Key가 필요해요!');
        const promptText = document.getElementById('taskPrompt').value;
        if(!promptText) return alert('내용을 입력해주세요');
        showLoading("zipipo가 만들고 있어요"); 
        document.getElementById('generatorModal').classList.add('hidden');
        
        const todayStr = getTodayStr();
        const now = new Date();
        const currentTimeStr = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
        const isTargetToday = selectedDate === todayStr;
        const timeConstraint = isTargetToday ? `2. 현재 시각(${currentTimeStr}) 이후의 일정만 계획할 것.` : `2. 하루 전체 일정을 계획할 것.`;

        let sysPrompt = type === 'daily' 
            ? `역할: 플래너 (MBTI T). 날짜: ${selectedDate}. 요청: "${promptText}". [규칙] 1. 인사말 금지. ${timeConstraint} 3. 꿀팁 1~2문장. 4. 형식: 'HH:MM~HH:MM 할일'. 5. 마크다운 금지.`
            : `역할: 주간 플래너. 요청: "${promptText}". [규칙] 1. 인사말 금지. 2. 형식: 'YYYY-MM-DD: 할일'. 3. 한 줄에 하나씩.`;

        await callGemini(sysPrompt, (text) => {
            const lines = parseTasks(text);
            const newTasks = [];
            lines.forEach(line => {
                if (/\d{1,2}:\d{2}/.test(line)) newTasks.push({ text: line, done: false, isMessage: false });
                else if (/\d{4}-\d{2}-\d{2}/.test(line)) {
                    const dateMatch = line.match(/(\d{4}-\d{2}-\d{2})[:\s]*(.*)/);
                    if(dateMatch) newTasks.push({ text: dateMatch[2], done: false, isMessage: false, specificDate: dateMatch[1] });
                    else newTasks.push({ text: line, done: false, isMessage: false });
                } else if (line.length > 5 && !line.includes('|')) newTasks.push({ text: line, done: false, isMessage: true });
            });

            if (type === 'daily') {
                if(!appData.daily[selectedDate]) appData.daily[selectedDate] = [];
                appData.daily[selectedDate].push(...newTasks);
            } else {
                const wk = getWeekKey(currentWeekBaseDate); 
                if(!appData.weekly[wk]) appData.weekly[wk] = { tasks: [] };
                appData.weekly[wk].tasks.push(...newTasks.map(t => ({...t, isMessage: false})));
            }
            hideLoading(); saveData(); renderApp();
        });
    }

    async function generateProjectTasks(pid, ptitle) {
        const key = localStorage.getItem(STORAGE_KEY_API);
        if(!key) return alert('API Key가 필요해요!');
        const p = appData.projects.find(x => x.id === pid);
        const datesInfo = p.dateDisplay ? `기간: ${p.dateDisplay}` : '';
        const userPrompt = p.customPrompt || `프로젝트 '${ptitle}' 달성 계획.`;
        showLoading("zipipo가 만들고 있어요"); 
        const sysPrompt = `${userPrompt} ${datesInfo} [형식] ADVICE: (조언) PHASE: (단계) - (세부사항) ...`;
        await callGemini(sysPrompt, (text) => {
            const lines = parseTasks(text);
            const newTasks = [];
            lines.forEach(line => {
                line = line.trim();
                if(!line) return;
                if(line.startsWith('ADVICE:')) newTasks.push({ text: line.replace('ADVICE:', '').trim(), done: false, isAdvice: true });
                else if (line.startsWith('PHASE:')) newTasks.push({ text: line.replace('PHASE:', '').trim(), done: false, isPhase: true, isAdvice: false });
                else if (line.startsWith('-')) newTasks.push({ text: line.replace('-', '').trim(), done: false, isPhase: false, isAdvice: false });
                else if (line.toUpperCase().includes('PHASE')) newTasks.push({ text: line, done: false, isPhase: true, isAdvice: false });
                else newTasks.push({ text: line, done: false, isPhase: false, isAdvice: false });
            });
            const p = appData.projects.find(x => x.id === pid);
            if(p.tasks.length > 0 && confirm('덮어씌울까요?')) p.tasks = newTasks;
            else if(p.tasks.length === 0) p.tasks = newTasks;
            else p.tasks.push(...newTasks); 
            hideLoading(); saveData(); renderApp();
        });
    }

    async function generateDailySummary(dateStr) {
        const key = localStorage.getItem(STORAGE_KEY_API);
        if(!key) return alert('API Key가 필요해요!');
        const tasks = appData.daily[dateStr] || [];
        const completed = tasks.filter(t => t.done && !t.isMessage).map(t => t.text).join(', ');
        const feedbacks = tasks.filter(t => t.feedback).map(t => t.feedback).join(', ');
        if(!completed && !feedbacks) return alert('회고할 데이터가 없습니다.');
        showLoading("zipipo가 회고 중입니다"); 
        const sysPrompt = `날짜: ${dateStr}. 완료: ${completed}. 피드백: ${feedbacks}. 하루 3문장 요약 회고 (따뜻한 말투).`;
        await callGemini(sysPrompt, (text) => {
            if(!appData.dailySummaries) appData.dailySummaries = {};
            appData.dailySummaries[dateStr] = text;
            hideLoading(); saveData(); renderApp();
        });
    }

    function completeProject(id, isComplete) {
        const p = appData.projects.find(x => x.id === id);
        if (p) { p.completed = isComplete; saveData(); renderApp(); }
    }
    
    function deleteProject(id) {
        if(confirm('정말 삭제하시겠습니까?')) {
            appData.projects = appData.projects.filter(p=>p.id!==id);
            saveData(); renderApp();
        }
    }
    
    function deleteTaskItem(type, key, index) {
        if(type==='daily') appData.daily[key].splice(index,1);
        else if(type==='weekly') appData.weekly[key].tasks.splice(index,1);
        else appData.projects.find(p=>p.id===key).tasks.splice(index,1);
        saveData(); renderApp();
    }
    
    function updateTask(type, key, index, changes) {
        let targetArr;
        if(type==='daily') targetArr = appData.daily[key];
        else if(type==='weekly') targetArr = appData.weekly[key].tasks;
        else targetArr = appData.projects.find(p=>p.id===key).tasks;
        Object.assign(targetArr[index], changes);
        saveData(); renderApp();
    }

    // 7. Modals & Interaction
    function openProjectPlanModal(pid) {
        activeProjectId = pid;
        const p = appData.projects.find(x => x.id === pid);
        document.getElementById('projectPlanPrompt').value = p.customPrompt || (p.desc ? `프로젝트: ${p.title}\n목표: ${p.desc}\n\n위 내용을 바탕으로 구체적인 실행 계획을 짜줘.` : `프로젝트 '${p.title}' 달성 계획을 세워주세요.`);
        document.getElementById('projectPlanModal').classList.remove('hidden');
    }
    function closeProjectPlanModal() { closeModal('projectPlanModal'); activeProjectId = null; }
    
    async function confirmProjectPlan() {
        const promptVal = document.getElementById('projectPlanPrompt').value;
        if(!promptVal) return alert('요청 내용을 입력해주세요.');
        const p = appData.projects.find(x => x.id === activeProjectId);
        p.customPrompt = promptVal; 
        saveData(); closeProjectPlanModal();
        await generateProjectTasks(activeProjectId, p.title);
    }

    function openAddTaskModal(existingData, type) {
        currentTaskTypeForAdd = type || 'daily';
        if (existingData) { currentTaskTypeForAdd = existingData.type; }
        document.getElementById('addTaskModal').classList.remove('hidden');
        document.getElementById('taskModalTitle').innerText = existingData ? '수정' : (currentTaskTypeForAdd === 'weekly' ? '주간 할 일 추가' : '할 일 추가');
        document.getElementById('manualTaskText').value = '';
        ['startHour','startMin','endHour','endMin'].forEach(id => document.getElementById(id).value = '');
        document.getElementById('weeklyTaskDate').value = '';
        if (existingData) {
            editingTask = existingData;
            document.getElementById('manualTaskText').value = existingData.task.text;
            if (existingData.task.specificDate) { document.getElementById('weeklyTaskDate').value = existingData.task.specificDate; }
             if (existingData.task.manualTimeRange) {
                const parts = existingData.task.manualTimeRange.split('~');
                if (parts.length > 0) {
                    const start = parts[0].trim().split(':');
                    if (start.length === 2) { document.getElementById('startHour').value = start[0]; document.getElementById('startMin').value = start[1]; }
                }
                if (parts.length > 1) {
                    const end = parts[1].trim().split(' ')[0].split(':');
                     if (end.length === 2) { document.getElementById('endHour').value = end[0]; document.getElementById('endMin').value = end[1]; }
                }
            }
        } else { editingTask = null; document.getElementById('manualTaskText').focus(); }
        const dailyWrapper = document.getElementById('dailyTimeInputWrapper');
        const weeklyWrapper = document.getElementById('weeklyDateInputWrapper');
        if (currentTaskTypeForAdd === 'weekly') { dailyWrapper.classList.add('hidden'); weeklyWrapper.classList.remove('hidden'); } 
        else { dailyWrapper.classList.remove('hidden'); weeklyWrapper.classList.add('hidden'); }
    }
    
    function confirmTaskAction() {
        const text = document.getElementById('manualTaskText').value;
        if (!text) return alert('내용을 입력해주세요.');
        const sh = document.getElementById('startHour').value;
        const sm = document.getElementById('startMin').value;
        const eh = document.getElementById('endHour').value;
        const em = document.getElementById('endMin').value;
        let timeStr = null;
        if(sh && sm && eh && em) timeStr = `${sh}:${sm} ~ ${eh}:${em}`; else if(sh && sm) timeStr = `${sh}:${sm} ~`;
        const specificDate = document.getElementById('weeklyTaskDate').value;
        if (editingTask) {
            const changes = { text: text };
            if (currentTaskTypeForAdd === 'weekly') { changes.specificDate = specificDate; changes.manualTimeRange = null; } 
            else { changes.manualTimeRange = timeStr; changes.specificDate = null; }
            updateTask(editingTask.type, editingTask.key, editingTask.index, changes);
        } else {
            if (currentTaskTypeForAdd === 'weekly') {
                const wk = getWeekKey(new Date());
                if(!appData.weekly[wk]) appData.weekly[wk] = { tasks: [] };
                appData.weekly[wk].tasks.push({ text: text, done: false, manualTimeRange: null, specificDate: specificDate, feedback: null, isMessage: false });
            } else {
                if(!appData.daily[selectedDate]) appData.daily[selectedDate] = [];
                appData.daily[selectedDate].push({ text: text, done: false, manualTimeRange: timeStr, feedback: null, isMessage: false });
            }
            saveData(); renderApp();
        }
        closeModal('addTaskModal');
    }

    function openEditTimeModal(type, key, index, task) { openAddTaskModal({type, key, index, task}, type); }
    function openInputModal(title, cb) { document.getElementById('inputModalTitle').innerText = title; document.getElementById('inputModalField').value = ''; document.getElementById('inputModal').classList.remove('hidden'); document.getElementById('inputModalField').focus(); inputCallback = cb; }
    function closeInputModal() { document.getElementById('inputModal').classList.add('hidden'); inputCallback = null; }
    function confirmInput() { const val = document.getElementById('inputModalField').value; if(val && inputCallback) { inputCallback(val); closeInputModal(); } }
    
    function openProjectModal() {
        document.getElementById('projectInputModal').classList.remove('hidden');
        document.getElementById('projTitle').value = ''; document.getElementById('projDesc').value = ''; 
        document.getElementById('projStart').value = ''; document.getElementById('projEnd').value = '';
        projCalDate = new Date(); selectedProjDates = new Set(); switchProjMode('range');
    }
    function closeProjectModal() { document.getElementById('projectInputModal').classList.add('hidden'); }
    function switchProjMode(mode) {
        projMode = mode;
        if(mode==='range') { document.getElementById('projModeRange').classList.remove('hidden'); document.getElementById('projModeSelect').classList.add('hidden'); } 
        else { document.getElementById('projModeRange').classList.add('hidden'); document.getElementById('projModeSelect').classList.remove('hidden'); renderProjCal(); }
    }
    function renderProjCal() {
        const y = projCalDate.getFullYear(); const m = projCalDate.getMonth();
        document.getElementById('projCalTitle').innerText = `${y}.${m+1}`;
        const container = document.getElementById('projCalGrid'); container.innerHTML = '';
        const firstDay = new Date(y, m, 1).getDay(); const lastDate = new Date(y, m+1, 0).getDate();
        for(let i=0; i<firstDay; i++) container.innerHTML += `<div></div>`;
        for(let d=1; d<=lastDate; d++) {
            const dateStr = `${y}-${(m+1).toString().padStart(2,'0')}-${d.toString().padStart(2,'0')}`;
            const el = document.createElement('div'); el.className = 'mini-cal-cell';
            if(selectedProjDates.has(dateStr)) el.classList.add('selected');
            el.innerText = d;
            el.onclick = () => { if(selectedProjDates.has(dateStr)) selectedProjDates.delete(dateStr); else selectedProjDates.add(dateStr); renderProjCal(); document.getElementById('selectedCount').innerText = selectedProjDates.size; };
            container.appendChild(el);
        }
    }
    function moveProjCal(d) { projCalDate.setMonth(projCalDate.getMonth() + d); renderProjCal(); }
    
    function confirmCreateProject() {
        const title = document.getElementById('projTitle').value; const desc = document.getElementById('projDesc').value; 
        if(!title) return alert('프로젝트 이름을 입력해주세요');
        let dateDisplay = ''; let type = '';
        if(projMode === 'range') {
            const start = document.getElementById('projStart').value; const end = document.getElementById('projEnd').value;
            if(!start || !end) return alert('기간을 설정해주세요');
            dateDisplay = `${start} ~ ${end}`; type = 'range';
        } else {
            if(selectedProjDates.size === 0) return alert('날짜를 선택해주세요');
            const sorted = Array.from(selectedProjDates).sort();
            dateDisplay = `총 ${selectedProjDates.size}일 (${sorted[0]}...)`; type = 'select';
        }
        // Set to Array
        const dateArray = Array.from(selectedProjDates).sort();
        appData.projects.push({ id: Date.now()+'', title: title, desc: desc, dateDisplay: dateDisplay, dates: type === 'select' ? dateArray : null, tasks:[], completed: false });
        saveData(); renderApp(); closeModal('projectInputModal');
    }
    
    function openGeneratorModal() {
        document.getElementById('generatorModal').classList.remove('hidden');
        const container = document.getElementById('projectMultiSelect'); container.innerHTML = '';
        if (appData.projects.length === 0) { container.innerHTML = '<div class="text-xs text-gray-400 italic text-center p-2">생성된 프로젝트가 없습니다</div>'; } 
        else {
            appData.projects.forEach(p => {
                const label = document.createElement('label'); label.className = 'flex items-center gap-2 p-1 hover:bg-[#F5F5DC] rounded cursor-pointer';
                label.innerHTML = `<input type="checkbox" name="projSelect" value="${p.id}" class="custom-checkbox w-4 h-4"><span class="text-sm text-[#5D4037]">${p.title}</span>`;
                container.appendChild(label);
            });
        }
        document.getElementById('taskPrompt').value = '';
    }
    function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
    function addManualTask() { openAddTaskModal(null, 'daily'); }

    // 8. Rendering
    function renderHeader() {
        const today = new Date();
        const days = ['일요일', '월요일', '화요일', '수요일', '목요일', '금요일', '토요일'];
        document.getElementById('headerDate').textContent = `${today.getMonth()+1}월 ${today.getDate()}일 ${days[today.getDay()]}`;
    }

    function switchTab(tab) {
        currentTab = tab;
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('tab-active'));
        document.getElementById(`tab-${tab}`).classList.add('tab-active');
        renderApp();
    }

    function renderApp() {
        const container = document.getElementById('appContent');
        const footer = document.getElementById('homeFooter');
        container.innerHTML = '';
        if (currentTab === 'home') { renderHome(container); footer.classList.remove('hidden'); } 
        else { footer.classList.add('hidden'); 
            if (currentTab === 'achievement') renderCalendar(container);
            else if (currentTab === 'project') renderProjects(container);
        }
    }

    function renderHome(container) {
        const weekKey = getWeekKey(currentWeekBaseDate);
        const weeklyData = appData.weekly[weekKey] || { tasks: [] };
        
        const secWeekly = document.createElement('section');
        secWeekly.className = 'pillow-frame mb-5 bg-[#F1F8E9]'; 
        secWeekly.innerHTML = `
            <div class="px-6 pt-3 pb-2 flex items-center justify-between z-10 relative">
                <div class="flex items-center gap-1">${ICONS.lightWood} <span class="font-hand text-2xl text-[#5D4037]">Weekly</span></div>
                <div class="flex items-center gap-2">
                    <button onclick="window.moveWeek(-1)" class="text-gray-400 text-sm font-bold">&lt;</button>
                    <span class="text-xs text-[#BCAAA4] font-sans bg-white/80 px-2 rounded-full">${getWeekRangeStr(currentWeekBaseDate)}</span>
                    <button onclick="window.moveWeek(1)" class="text-gray-400 text-sm font-bold">&gt;</button>
                    <button onclick="window.openAddTaskModal(null, 'weekly')" class="w-6 h-6 rounded-full bg-white text-[#8D6E63] border border-[#D7CCC8] flex items-center justify-center font-bold text-sm ml-1 hover:bg-[#EFEBE9]">+</button>
                </div>
            </div>`;
        
        const weeklyMsgs = weeklyData.tasks.filter(t => t.isMessage);
        if (weeklyMsgs.length > 0) {
            secWeekly.innerHTML += `<div class="mx-6 mt-1 mb-3 p-3 bg-white/60 rounded-xl border border-[#C5E1A5] text-sm text-[#556B2F] relative z-10 font-wando leading-relaxed">${weeklyMsgs.map(m => m.text).join('<br>')}</div>`;
        }

        const contentWrap = document.createElement('div');
        contentWrap.className = 'px-6 pb-5 pt-1 relative z-10 flex flex-col gap-4'; 
        const currentSun = getSunday(currentWeekBaseDate);
        const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        for(let i=0; i<7; i++) {
            const d = new Date(currentSun);
            d.setDate(d.getDate() + i);
            const dayStr = d.toISOString().split('T')[0];
            const dayTasks = weeklyData.tasks.filter(t => !t.isMessage && t.specificDate === dayStr);
            
            const daySection = document.createElement('div');
            const isToday = dayStr === getTodayStr();
            const headerColor = i === 0 ? 'text-red-500' : 'text-[#8D6E63]';
            const headerBg = isToday ? 'bg-[#FFE0B2]' : 'bg-white/50';
            daySection.innerHTML = `<div class="flex items-center mb-1"><span class="${headerBg} px-2 py-0.5 rounded text-xs font-bold ${headerColor} font-sans">${dayNames[i]} ${d.getMonth()+1}.${d.getDate()}</span></div>`;
            
            if (dayTasks.length > 0) {
                const ul = document.createElement('ul');
                ul.className = 'pl-2 border-l-2 border-[#D7CCC8]/30 ml-2 space-y-2'; 
                dayTasks.forEach(t => {
                    const originalIdx = weeklyData.tasks.indexOf(t);
                    const taskEl = createTaskEl(t, 'weekly', weekKey, originalIdx);
                    taskEl.classList.add('weekly-item');
                    ul.appendChild(taskEl);
                });
                daySection.appendChild(ul);
            }
            contentWrap.appendChild(daySection);
        }
        
        const anytimeTasks = weeklyData.tasks.filter(t => !t.isMessage && !t.specificDate);
        if (anytimeTasks.length > 0) {
             const anytimeSection = document.createElement('div');
             anytimeSection.className = 'flex flex-col mt-2 pt-3 border-t border-dashed border-[#C5E1A5]';
             anytimeSection.innerHTML = `<div class="text-xs font-bold text-[#556B2F] mb-2 px-1">Anytime</div>`;
             const ul = document.createElement('ul');
             ul.className = 'pl-2 space-y-2';
             anytimeTasks.forEach(t => {
                const originalIdx = weeklyData.tasks.indexOf(t);
                const taskEl = createTaskEl(t, 'weekly', weekKey, originalIdx);
                taskEl.classList.add('weekly-item');
                ul.appendChild(taskEl);
             });
             anytimeSection.appendChild(ul);
             contentWrap.appendChild(anytimeSection);
        }
        
        secWeekly.appendChild(contentWrap);
        container.appendChild(secWeekly);

        // Daily Section
        const secDaily = document.createElement('section');
        secDaily.className = 'pillow-frame mb-6 bg-[#FFF3E0]'; 
        secDaily.innerHTML = `<div class="px-6 pt-3 pb-2 flex justify-between items-center z-10 relative"><div class="flex items-center gap-1">${ICONS.lightWood} <span class="font-hand text-2xl text-[#5D4037]">Daily</span></div><div class="flex items-center gap-2"><input type="date" value="${selectedDate}" onchange="window.changeDate(this.value)" class="text-xs border-0 rounded px-2 py-1 font-sans text-gray-500 bg-white/50 focus:outline-none"><button onclick="window.openAddTaskModal(null, 'daily')" class="w-6 h-6 rounded-full bg-white text-[#8D6E63] border border-[#D7CCC8] flex items-center justify-center font-bold text-sm ml-1 hover:bg-[#EFEBE9]">+</button></div></div>`;
        
        if(!appData.daily[selectedDate]) appData.daily[selectedDate] = [];
        const todayTasks = appData.daily[selectedDate];
        const dailyMessages = todayTasks.filter(t => t.isMessage);
        if (dailyMessages.length > 0) {
            secDaily.innerHTML += `<div class="mx-6 mt-2 mb-4 p-3 bg-white/60 rounded-xl border border-[#FFE0B2] text-sm text-[#5D4037] relative z-10 font-wando leading-relaxed">${dailyMessages.map(m => m.text).join('<br>')}</div>`;
        }
        
        const contentDaily = document.createElement('div');
        contentDaily.className = 'timeline-container px-6 pb-5 pt-1 relative z-10';
        contentDaily.innerHTML = `<div class="timeline-line"></div>`;
        const realDailyTasks = todayTasks.filter(t => !t.isMessage);
        if(realDailyTasks.length > 0) {
             const ulDaily = document.createElement('ul');
             realDailyTasks.sort((a,b) => (a.manualTimeRange || a.startTime || '') > (b.manualTimeRange || b.startTime || '') ? 1 : -1);
             realDailyTasks.forEach((t, i) => ulDaily.appendChild(createTaskEl(t, 'daily', selectedDate, i)));
             contentDaily.appendChild(ulDaily);
        } else {
             contentDaily.innerHTML = `<div class="empty-state"><span class="text-xs text-[#8D6E63] opacity-60">오늘의 목표를 세워보세요!</span></div>`;
        }
        secDaily.appendChild(contentDaily);
        container.appendChild(secDaily);
    }

    function renderProjects(container) {
        const secProj = document.createElement('section');
        secProj.innerHTML = `<h3 class="font-hand text-xl text-[#556B2F] mb-3 px-1 flex items-center gap-1">도전중인 프로젝트</h3>`;
        const addBtnContainer = document.createElement('div');
        addBtnContainer.className = 'mb-6';
        addBtnContainer.innerHTML = `<button onclick="window.openProjectModal()" class="w-full py-4 border-2 border-dashed border-[#A1887F] text-[#8D6E63] font-hand text-xl rounded-2xl hover:bg-[#FDFCF5] active:bg-[#D7CCC8] active:text-white transition bg-white shadow-none flex items-center justify-center gap-2"><span class="text-2xl">+</span> 새로운 프로젝트 심기</button>`;
        container.appendChild(addBtnContainer);
        const scrollDiv = document.createElement('div');
        scrollDiv.className = 'flex gap-3 overflow-x-auto pb-4 px-1';
        const activeProjects = appData.projects.filter(p => !p.completed);
        const completedProjects = appData.projects.filter(p => p.completed);
        if(activeProjects.length > 0) {
            activeProjects.forEach(p => {
                const card = document.createElement('div');
                card.className = 'min-w-[130px] wood-frame p-3 bg-white flex-shrink-0 border border-[#C5E1A5] relative group'; 
                card.innerHTML = `
                <div class="absolute top-2 right-2 flex gap-1 opacity-0 group-hover:opacity-100 transition z-10">
                    <button class="p-1 text-[#A1887F] hover:text-[#8D6E63]" onclick="window.completeProject('${p.id}', true)">${ICONS.check}</button>
                    <button class="p-1 text-[#D7CCC8] hover:text-[#FF7F50]" onclick="window.deleteProject('${p.id}')">${ICONS.closeX}</button>
                </div>
                <div class="text-xs text-[#33691E] font-bold mb-1 truncate pr-12 pt-1">${p.title}</div><div class="text-[9px] text-[#A1887F] mb-1 font-sans">${p.dateDisplay || ''}</div>`;
                const stages = p.tasks.filter(t => !t.isAdvice && !t.isPhase);
                const doneCnt = stages.filter(t=>t.done).length;
                const percent = stages.length ? (doneCnt/stages.length)*100 : 0;
                card.innerHTML += `<div class="w-full bg-[#F1F8E9] h-1.5 rounded-full mt-1 overflow-hidden"><div class="bg-[#8FBC8F] h-full" style="width:${percent}%"></div></div><div class="text-[10px] text-[#558B2F] font-sans text-right mt-1">${doneCnt}/${stages.length}</div>`;
                card.innerHTML += `<div class="flex justify-center items-center mt-2 border-t border-[#F1F8E9] pt-2"><button onclick="window.openProjectPlanModal('${p.id}')" class="text-[10px] bg-[#8D6E63] text-white px-2 py-0.5 rounded w-full hover:bg-[#6D4C41]">계획짜기</button></div>`;
                const ul = document.createElement('ul');
                ul.className = 'pl-1 space-y-2 mt-2';
                if(p.tasks.length === 0) ul.innerHTML = `<li class="text-xs text-gray-300 italic text-center py-2">zipipo에게 계획 요청</li>`;
                p.tasks.forEach((t, i) => {
                    if (t.isPhase) {
                         const li = document.createElement('li');
                         li.className = "mt-2 mb-1";
                         li.innerHTML = `<div class="bg-[#FFF3E0] text-[#E65100] text-xs font-bold px-2 py-1 rounded border border-[#FFCC80] shadow-sm">${t.text}</div>`;
                         ul.appendChild(li);
                    } else if (!t.isAdvice) { 
                        ul.appendChild(createTaskEl(t, 'project', p.id, i)); 
                    }
                });
                card.appendChild(ul);
                scrollDiv.appendChild(card);
            });
        } else { scrollDiv.innerHTML = `<div class="text-center text-[#BCAAA4] font-hand text-xl mt-4 w-full opacity-70">여기에 장기 목표를 심어보세요</div>`; }
        secProj.appendChild(scrollDiv);
        
        if (completedProjects.length > 0) {
            const completedSec = document.createElement('div');
            completedSec.className = 'mt-6 border-t-2 border-dashed border-[#EFEBE9] pt-4 px-1';
            completedSec.innerHTML = `<h4 class="font-hand text-lg text-[#8D6E63] mb-3 flex items-center gap-1"><span>완료된 프로젝트</span> <span class="text-xs bg-[#D7CCC8] text-white px-2 py-0.5 rounded-full font-sans">${completedProjects.length}</span></h4>`;
            const list = document.createElement('div');
            list.className = 'space-y-2';
            completedProjects.forEach(p => {
                 const item = document.createElement('div');
                 const titleRow = document.createElement('div');
                 titleRow.className = 'flex justify-between items-center p-3 bg-white rounded-xl border border-[#EFEBE9] cursor-pointer hover:bg-[#FAF8F5] transition shadow-sm';
                 titleRow.innerHTML = `<span class="text-sm text-[#5D4037] font-bold line-through decoration-2 decoration-[#D7CCC8]/50">${p.title}</span><span class="text-xs text-[#BCAAA4]">▼</span>`;
                 const detailDiv = document.createElement('div');
                 detailDiv.className = 'hidden mt-2 pl-3 pr-1 py-2 border-l-2 border-[#D7CCC8]/30 ml-2 bg-white/50 rounded-r-xl text-xs space-y-2';
                 detailDiv.innerHTML = `<button class="flex items-center gap-1 text-[#8D6E63] hover:text-[#5D4037] mb-2 text-[11px] font-bold" onclick="event.stopPropagation(); window.completeProject('${p.id}', false)">${ICONS.undo} 복구</button>`;
                 if (p.desc) detailDiv.innerHTML += `<div class="text-[#A1887F] mb-2">${p.desc}</div>`;
                 const taskList = document.createElement('ul');
                 taskList.className = 'pl-2 space-y-1 mt-2 border-t border-dashed border-[#EFEBE9] pt-2';
                 if(p.tasks.length > 0) {
                    p.tasks.forEach(t => {
                        if (!t.isPhase && !t.isAdvice) {
                            taskList.innerHTML += `<li class="text-xs text-[#5D4037] flex items-start gap-1"><span class="text-[#8D6E63]">•</span> ${t.text}</li>`;
                        }
                    });
                 }
                 detailDiv.appendChild(taskList);
                 titleRow.onclick = () => { detailDiv.classList.toggle('hidden'); };
                 item.append(titleRow, detailDiv);
                 list.appendChild(item);
            });
            completedSec.appendChild(list);
            secProj.appendChild(completedSec);
        }
        container.appendChild(secProj);
    }

    function renderCalendar(container) {
        const year = calendarDate.getFullYear();
        const month = calendarDate.getMonth();
        const wrapper = document.createElement('div');
        wrapper.className = 'wood-frame p-5 bg-white min-h-[400px] flex flex-col';
        wrapper.innerHTML = `<div class="flex justify-between items-center mb-6"><button onclick="window.moveMonth(-1)" class="text-[#8D6E63] hover:text-[#FF7F50] text-xl font-bold px-2">◀</button><h2 class="font-hand text-2xl text-[#5D4037]">${year}년 ${month+1}월</h2><button onclick="window.moveMonth(1)" class="text-[#8D6E63] hover:text-[#FF7F50] text-xl font-bold px-2">▶</button></div>`;
        const grid = document.createElement('div');
        grid.className = 'grid grid-cols-7 gap-y-4 gap-x-1 text-center text-sm mb-6';
        ['일','월','화','수','목','금','토'].forEach(d => grid.innerHTML += `<div class="font-bold text-[#A1887F] text-xs pb-2">${d}</div>`);
        const firstDay = new Date(year, month, 1).getDay();
        const lastDate = new Date(year, month + 1, 0).getDate();
        for(let i=0; i<firstDay; i++) grid.innerHTML += `<div></div>`;
        for(let d=1; d<=lastDate; d++) {
            const dateStr = `${year}-${(month+1).toString().padStart(2,'0')}-${d.toString().padStart(2,'0')}`;
            const tasks = appData.daily[dateStr] || [];
            let percent = 0;
            if(tasks.length > 0) {
                const doneCount = tasks.filter(t => t.done).length;
                percent = (doneCount / tasks.length) * 100;
            }
            const bgStyle = tasks.length > 0 ? `background: linear-gradient(to top, #8FBC8F ${percent}%, transparent ${percent}%);` : '';
            const isSelected = dateStr === achievementViewDate;
            const borderClass = isSelected ? 'border-2 border-[#FF8A65] shadow-md scale-110' : (dateStr === getTodayStr() ? 'border border-[#8D6E63]' : '');
            const dayEl = document.createElement('div');
            dayEl.className = `${borderClass} w-8 h-8 rounded-full flex items-center justify-center mx-auto transition text-xs cursor-pointer hover:scale-110`;
            if (bgStyle) {
                dayEl.setAttribute('style', bgStyle);
                if (percent > 50) dayEl.classList.add('text-white', 'text-shadow'); else dayEl.classList.add('text-[#5D4037]');
            } else { dayEl.classList.add('text-gray-400'); }
            dayEl.innerText = d;
            dayEl.onclick = () => { achievementViewDate = dateStr; renderApp(); };
            grid.appendChild(dayEl);
        }
        wrapper.appendChild(grid);
        const tasks = appData.daily[achievementViewDate] || [];
        const completedTasks = tasks.filter(t => t.done && !t.isMessage);
        const summary = appData.dailySummaries[achievementViewDate]; 
        const fbSection = document.createElement('div');
        fbSection.className = 'mt-auto pt-4 border-t border-[#EFEBE9]';
        let detailsHtml = `<h3 class="font-hand text-lg text-[#5D4037] mb-2 border-b border-[#EFEBE9] pb-1">${achievementViewDate}</h3>`;
        if (summary) {
            detailsHtml += `<div class="mb-4 p-3 bg-[#F1F8E9] rounded-xl text-xs text-[#33691E] leading-relaxed font-wando border border-[#AED581]"><div class="font-bold mb-1">✨ zipipo 회고 요약</div>${summary}</div>`;
        } else if (completedTasks.length > 0) {
             detailsHtml += `<button onclick="window.generateDailySummary('${achievementViewDate}')" class="w-full mb-4 py-2 bg-white border border-[#D7CCC8] text-[#8D6E63] rounded-xl text-xs hover:bg-[#FDFCF5] transition flex items-center justify-center gap-1"><span>✨ zipipo 회고 정리</span></button>`;
        }
        detailsHtml += `<ul class="space-y-2 mb-4">`;
        if(completedTasks.length === 0) detailsHtml += `<li class="text-xs text-[#BCAAA4] italic text-center">완료된 일정이 없어요.</li>`;
        else {
            completedTasks.forEach(t => {
                let cleanText = t.text.replace(/\(.*\)/, '').trim();
                detailsHtml += `<li class="text-xs flex gap-2 items-start text-[#5D4037]"><span class="w-1.5 h-1.5 rounded-full bg-[#A1887F] mt-1.5"></span> ${cleanText}</li>`;
            });
        }
        detailsHtml += `</ul>`;
        fbSection.innerHTML = detailsHtml;
        wrapper.appendChild(fbSection);
        container.appendChild(wrapper);
    }

    function createTaskEl(task, type, key, index) {
        const li = document.createElement('li');
        li.className = 'timeline-container flex flex-col mb-4'; 
        if(type === 'weekly') li.classList.add('weekly-item');

        const dot = document.createElement('div');
        dot.className = 'timeline-dot';
        li.appendChild(dot);
        const line = document.createElement('div');
        line.className = 'timeline-line';
        li.appendChild(line);
        const content = document.createElement('div');
        content.className = 'flex items-start justify-between w-full pl-2';
        const textGroup = document.createElement('div');
        textGroup.className = 'flex flex-col flex-1 mr-2';
        let timeStr = "";
        if(task.manualTimeRange) timeStr = task.manualTimeRange;
        else if(task.startTime && task.endTime) {
            const diff = Math.round((new Date(task.endTime)-new Date(task.startTime))/60000);
            timeStr = `${formatTime(task.startTime)}~${formatTime(task.endTime)} (${diff}m)`;
        }
        if(timeStr) {
            const timeSpan = document.createElement('button');
            timeSpan.className = 'text-[10px] text-[#A1887F] font-bold mb-0.5 text-left hover:text-[#FF8A65]';
            timeSpan.textContent = timeStr.replace('⏰ ', ''); 
            timeSpan.onclick = () => window.openEditTimeModal(type, key, index, task); 
            textGroup.appendChild(timeSpan);
        }
        let displayText = task.text;
        const txtSpan = document.createElement('span');
        txtSpan.className = `text-sm ${task.done ? 'text-gray-400 line-through' : 'text-[#4E342E]'}`;
        txtSpan.textContent = displayText;
        textGroup.appendChild(txtSpan);
        if(task.feedback) {
            const fbDiv = document.createElement('div');
            fbDiv.className = 'text-[11px] text-[#556B2F] mt-1 bg-[#F1F8E9] p-1.5 rounded inline-block';
            fbDiv.innerHTML = `└ ${task.feedback}`;
            textGroup.appendChild(fbDiv);
        }
        content.appendChild(textGroup);
        const actionGroup = document.createElement('div');
        actionGroup.className = 'flex items-center gap-2 shrink-0 h-6 mt-1';
        const editBtn = document.createElement('button');
        editBtn.innerHTML = ICONS.edit;
        editBtn.onclick = () => window.openEditTimeModal(type, key, index, task);
        actionGroup.appendChild(editBtn);
        const fbBtn = document.createElement('button');
        fbBtn.innerHTML = ICONS.speech;
        fbBtn.onclick = () => window.openInputModal('피드백을 남겨주세요', (val) => window.updateTask(type, key, index, {feedback: val}));
        actionGroup.appendChild(fbBtn);
        const chk = document.createElement('input');
        chk.type = 'checkbox';
        chk.className = 'custom-checkbox';
        chk.checked = task.done;
        chk.onchange = () => window.updateTask(type, key, index, {done: chk.checked});
        actionGroup.appendChild(chk);
        content.appendChild(actionGroup);
        li.appendChild(content);
        
        if(type === 'daily') {
             const timerRow = document.createElement('div');
             timerRow.className = 'flex items-center gap-2 mt-2 pl-2';
             if(!task.actualStartTime) {
                const btn = document.createElement('button');
                btn.className = 'font-hand text-sm text-[#A1887F] hover:text-[#FF8A65] border border-[#D7CCC8] px-2 py-0.5 rounded-full bg-white';
                btn.textContent = 'start !';
                btn.onclick = () => window.updateTask(type, key, index, {actualStartTime: new Date().toISOString()});
                timerRow.appendChild(btn);
             } else if (!task.actualEndTime) {
                const btn = document.createElement('button');
                btn.className = 'font-hand text-sm text-white bg-[#FFAB91] hover:bg-[#FF8A65] px-2 py-0.5 rounded-full';
                btn.textContent = 'stop !';
                btn.onclick = () => window.updateTask(type, key, index, {actualEndTime: new Date().toISOString()});
                timerRow.appendChild(btn);
             } else {
                 const diff = Math.round((new Date(task.actualEndTime)-new Date(task.actualStartTime))/60000);
                 const recTime = document.createElement('button');
                 recTime.className = 'font-hand text-xs text-[#8D6E63] ml-1 hover:underline';
                 recTime.textContent = `${formatTime(task.actualStartTime)}~${formatTime(task.actualEndTime)} (${diff}m)`;
                 recTime.onclick = () => { if(confirm('기록을 초기화할까요?')) window.updateTask(type, key, index, {actualStartTime: null, actualEndTime: null}); };
                 timerRow.appendChild(recTime);
             }
             const delBtn = document.createElement('button');
             delBtn.innerHTML = '✕';
             delBtn.className = 'text-[10px] text-[#D7CCC8] hover:text-[#FF8A65] ml-auto mr-1';
             delBtn.onclick = () => window.deleteTaskItem(type, key, index);
             timerRow.appendChild(delBtn);
             li.appendChild(timerRow);
        } else {
            const delBtn = document.createElement('button');
            delBtn.innerHTML = '✕';
            delBtn.className = 'text-[10px] text-[#D7CCC8] hover:text-[#FF8A65] self-end mr-1 mt-1';
            delBtn.onclick = () => window.deleteTaskItem(type, key, index);
            li.appendChild(delBtn);
        }
        return li;
    }

    // --- Global Exports ---
    window.toggleApiKeyInput = toggleApiKeyInput;
    window.saveApiKey = saveApiKey;
    window.openGeneratorModal = openGeneratorModal;
    window.closeModal = (id) => document.getElementById(id).classList.add('hidden');
    window.generateSchedule = generateSchedule;
    window.openAddTaskModal = openAddTaskModal;
    window.closeAddTaskModal = () => closeModal('addTaskModal');
    window.confirmTaskAction = confirmTaskAction;
    window.openProjectModal = openProjectModal;
    window.closeProjectModal = () => closeModal('projectInputModal');
    window.switchProjMode = switchProjMode;
    window.confirmCreateProject = confirmCreateProject;
    window.moveProjCal = moveProjCal;
    window.openInputModal = openInputModal;
    window.closeInputModal = closeInputModal;
    window.confirmInput = confirmInput;
    window.switchTab = switchTab;
    window.moveMonth = moveMonth;
    window.generateProjectTasks = generateProjectTasks;
    window.deleteProject = deleteProject;
    window.addManualTask = addManualTask;
    window.changeDate = changeDate;
    window.generateDailySummary = generateDailySummary;
    window.openProjectPlanModal = openProjectPlanModal;
    window.closeProjectPlanModal = () => closeModal('projectPlanModal');
    window.confirmProjectPlan = confirmProjectPlan;
    window.completeProject = completeProject;
    window.moveWeek = moveWeek;
    window.openEditTimeModal = openEditTimeModal;
    window.updateTask = updateTask;
    window.deleteTaskItem = deleteTaskItem;

    // --- Init ---
    renderHeader();
    initTimeSelects();
    loadData(); 
    renderApp();

    const savedKey = localStorage.getItem(STORAGE_KEY_API);
    if(savedKey) document.getElementById('apiKeyInput').value = savedKey;

</script>
</body>
</html>