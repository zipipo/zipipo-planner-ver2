<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>zipipo planner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Gowun+Dodum&family=Kirang+Haerang&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-ivory: #FDFCF5;
            --wood-frame: #A1887F;
            --wood-text: #5D4037;
            --sage-green: #8FBC8F;
            --point-coral: #FF8A65;
        }
        @font-face {
            font-family: 'S-CoreDream';
            src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_six@1.2/S-CoreDream-3Light.woff') format('woff');
            font-weight: normal; font-style: normal;
        }
        body, button, input, textarea, select { font-family: 'Gowun Dodum', sans-serif !important; color: var(--wood-text); -webkit-tap-highlight-color: transparent; }
        .font-hand { font-family: 'Kirang Haerang', cursive !important; }
        .font-wando { font-family: 'S-CoreDream', sans-serif !important; } 
        body { background-color: var(--bg-ivory); }
        .sticky-header-wrapper { position: sticky; top: 0; z-index: 40; background-color: var(--bg-ivory); border-bottom: 1px solid #EFEBE9; padding-top: env(safe-area-inset-top); }
        .timeline-container { position: relative; padding-left: 20px; padding-bottom: 10px; }
        .timeline-line { position: absolute; left: 7px; top: 10px; bottom: -10px; width: 2px; background-color: var(--wood-text); opacity: 0.2; border-radius: 2px; }
        .timeline-container:last-child .timeline-line { display: none; }
        .timeline-dot { position: absolute; left: 4px; top: 7px; width: 8px; height: 8px; background-color: var(--wood-text); border-radius: 50%; z-index: 2; }
        .weekly-item .timeline-line { display: none !important; }
        .weekly-item .timeline-dot { width: 5px; height: 5px; left: 6px; top: 9px; background-color: var(--sage-green); }
        .weekly-item.timeline-container { padding-left: 18px; }
        .empty-state { display: flex; align-items: center; justify-content: center; padding: 2rem 0; text-align: center; width: 100%; }
        .wood-frame { border: 2px solid var(--wood-frame); border-radius: 16px; background: white; }
        .tab-btn { font-family: 'Kirang Haerang', cursive !important; font-size: 1.3rem; color: #D7CCC8; transition: color 0.2s; }
        .tab-active { color: var(--wood-text); position: relative; }
        .tab-active::after { content: ''; position: absolute; bottom: 2px; left: 50%; transform: translateX(-50%); width: 6px; height: 6px; background-color: var(--point-coral); border-radius: 50%; }
        .custom-checkbox { appearance: none; width: 18px; height: 18px; border: 2px solid #BCAAA4; border-radius: 5px; cursor: pointer; position: relative; background-color: #fff; transition: all 0.2s; flex-shrink: 0; }
        .custom-checkbox:checked { background-color: var(--sage-green); border-color: var(--sage-green); }
        .custom-checkbox:checked::after { display: none; }
        .fab-house { background-color: #A5D6A7; clip-path: polygon(50% 0%, 100% 35%, 100% 100%, 0% 100%, 0% 35%); display: flex; align-items: flex-end; justify-content: center; padding-bottom: 8px; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .modal-content { animation: slideUp 0.3s ease-out; }
        .time-select { border: 1px solid #EFEBE9; border-radius: 8px; padding: 4px; font-size: 0.8rem; color: var(--wood-text); background-color: white; outline: none; }
        .mini-cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; text-align: center; font-size: 0.8rem; }
        .mini-cal-cell { padding: 6px; border-radius: 50%; cursor: pointer; transition: all 0.2s; }
        .mini-cal-cell.selected { background-color: var(--sage-green); color: white; font-weight: bold; }
        .modal-tab { padding: 8px; font-size: 0.9rem; color: #BCAAA4; border-bottom: 2px solid transparent; cursor: pointer; }
        .modal-tab.active { color: var(--wood-text); border-bottom: 2px solid var(--point-coral); font-weight: bold; }
        .task-time-label { font-size: 0.7rem; color: #BCAAA4; margin-bottom: -2px; display: block; }
        .proj-date-header { font-size: 0.8rem; font-weight: bold; color: #556B2F; background-color: #F1F8E9; padding: 4px 10px; border-radius: 8px; display: inline-block; margin-bottom: 6px; margin-top: 12px; border: 1px solid #DCEDC8; }
        .proj-tip-box { background-color: #FFF8E1; border: 1px solid #FFE0B2; border-radius: 12px; padding: 10px; margin-top: 10px; margin-bottom: 12px; font-size: 0.8rem; color: #E65100; line-height: 1.5; transition: max-height 0.3s ease; overflow: hidden; max-height: 300px; }
        .proj-tip-box.collapsed { max-height: 32px; cursor: pointer; }
        .proj-tip-label { font-weight: bold; font-size: 0.7rem; color: #FFB74D; display: inline-block; margin-right: 5px; }
        .task-depth-1 { margin-left: 1rem; }
        .task-depth-2 { margin-left: 2rem; }
        .proj-msg-box { font-size: 0.8rem; color: #795548; background-color: #EFEBE9; padding: 6px 10px; border-radius: 8px; margin-bottom: 4px; font-weight: bold; }
        .proj-memo-area { width: 100%; background-color: #FDFCF5; border: 1px solid #D7CCC8; border-radius: 12px; padding: 10px; font-size: 0.8rem; color: #5D4037; resize: none; margin-top: 10px; outline: none; transition: border-color 0.2s; }
        .proj-memo-area:focus { border-color: #8D6E63; }
        .todo-item.completed .todo-text { text-decoration: line-through; color: #BCAAA4; }
        .timer-popup { background-color: #FFF9C4; border: 4px solid #FFF176; color: #5D4037; transition: background-color 0.3s; z-index: 100 !important; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .timer-over { background-color: #FFCCBC; border-color: #FFAB91; animation: pulseRed 2s infinite; }
        @keyframes pulseRed { 0% {box-shadow: 0 0 0 0 rgba(255, 171, 145, 0.7);} 70% {box-shadow: 0 0 0 10px rgba(255, 171, 145, 0);} 100% {box-shadow: 0 0 0 0 rgba(255, 171, 145, 0);} }
        .fb-btn { width: 48px; height: 48px; border-radius: 50%; font-weight: bold; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; transition: transform 0.1s; }
        .fb-btn:active { transform: scale(0.95); }
        .fb-btn-o { background: #F1F8E9; border: 2px solid #AED581; color: #33691E; }
        .fb-btn-tri { background: #FFF8E1; border: 2px solid #FFD54F; color: #F57F17; }
        .fb-btn-x { background: #FBE9E7; border: 2px solid #FFAB91; color: #D84315; }
        .fb-btn.selected { transform: scale(1.1); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .proj-past-dates { display: none; }
        .proj-past-dates.show { display: block; animation: slideDown 0.3s ease-out; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .task-group-border { border-left: 4px solid; padding-left: 8px; background-color: rgba(255,255,255,0.5); }
    </style>
</head>
<body class="max-w-md mx-auto min-h-screen flex flex-col pb-28 relative bg-[#FDFCF5]">

    <div class="sticky-header-wrapper">
        <header class="px-6 pt-8 pb-2 flex justify-between items-center bg-[#FDFCF5]">
            <div class="flex items-center gap-2">
                <svg class="w-8 h-8 text-[#8D6E63]" fill="currentColor" viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
                <h1 class="font-hand text-4xl text-[#5D4037] pt-1">zipipo planner</h1>
            </div>
            <div id="headerDate" class="font-hand text-lg text-[#A1887F]"></div>
        </header>

        <nav class="flex justify-around bg-[#FDFCF5] pb-2 border-b border-[#EFEBE9]">
            <button onclick="switchTab('home')" id="tab-home" class="flex-1 py-2 tab-btn tab-active">Home</button>
            <button onclick="switchTab('project')" id="tab-project" class="flex-1 py-2 tab-btn">Project</button>
            <button onclick="switchTab('achievement')" id="tab-achievement" class="flex-1 py-2 tab-btn">Achievement</button>
        </nav>
    </div>

    <main id="appContent" class="p-5 flex-1 space-y-6 overflow-y-auto"></main>
    <div id="saveToast" class="fixed bottom-24 left-1/2 transform -translate-x-1/2 bg-[#5D4037] text-white text-xs px-4 py-2 rounded-full shadow-none opacity-0 transition-opacity duration-300 pointer-events-none z-50 bg-opacity-90 backdrop-blur-sm">ì €ì¥ë¨</div>

    <div id="aiLoadingPopup" class="fixed inset-0 bg-black/10 z-[70] hidden flex items-center justify-center backdrop-blur-[1px]">
        <div class="bg-white px-8 py-6 rounded-3xl shadow-lg border-2 border-[#EFEBE9] w-[280px] mx-4 text-center">
            <div class="text-[#5D4037] font-hand text-xl mb-1 whitespace-nowrap">zipipoê°€ ë§Œë“¤ê³  ìˆì–´ìš”<span id="loadingDots" class="inline-block w-6 text-left"></span></div>
            <div class="text-[10px] text-[#A1887F]">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”</div>
        </div>
    </div>

    <footer id="homeFooter" class="mt-auto py-8 text-center">
        <div class="flex justify-center gap-4 text-xs text-[#BCAAA4]">
            <button onclick="toggleApiKeyInput()" class="hover:text-[#8D6E63] font-hand text-lg flex items-center gap-1">Key Setting</button>
        </div>
        <div id="apiKeyContainer" class="hidden mt-3 mx-8 p-4 bg-white border-2 border-[#EFEBE9] rounded-2xl">
            <input type="password" id="apiKeyInput" placeholder="API Key ì…ë ¥" class="w-full p-2 border-b border-[#D7CCC8] mb-3 text-sm bg-transparent focus:outline-none text-center text-[#5D4037]">
            <button onclick="saveApiKey()" class="w-full bg-[#D7CCC8] text-white text-sm py-2 rounded-lg font-bold hover:bg-[#BCAAA4]">ì €ì¥í•˜ê¸°</button>
        </div>
    </footer>

    <div class="fixed bottom-8 right-6 z-30">
        <button onclick="openGeneratorModal('new')" class="w-14 h-14 fab-house text-white hover:scale-105 transition active:scale-95 shadow-sm">
            <span class="text-2xl font-bold font-hand">+</span>
        </button>
    </div>

    <div id="generatorModal" class="fixed inset-0 bg-[#4E342E]/20 z-50 hidden flex items-end sm:items-center justify-center backdrop-blur-[1px]">
        <div class="bg-[#FDFCF5] w-full max-w-md p-6 rounded-t-3xl sm:rounded-3xl shadow-none border-2 border-[#EFEBE9] m-0 sm:m-4 wood-frame modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-hand text-2xl text-[#8D6E63]">ì¼ì • ì§“ê¸°</h3>
                <button onclick="closeModal('generatorModal')" class="text-[#BCAAA4] hover:text-[#8D6E63] text-xl">âœ•</button>
            </div>
            <div class="flex justify-end mb-2 gap-2">
                <button onclick="linkWeeklyTasks()" class="text-[11px] bg-[#F1F8E9] text-[#556B2F] px-3 py-1.5 rounded-full border border-[#DCEDC8] hover:bg-[#AED581] hover:text-white transition flex items-center gap-1 font-bold">@ Weeklyë‘ ì—®ê¸°</button>
            </div>
            <textarea id="taskPrompt" rows="3" class="w-full p-4 border-2 border-[#EFEBE9] rounded-xl mb-3 resize-none focus:outline-none focus:border-[#D7CCC8] bg-white text-sm placeholder-gray-300" placeholder="ì˜ˆ: ê³µë¶€ 2ì‹œê°„ í•˜ê³  ì‚°ì±…í•˜ê¸°"></textarea>
            <div class="flex gap-3 mb-3">
                <button onclick="generateSchedule('daily')" class="flex-1 py-3 bg-[#FFAB91] text-white font-bold rounded-xl hover:bg-[#FF8A65] transition shadow-sm text-sm">Daily</button>
                <button onclick="generateSchedule('weekly')" class="flex-1 py-3 bg-[#A5D6A7] text-white font-bold rounded-xl hover:bg-[#81C784] transition shadow-sm text-sm">Weekly</button>
            </div>
        </div>
    </div>

    <div id="routineModal" class="fixed inset-0 bg-[#4E342E]/20 z-50 hidden flex items-center justify-center backdrop-blur-[1px]">
        <div class="bg-[#FDFCF5] w-full max-w-md p-6 rounded-2xl shadow-none border-2 border-[#EFEBE9] m-4 wood-frame modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-hand text-xl text-[#8D6E63]">ë£¨í‹´ ê´€ë¦¬</h3>
                <button onclick="closeModal('routineModal')" class="text-[#BCAAA4] hover:text-[#8D6E63] text-xl">âœ•</button>
            </div>
            <div class="flex gap-2 mb-4">
                <input type="text" id="newRoutineInput" class="flex-1 border-b-2 border-[#D7CCC8] p-1 text-sm focus:outline-none bg-transparent" placeholder="ìƒˆ ë£¨í‹´ (ì˜ˆ: ğŸ§˜ ìŠ¤íŠ¸ë ˆì¹­)">
                <button onclick="addRoutine()" class="bg-[#D7CCC8] text-white px-3 py-1 rounded-lg text-xs font-bold hover:bg-[#A1887F]">+</button>
            </div>
            <div id="routineList" class="max-h-60 overflow-y-auto space-y-2"></div>
        </div>
    </div>

    <div id="projectPlanModal" class="fixed inset-0 bg-[#4E342E]/20 z-50 hidden flex items-center justify-center backdrop-blur-[1px]">
        <div class="bg-[#FDFCF5] w-full max-w-md p-6 rounded-2xl shadow-none border-2 border-[#EFEBE9] m-4 wood-frame modal-content">
            <h3 class="font-hand text-xl text-[#8D6E63] mb-2">í”„ë¡œì íŠ¸ ê³„íš ì§œê¸°</h3>
            <p class="text-xs text-[#A1887F] mb-4">êµ¬ì²´ì ì¸ ì‹¤í–‰ ê³„íšì„ ìš”ì²­í•˜ì„¸ìš”.</p>
            <textarea id="projectPlanPrompt" rows="6" class="w-full p-4 border-2 border-[#EFEBE9] rounded-xl mb-4 resize-none focus:outline-none focus:border-[#D7CCC8] bg-white text-sm text-[#5D4037] leading-relaxed"></textarea>
            <div class="flex gap-3">
                <button onclick="closeModal('projectPlanModal')" class="flex-1 py-3 bg-gray-100 text-[#8D6E63] rounded-xl text-xs hover:bg-gray-200">ì·¨ì†Œ</button>
                <button onclick="confirmProjectPlan()" class="flex-1 py-3 bg-[#8D6E63] text-white rounded-xl text-xs font-bold hover:bg-[#6D4C41]">ê³„íš ìƒì„±í•˜ê¸°</button>
            </div>
        </div>
    </div>

    <div id="addTaskModal" class="fixed inset-0 bg-black/20 z-[60] hidden flex items-center justify-center backdrop-blur-[1px]">
        <div class="bg-white p-6 rounded-2xl shadow-lg w-80 wood-frame modal-content text-center">
            <h3 id="taskModalTitle" class="font-hand text-xl text-[#8D6E63] mb-4">í•  ì¼ ì¶”ê°€</h3>
            <input type="text" id="manualTaskText" class="w-full border-b-2 border-[#D7CCC8] p-2 mb-4 focus:outline-none text-center text-sm" placeholder="í•  ì¼ ë‚´ìš©">
            <div id="dailyTimeInputWrapper" class="flex flex-col gap-3 mb-5">
                <div class="flex items-center justify-center gap-2">
                    <span class="text-xs text-[#A1887F] w-8">ì‹œì‘</span>
                    <select id="startHour" class="time-select"></select> : <select id="startMin" class="time-select"></select>
                </div>
                <div class="flex items-center justify-center gap-2">
                    <span class="text-xs text-[#A1887F] w-8">ì¢…ë£Œ</span>
                    <select id="endHour" class="time-select"></select> : <select id="endMin" class="time-select"></select>
                </div>
            </div>
            <div id="weeklyDateInputWrapper" class="hidden mb-5">
                <label class="text-xs text-[#A1887F] block mb-2">ìˆ˜í–‰í•  ë‚ ì§œ (ì„ íƒ)</label>
                <input type="date" id="weeklyTaskDate" class="border border-[#EFEBE9] rounded p-2 text-sm text-[#5D4037] w-full bg-white">
            </div>
            <div class="flex gap-2 justify-center">
                <button id="btnDeleteTask" onclick="deleteTaskFromModal()" class="hidden px-4 py-2 bg-[#FFAB91] text-white rounded-lg text-xs font-bold hover:bg-[#FF8A65]">ì‚­ì œ</button>
                <button onclick="closeModal('addTaskModal')" class="px-4 py-2 bg-gray-100 rounded-lg text-xs text-gray-500 hover:bg-gray-200">ì·¨ì†Œ</button>
                <button onclick="confirmTaskAction()" class="px-4 py-2 bg-[#8D6E63] text-white rounded-lg text-xs font-bold hover:bg-[#6D4C41]">í™•ì¸</button>
            </div>
        </div>
    </div>

    <div id="projectInputModal" class="fixed inset-0 bg-black/20 z-[60] hidden flex items-center justify-center backdrop-blur-[1px]">
        <div class="bg-white p-6 rounded-2xl shadow-lg w-80 wood-frame modal-content">
            <h3 class="font-hand text-xl text-[#8D6E63] mb-4 text-center">ìƒˆ í”„ë¡œì íŠ¸ ì‹¬ê¸°</h3>
            <label class="text-xs text-[#A1887F] mb-1 block">í”„ë¡œì íŠ¸ ì´ë¦„</label>
            <input type="text" id="projTitle" class="w-full border-b-2 border-[#D7CCC8] p-2 mb-3 focus:outline-none text-center text-sm" placeholder="">
            <label class="text-xs text-[#A1887F] mb-1 block">ë‚´ìš©</label>
            <textarea id="projDesc" class="w-full border-2 border-[#EFEBE9] rounded-xl p-2 mb-3 text-sm focus:outline-none focus:border-[#D7CCC8] resize-none" rows="2"></textarea>
            <div class="flex border-b border-[#EFEBE9] mb-3">
                <div onclick="switchProjMode('range')" id="pm-range" class="flex-1 text-center modal-tab active">ê¸°ê°„ ì§€ì •</div>
                <div onclick="switchProjMode('select')" id="pm-select" class="flex-1 text-center modal-tab">ë‚ ì§œ ì„ íƒ</div>
            </div>
            <div id="projModeRange">
                <div class="flex gap-2 mb-2">
                    <div class="flex-1">
                        <label class="text-xs text-[#A1887F] mb-1 block">ì‹œì‘ì¼</label>
                        <input type="date" id="projStart" class="w-full border border-[#EFEBE9] rounded p-1 text-xs text-[#5D4037]">
                    </div>
                    <div class="flex-1">
                        <label class="text-xs text-[#A1887F] mb-1 block">ì¢…ë£Œì¼</label>
                        <input type="date" id="projEnd" class="w-full border border-[#EFEBE9] rounded p-1 text-xs text-[#5D4037]">
                    </div>
                </div>
            </div>
            <div id="projModeSelect" class="hidden">
                <div class="flex justify-between items-center mb-2 px-2">
                    <button onclick="moveProjCal(-1)" class="text-[#8D6E63]">â—€</button>
                    <span id="projCalTitle" class="text-xs font-bold text-[#5D4037]"></span>
                    <button onclick="moveProjCal(1)" class="text-[#8D6E63]">â–¶</button>
                </div>
                <div class="mini-cal-grid mb-1" id="projCalGrid"></div>
                <div class="text-[10px] text-right text-[#8D6E63]"><span id="selectedCount">0</span>ì¼ ì„ íƒë¨</div>
            </div>
            <div class="flex gap-2 justify-center mt-3">
                <button onclick="closeModal('projectInputModal')" class="px-4 py-2 bg-gray-100 rounded-lg text-xs text-gray-500 hover:bg-gray-200">ì·¨ì†Œ</button>
                <button onclick="confirmCreateProject()" class="px-4 py-2 bg-[#556B2F] text-white rounded-lg text-xs font-bold hover:bg-[#33691E]">ì‹¬ê¸°</button>
            </div>
        </div>
    </div>

    <div id="inputModal" class="fixed inset-0 bg-black/20 z-[60] hidden flex items-center justify-center backdrop-blur-[1px]">
        <div class="bg-white p-5 rounded-2xl shadow-lg w-80 wood-frame modal-content text-center">
            <h3 id="inputModalTitle" class="font-hand text-xl text-[#8D6E63] mb-3">ì…ë ¥</h3>
            <textarea id="inputModalField" rows="3" class="w-full border-2 border-[#EFEBE9] rounded-xl p-2 mb-4 focus:outline-none focus:border-[#D7CCC8] text-center resize-none bg-transparent" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
            <div class="flex gap-2 justify-center">
                <button onclick="closeModal('inputModal')" class="px-4 py-2 bg-gray-200 rounded-lg text-xs text-gray-500">ì·¨ì†Œ</button>
                <button onclick="confirmInput()" class="px-4 py-2 bg-[#8D6E63] text-white rounded-lg text-xs font-bold">í™•ì¸</button>
            </div>
        </div>
    </div>

    <div id="timerModal" class="fixed inset-0 bg-black/20 z-[80] hidden flex items-center justify-center backdrop-blur-[2px]">
        <div id="timerCard" class="timer-popup w-72 p-6 rounded-full aspect-square flex flex-col items-center justify-center shadow-lg relative transition-colors duration-500">
             <div class="text-xs font-bold opacity-60 mb-2 tracking-widest text-[#5D4037]">NOW FOCUSING</div>
             <div id="timerTaskName" class="text-sm font-bold text-center mb-4 px-4 line-clamp-2 text-[#5D4037]"></div>
             <div id="timerDisplay" class="text-4xl font-mono font-bold mb-6 tracking-wider text-[#5D4037]">00:00:00</div>
             <button onclick="finishTimer()" class="bg-white border border-[#D7CCC8] px-6 py-2 rounded-full text-sm font-bold hover:bg-[#EFEBE9] text-[#5D4037]">ë§ˆë¬´ë¦¬</button>
        </div>
    </div>

    <div id="feedbackModal" class="fixed inset-0 bg-black/20 z-[90] hidden flex items-center justify-center backdrop-blur-[1px]">
        <div class="bg-white p-6 rounded-2xl shadow-lg w-80 wood-frame modal-content text-center">
            <h3 class="font-hand text-xl text-[#8D6E63] mb-4">ì¼ì • ë§ˆë¬´ë¦¬</h3>
            <div class="text-sm text-[#5D4037] mb-6 font-bold truncate px-4" id="fbTaskTitle"></div>
            
            <div class="flex justify-center gap-4 mb-4">
                <button onclick="selectFbStatus('O')" id="btnFbO" class="fb-btn fb-btn-o">O</button>
                <button onclick="selectFbStatus('TRI')" id="btnFbTri" class="fb-btn fb-btn-tri">â–³</button>
                <button onclick="selectFbStatus('X')" id="btnFbX" class="fb-btn fb-btn-x">X</button>
            </div>

            <div id="fbPendingOption" class="hidden mb-4 transition-all duration-300">
                <label class="flex items-center justify-center gap-2 text-xs text-[#5D4037] cursor-pointer bg-[#FDFCF5] py-2 rounded-lg border border-[#EFEBE9] hover:bg-[#FFF8E1]">
                    <input type="checkbox" id="chkAddToPending" class="accent-[#8D6E63] w-3.5 h-3.5">
                    <span>ë¯¸ì™„ë£Œ ë³´ê´€í•¨ì— ë‹´ê¸° (ë‚˜ì¤‘ì— í•˜ê¸°)</span>
                </label>
            </div>

            <textarea id="fbTextInput" rows="2" class="w-full border border-[#EFEBE9] rounded-xl p-3 text-xs mb-4 resize-none focus:outline-none" placeholder="í”¼ë“œë°± ë‚¨ê¸°ê¸° (ì„ íƒ)"></textarea>
            
            <div class="flex gap-2 justify-center">
                <button onclick="closeModal('feedbackModal')" class="px-4 py-2 bg-gray-100 rounded-lg text-xs text-gray-500 hover:bg-gray-200">ì·¨ì†Œ</button>
                <button onclick="submitFeedback()" class="px-4 py-2 bg-[#8D6E63] text-white rounded-lg text-xs font-bold hover:bg-[#6D4C41]">í™•ì¸</button>
            </div>
        </div>
    </div>

    <div id="captureContainer" class="fixed top-0 left-0 -z-50 opacity-0 pointer-events-none bg-[#FDFCF5] p-6 w-[360px]"></div>

<script>
    const STORAGE_KEY_API = 'zipipo_v2_apikey';
    const STORAGE_KEY_DATA = 'zipipo_v2_data'; 
    const GEMINI_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent';
    
    let appData = { daily: {}, weekly: {}, projects: [], dailySummaries: {}, dailyPrompts: {}, weeklyPrompts: {}, routines: [], pendingTasks: [], userStyle: "" };
    let currentTab = 'home';
    let selectedDate = new Date().toISOString().split('T')[0];
    let lastKnownToday = new Date().toISOString().split('T')[0]; 
    let currentWeekBaseDate = new Date();
    let achievementViewDate = new Date().toISOString().split('T')[0];
    let inputCallback = null;
    let editingTask = null;
    let activeProjectId = null;
    let projCalDate = new Date();
    let selectedProjDates = new Set();
    let projMode = 'range';
    let currentTaskTypeForAdd = 'daily'; 
    let loadingInterval;
    let calendarDate = new Date();
    let lastProjectScrollTop = 0;
    
    // Timer & Feedback State
    let timerInterval;
    let timerTask = null; 
    let timerTargetTime = null;
    let fbTarget = null;
    let fbStatus = 'O';

    function getLocalDateStr(d) { return `${d.getFullYear()}-${(d.getMonth()+1).toString().padStart(2,'0')}-${d.getDate().toString().padStart(2,'0')}`; }
    function formatTimeSimple(iso) { const d = new Date(iso); return `${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`; }
    function getTodayStr() { return getLocalDateStr(new Date()); }
    function parseTasks(text) { return text.split('\n').map(l=>l).filter(l=>l.trim().length>0 && !l.trim().startsWith('---')); }
    function getWeekKey(d) { const date = new Date(d); const diff = date.getDate() - date.getDay(); const sunday = new Date(date.setDate(diff)); return getLocalDateStr(sunday); }
    function getWeekRangeStr(d) { const curr = new Date(d); const day = curr.getDay(); const first = new Date(curr); first.setDate(curr.getDate() - day); const last = new Date(first); last.setDate(first.getDate() + 6); return `${first.getMonth()+1}.${first.getDate()} ~ ${last.getMonth()+1}.${last.getDate()}`; }
    function getSunday(d) { d = new Date(d); var day = d.getDay(); var diff = d.getDate() - day; return new Date(d.setDate(diff)); }
    function toggleApiKeyInput() { document.getElementById('apiKeyContainer').classList.toggle('hidden'); }
    function changeDate(v) { selectedDate = v; renderApp(); }
    function moveWeek(d) { currentWeekBaseDate.setDate(currentWeekBaseDate.getDate() + (d * 7)); renderApp(); }
    function moveMonth(d) { calendarDate.setMonth(calendarDate.getMonth() + d); renderApp(); }
    function stringToPastelColor(str) { let hash = 0; for (let i = 0; i < str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash); const h = Math.abs(hash) % 360; return `hsl(${h}, 70%, 90%)`; }

    function initTimeSelects() {
        const hours = Array.from({length:24}, (_,i) => i.toString().padStart(2,'0'));
        const mins = ['00', '15', '30', '45'];
        ['startHour', 'endHour'].forEach(id => { const el = document.getElementById(id); if(el) el.innerHTML = '<option value="">--</option>' + hours.map(h => `<option value="${h}">${h}</option>`).join(''); });
        ['startMin', 'endMin'].forEach(id => { const el = document.getElementById(id); if(el) el.innerHTML = '<option value="">--</option>' + mins.map(m => `<option value="${m}">${m}</option>`).join(''); });
    }

    function showLoading(msg) {
        const p = document.getElementById('aiLoadingPopup');
        p.classList.remove('hidden');
        let cleanMsg = msg.replace('âœ¨', '').trim();
        p.querySelector('.font-hand').childNodes[0].nodeValue = cleanMsg;
        let dots = 0;
        if(loadingInterval) clearInterval(loadingInterval);
        loadingInterval = setInterval(() => { dots = (dots+1)%4; document.getElementById('loadingDots').innerText = '.'.repeat(dots); }, 500);
    }
    function hideLoading() {
        document.getElementById('aiLoadingPopup').classList.add('hidden');
        if(loadingInterval) clearInterval(loadingInterval);
    }

    function getTaskTimeVal(t) {
        let timeStr = t.manualTimeRange;
        if (!timeStr && t.text) { const m = t.text.match(/(?:^|[\s\(\[])(\d{1,2}):(\d{2})/); if(m) timeStr = `${m[1]}:${m[2]}`; }
        if(timeStr) {
            const m = timeStr.match(/(\d{1,2}):(\d{2})/);
            if(m) { let h = parseInt(m[1]); const min = parseInt(m[2]); if (h < 5) h += 24; return h * 60 + min; }
        }
        return 999999; 
    }

    function loadData() {
        const json = localStorage.getItem(STORAGE_KEY_DATA);
        if (json) { try { appData = JSON.parse(json); } catch(e) { console.error(e); } }
        if (!appData.daily) appData.daily = {};
        if (!appData.weekly) appData.weekly = {};
        if (!appData.projects) appData.projects = [];
        if (!appData.dailySummaries) appData.dailySummaries = {};
        if (!appData.dailyPrompts) appData.dailyPrompts = {};
        if (!appData.weeklyPrompts) appData.weeklyPrompts = {};
        if (!appData.routines) appData.routines = [];
        if (!appData.pendingTasks) appData.pendingTasks = [];
        if (!appData.userStyle) appData.userStyle = "";
    }
    function saveData() {
        localStorage.setItem(STORAGE_KEY_DATA, JSON.stringify(appData));
        const toast = document.getElementById('saveToast');
        if(toast) { toast.style.opacity = '1'; setTimeout(() => { toast.style.opacity = '0'; }, 2000); }
    }
    function saveApiKey() {
        const key = document.getElementById('apiKeyInput').value;
        if(key) { localStorage.setItem(STORAGE_KEY_API, key); alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤'); toggleApiKeyInput(); }
    }

    async function callGemini(sysPrompt, cb) {
        const key = localStorage.getItem(STORAGE_KEY_API);
        if (!key) { alert("API Keyê°€ ì—†ìŠµë‹ˆë‹¤. í•˜ë‹¨ Key Settingì—ì„œ í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."); hideLoading(); return; }
        try {
            const res = await fetch(`${GEMINI_URL}?key=${key}`, {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ contents: [{ parts: [{ text: sysPrompt }] }] })
            });
            const data = await res.json();
            if(data.candidates && data.candidates[0].content) cb(data.candidates[0].content.parts[0].text);
            else { console.error("Gemini Error:", data); alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'); hideLoading(); }
        } catch(e) { console.error(e); alert('API ìš”ì²­ ì‹¤íŒ¨'); hideLoading(); }
    }

    async function generateSchedule(type) {
        const inputEl = document.getElementById('taskPrompt');
        let promptText = inputEl.value.trim();
        if(!promptText) return alert('ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
        
        if(promptText.includes('í•˜ê²Œ') || promptText.includes('ìŠ¤íƒ€ì¼') || promptText.includes('ì—¬ìœ ') || promptText.includes('íƒ€ì´íŠ¸')) {
            appData.userStyle = promptText; 
        }

        showLoading("zipipoê°€ ìƒê° ì¤‘");
        document.getElementById('generatorModal').classList.add('hidden');
        
        const now = new Date();
        const currentTimeStr = `${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`;
        let context = "";
        
        if (appData.pendingTasks && appData.pendingTasks.length > 0) {
            const pends = appData.pendingTasks.map(t => `- ${t.text}`).join('\n');
            context += `\n[ì´ì „ì— ë¯¸ì™„ë£Œëœ í•­ëª© (ë°˜ë“œì‹œ ì¼ì •ì— í¬í•¨í•  ê²ƒ)]\n${pends}\n`;
        }
        if (appData.routines && appData.routines.length > 0) {
            context += `\n[ê³ ì • ë£¨í‹´]\n${appData.routines.map(r=>r.text).join(', ')}\n`;
        }
        if(type === 'daily') {
            const prevDate = new Date(selectedDate); prevDate.setDate(prevDate.getDate()-1);
            const prevDateStr = getLocalDateStr(prevDate);
            const prevSum = appData.dailySummaries[prevDateStr];
            if(prevSum && prevSum.includes('ê³„íš ì¡°ì–¸')) {
                 const advicePart = prevSum.split('ê³„íš ì¡°ì–¸')[1] || "";
                 context += `\n[ì–´ì œ íšŒê³  í”¼ë“œë°± ì°¸ê³ ]\n${advicePart.substring(0, 150)}...\n`;
            }
        }
        if (type === 'daily' && appData.daily[selectedDate]) {
            const done = appData.daily[selectedDate].filter(t=>t.done).map(t=>t.text).join(', ');
            if(done) context += `\n[ì´ë¯¸ ì™„ë£Œí•œ ì¼ì • (ì¤‘ë³µ ìƒì„± ê¸ˆì§€)]\n${done}\n`;
        }

        let sysPrompt = "";
        if (type === 'daily') {
             const oldHistory = appData.dailyPrompts[selectedDate] || "";
             const combinedHistory = oldHistory ? `${oldHistory}\n[ì¶”ê°€ ìš”ì²­(${currentTimeStr})]: ${promptText}` : promptText;
             appData.dailyPrompts[selectedDate] = combinedHistory;
             
             sysPrompt = `ì—­í• : ì°¨ë¶„í•˜ê³  ê¼¼ê¼¼í•œ í”Œë˜ë„ˆ. ë‚ ì§œ: ${selectedDate}. í˜„ì¬ì‹œê°: ${currentTimeStr}.
             [ìš”ì²­ íˆìŠ¤í† ë¦¬]: ${combinedHistory}
             [í˜„ì¬ ìš”ì²­]: "${promptText}"
             ${appData.userStyle ? `[ì„ í˜¸ ìŠ¤íƒ€ì¼]: "${appData.userStyle}"` : ''}
             ${context}
             [ê·œì¹™]
             1. ì´ëª¨ì§€ ê¸ˆì§€. ë‹´ë°±í•˜ê²Œ.
             2. **í˜„ì¬ ì‹œê°(${currentTimeStr}) ì´í›„ì˜ ì¼ì •ë§Œ ê³„íš.**
             3. ì‹œê°„ ë¶€ì¡± ì‹œ ìš”ì²­í•œ ì¼ì„ ì¤„ì—¬ì„œë¼ë„ ë°°ì¹˜.
             4. í˜•ì‹: 'HH:MM~HH:MM í• ì¼ | ê¿€íŒ(ê´„í˜¸ì—†ì´ ë‚´ìš©ë§Œ)'
             5. ê¿€íŒì´ ì—†ê±°ë‚˜ í• ì¼ê³¼ ë¹„ìŠ·í•˜ë©´ ìƒëµ.
             6. ë§ˆì§€ë§‰ ì¤„ì— '[MSG] í•œë§ˆë””'.
             `;
        } else {
             const wkKey = getWeekKey(currentWeekBaseDate);
             appData.weeklyPrompts[wkKey] = promptText;
             sysPrompt = `ì—­í• : ì£¼ê°„ ë³´ë“œ í”Œë˜ë„ˆ. ê¸°ê°„: ${getWeekRangeStr(currentWeekBaseDate)}.
             ìš”ì²­: "${promptText}"
             ${context}
             [ê·œì¹™]
             1. ì´ëª¨ì§€ ê¸ˆì§€. í•  ì¼ë§Œ ì‘ì„±. **ê¿€íŒ ê¸ˆì§€.**
             2. í˜•ì‹: 'YYYY-MM-DD: í• ì¼'
             3. ë‚ ì§œ ì§€ì • ì—†ìœ¼ë©´ 'Anytime: í• ì¼'
             `;
        }

        await callGemini(sysPrompt, (text) => {
            const lines = parseTasks(text);
            const newTasks = [];
            lines.forEach(line => {
                let clean = line.trim();
                if(!clean) return;
                if(clean.startsWith('[MSG]')) {
                    const msgText = clean.replace('[MSG]','').trim();
                    if(msgText) newTasks.push({text: msgText, isMessage: true});
                    return;
                }
                let advice = "";
                if(clean.includes('|')) {
                    const parts = clean.split('|');
                    clean = parts[0].trim();
                    advice = parts[1].trim();
                    advice = advice.replace('ê¿€íŒ','').replace(/[()]/g,'').trim();
                }
                if(type==='daily') {
                    newTasks.push({ text: clean, done: false, isMessage: false, advice: advice, feedback: null });
                } else {
                    const dMatch = clean.match(/(\d{4}-\d{2}-\d{2})[:\s]+(.*)/);
                    if(dMatch) newTasks.push({ text: dMatch[2], done:false, specificDate:dMatch[1] });
                    else {
                        const anyMatch = clean.match(/Anytime[:\s]+(.*)/);
                        newTasks.push({ text: anyMatch?anyMatch[1]:clean, done:false });
                    }
                }
            });

            if(type==='daily') {
                const existing = appData.daily[selectedDate] || [];
                const done = existing.filter(t=>t.done);
                appData.daily[selectedDate] = [...done, ...newTasks].sort((a,b)=>getTaskTimeVal(a)-getTaskTimeVal(b));
                appData.pendingTasks = [];
            } else {
                const wk = getWeekKey(currentWeekBaseDate);
                appData.weekly[wk] = { tasks: newTasks };
            }
            inputEl.value = ''; 
            saveData();
            hideLoading();
            renderApp();
        });
    }

    window.linkWeeklyTasks = function() {
        const wkKey = getWeekKey(new Date(selectedDate));
        if (!appData.weekly || !appData.weekly[wkKey] || !appData.weekly[wkKey].tasks || appData.weekly[wkKey].tasks.length === 0) return alert('ì´ë²ˆ ì£¼ ì¼ì •ì´ ì—†ì–´ìš”.');
        const todaysTasks = appData.weekly[wkKey].tasks.filter(t => !t.isMessage && (t.specificDate === selectedDate));
        if (todaysTasks.length === 0) return alert(`ì˜¤ëŠ˜(${selectedDate}) ë‚ ì§œë¡œ ì§€ì •ëœ Weekly í•  ì¼ì´ ì—†ì–´ìš”.`);
        const taskListStr = todaysTasks.map(t => t.text).join(', ');
        const promptBox = document.getElementById('taskPrompt');
        const prefix = promptBox.value.trim() ? '\n' : '';
        promptBox.value += `${prefix}ì˜¤ëŠ˜ Weekly í• ì¼: ${taskListStr} (ì´ ì¼ì •ë“¤ì„ í¬í•¨í•´ì„œ ê³„íš ì§œì¤˜)`;
    };

    async function generateDailySummary(dateStr) {
        const key = localStorage.getItem(STORAGE_KEY_API);
        if(!key) return alert('API Keyê°€ í•„ìš”í•´ìš”!');
        try {
            const tasks = appData.daily[dateStr] || [];
            let summaryContext = tasks.filter(t=>!t.isMessage).map(t => `- ${t.text} [${t.done?"ì™„ë£Œ":"ë¯¸ì™„ë£Œ"}] ${t.feedback?`(${t.feedback})`:""}`).join('\n');
            showLoading("zipipoê°€ íšŒê³  ì¤‘");
            const sysPrompt = `ë‚ ì§œ: ${dateStr}.
            [í™œë™ ë‚´ì—­]
            ${summaryContext}
            4ê°€ì§€ í•­ëª©ìœ¼ë¡œ ì •ë¦¬í•´ì¤˜: 1. ì˜¤ëŠ˜ ì˜í•œ ì  2. ì•„ì‰¬ìš´ ì  3. ë§ˆì¸ë“œì…‹ 4. ë‚´ì¼ ê³„íš ì¡°ì–¸.
            ê·œì¹™: **ì†Œì œëª©ì€ <b>íƒœê·¸ ì‚¬ìš©**. ë”°ëœ»í•œ ë§íˆ¬.`;
            await callGemini(sysPrompt, (text) => {
                appData.dailySummaries[dateStr] = text.replace(/\*\*/g, ''); 
                hideLoading(); saveData(); renderApp();
            });
        } catch(e) { console.error(e); hideLoading(); }
    }
	
    function completeProject(id, isComplete) {
        const p = appData.projects.find(x => x.id === id);
        if (p) { p.completed = isComplete; saveData(); renderApp(); }
    }
    function deleteProject(id) {
        if(confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) { appData.projects = appData.projects.filter(p=>p.id!==id); saveData(); renderApp(); }
    }
    function deleteTaskItem(type, key, index) {
        if(type==='daily') appData.daily[key].splice(index,1);
        else if(type==='weekly') appData.weekly[key].tasks.splice(index,1);
        else appData.projects.find(p=>p.id===key).tasks.splice(index,1);
        saveData(); renderApp();
    }
    function updateTask(type, key, index, changes) {
        if(currentTab === 'project') { const scrollEl = document.getElementById('projectScrollContainer'); if(scrollEl) lastProjectScrollTop = scrollEl.scrollTop; }
        let targetArr;
        if(type==='daily') targetArr = appData.daily[key];
        else if(type==='weekly') targetArr = appData.weekly[key].tasks;
        else targetArr = appData.projects.find(p=>p.id===key).tasks;
        Object.assign(targetArr[index], changes);
        saveData(); renderApp();
        if(currentTab === 'project' && lastProjectScrollTop > 0) setTimeout(() => { document.getElementById('projectScrollContainer').scrollTop = lastProjectScrollTop; }, 0);
    }
    function updateProjectMemo(pid, val) {
        const p = appData.projects.find(x => x.id === pid);
        if(p) { p.memo = val; saveData(); }
    }
    function editDailyMessage(dateStr) {
        const tasks = appData.daily[dateStr] || [];
        const combinedText = tasks.filter(t => t.isMessage).map(m => m.text).join('\n');
        openInputModal('ì˜¤ëŠ˜ì˜ í•œë§ˆë”” ìˆ˜ì •', (newText) => {
            appData.daily[dateStr] = tasks.filter(t => !t.isMessage);
            if(newText.trim()) appData.daily[dateStr].unshift({ text: newText, done: false, isMessage: true });
            saveData(); renderApp();
        });
        document.getElementById('inputModalField').value = combinedText;
    }

    // Modal & Timer Logic
    function openTimerModal(taskObj) {
        timerTask = taskObj;
        const now = new Date();
        const timeMatch = taskObj.task.text.match(/(\d{1,2}):(\d{2})\s*~\s*(\d{1,2}):(\d{2})/);
        let durationMin = 60; 
        if (timeMatch) {
            const sVal = parseInt(timeMatch[1])*60 + parseInt(timeMatch[2]);
            let eVal = parseInt(timeMatch[3])*60 + parseInt(timeMatch[4]);
            if(eVal < sVal) eVal += 24*60;
            durationMin = eVal - sVal;
        }
        if (taskObj.task.actualStartTime) {
            const startTime = new Date(taskObj.task.actualStartTime);
            timerTargetTime = new Date(startTime.getTime() + durationMin * 60000);
        } else {
            updateTask(taskObj.type, taskObj.key, taskObj.index, {actualStartTime: now.toISOString()});
            timerTargetTime = new Date(now.getTime() + durationMin * 60000);
        }
        document.getElementById('timerModal').classList.remove('hidden');
        document.getElementById('timerTaskName').innerText = taskObj.task.text;
        document.getElementById('timerCard').classList.remove('timer-over');
        updateTimerDisplay();
        if(timerInterval) clearInterval(timerInterval);
        timerInterval = setInterval(updateTimerDisplay, 1000);
    }
    function updateTimerDisplay() {
        const now = new Date();
        let diff = timerTargetTime - now;
        const isOver = diff < 0;
        if (isOver) { document.getElementById('timerCard').classList.add('timer-over'); diff = Math.abs(diff); }
        const h = Math.floor(diff / 3600000);
        const m = Math.floor((diff % 3600000) / 60000);
        const s = Math.floor((diff % 60000) / 1000);
        document.getElementById('timerDisplay').innerText = `${(isOver?'+ ':'')}${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
    }
    function finishTimer() {
        clearInterval(timerInterval);
        document.getElementById('timerModal').classList.add('hidden');
        if(timerTask) {
             updateTask(timerTask.type, timerTask.key, timerTask.index, {actualEndTime: new Date().toISOString()});
             setTimeout(() => openFeedbackModal(timerTask), 200);
        }
    }

    function openFeedbackModal(taskObj) {
        fbTarget = taskObj;
        document.getElementById('fbTaskTitle').innerText = taskObj.task.text;
        document.getElementById('fbTextInput').value = taskObj.task.feedback || '';
        const chk = document.getElementById('chkAddToPending');
        if(chk) chk.checked = false;
        selectFbStatus('O'); 
        document.getElementById('feedbackModal').classList.remove('hidden');
    }
    function selectFbStatus(s) {
        fbStatus = s;
        ['O','Tri','X'].forEach(k => document.getElementById(`btnFb${k}`).classList.remove('selected'));
        let targetId = 'btnFbO';
        if(s === 'TRI') targetId = 'btnFbTri';
        if(s === 'X') targetId = 'btnFbX';
        document.getElementById(targetId).classList.add('selected');
        const optionDiv = document.getElementById('fbPendingOption');
        if (optionDiv) {
            if (s !== 'O') optionDiv.classList.remove('hidden');
            else optionDiv.classList.add('hidden');
        }
    }
    function submitFeedback() {
        if(!fbTarget) return;
        const fbText = document.getElementById('fbTextInput').value;
        const isDone = (fbStatus === 'O');
        updateTask(fbTarget.type, fbTarget.key, fbTarget.index, { feedback: fbText, done: isDone });
        if(fbStatus !== 'O') {
            const chk = document.getElementById('chkAddToPending');
            if (chk && chk.checked) {
                let cleanText = fbTarget.task.text.replace(/\d{1,2}:\d{2}.*/, '').trim();
                if(!appData.pendingTasks.some(t => t.text === cleanText)) {
                    appData.pendingTasks.push({ text: cleanText, date: selectedDate });
                }
            }
        }
        closeModal('feedbackModal');
    }

    function saveSummaryImage(dateStr) {
        const summary = appData.dailySummaries[dateStr];
        if(!summary) return alert("ì €ì¥í•  íšŒê³  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.");
        const capture = document.getElementById('captureContainer');
        capture.innerHTML = `
            <div class="bg-[#FDFCF5] border-4 border-[#A1887F] p-8 rounded-3xl" style="width: 340px;">
                <h2 class="font-hand text-3xl text-[#5D4037] text-center mb-6">${dateStr}</h2>
                <div class="text-xs text-[#33691E] bg-[#F1F8E9] p-5 rounded-2xl leading-relaxed font-sans mb-6 border-2 border-[#DCEDC8]">
                    ${summary.replace(/\n/g, '<br>')}
                </div>
                <div class="text-center text-[10px] text-[#BCAAA4] font-bold tracking-widest">ZIPIPO PLANNER</div>
            </div>`;
        html2canvas(capture.querySelector('div'), {scale: 2, backgroundColor:null}).then(canvas => {
            const link = document.createElement('a'); link.download = `zipipo_${dateStr}.png`; link.href = canvas.toDataURL(); link.click();
        });
    }

    // Modal Generators
    function openGeneratorModal(mode) {
        document.getElementById('generatorModal').classList.remove('hidden');
        const txt = document.getElementById('taskPrompt');
        txt.value = ''; txt.focus();
    }
    function openWeeklyGenerator() {
        const wk = getWeekKey(currentWeekBaseDate);
        const saved = appData.weeklyPrompts[wk] || '';
        document.getElementById('taskPrompt').value = saved;
        document.getElementById('generatorModal').classList.remove('hidden');
    }
    function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
    function addManualTask() { openAddTaskModal(null, 'daily'); }

    // Render Logic
    function renderApp() {
        const container = document.getElementById('appContent');
        container.innerHTML = '';
        document.getElementById('headerDate').innerText = `${new Date().getMonth()+1}.${new Date().getDate()}`;
        if (currentTab === 'home') renderDaily(container);
        else if (currentTab === 'project') renderProjects(container);
        else if (currentTab === 'achievement') renderCalendar(container);
    }

    function renderDaily(container) {
        const secDaily = document.createElement('section');
        const d = new Date(selectedDate);
        const dayNames = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
        
        secDaily.innerHTML = `
            <div class="flex justify-between items-end mb-4 px-1">
                <div class="text-2xl font-hand text-[#5D4037] flex items-baseline gap-2">
                    <span>${d.getMonth()+1}.${d.getDate()}</span>
                    <span class="text-sm text-[#A1887F] font-sans font-bold">${dayNames[d.getDay()]}</span>
                </div>
                <div class="flex gap-2">
                    <button onclick="window.openRoutineModal()" class="text-[10px] bg-white border border-[#D7CCC8] px-2 py-1 rounded-full text-[#8D6E63] hover:bg-[#EFEBE9]">ë£¨í‹´ ë“±ë¡</button>
                    <input type="date" class="border border-[#D7CCC8] rounded px-2 py-1 text-xs bg-white" value="${selectedDate}" onchange="window.changeDate(this.value)">
                </div>
            </div>`;
        
        const dailyData = appData.daily[selectedDate] || [];
        const dailyMsgs = dailyData.filter(t => t.isMessage);
        if (dailyMsgs.length > 0) {
            const msgBox = document.createElement('div');
            msgBox.className = 'mx-6 mt-1 mb-3 p-3 bg-white/60 rounded-xl border border-[#C5E1A5] text-sm text-[#556B2F] relative z-10 font-wando leading-relaxed cursor-pointer hover:bg-white/80 transition';
            msgBox.onclick = () => editDailyMessage(selectedDate);
            msgBox.innerHTML = dailyMsgs.map(m => m.text).join('<br>');
            secDaily.appendChild(msgBox);
        }

        const contentDaily = document.createElement('div');
        contentDaily.className = 'bg-white rounded-[24px] border border-[#EFEBE9] p-5 relative min-h-[300px] shadow-sm';
        
        const promptBtn = document.createElement('button');
        promptBtn.className = 'absolute top-3 right-3 text-[10px] text-[#A1887F] bg-[#FDFCF5] border border-[#D7CCC8] px-2 py-1 rounded-full hover:bg-[#EFEBE9] z-20 flex items-center gap-1';
        promptBtn.innerText = `ìˆ˜ì •`;
        promptBtn.onclick = () => openGeneratorModal('daily');
        contentDaily.appendChild(promptBtn);

        const realDailyTasks = dailyData.filter(t => !t.isMessage);
        if (realDailyTasks.length > 0) {
            const ulDaily = document.createElement('ul');
            realDailyTasks.sort((a, b) => { if (a.done !== b.done) return a.done ? 1 : -1; return getTaskTimeVal(a) - getTaskTimeVal(b); });
            realDailyTasks.forEach((t) => {
                const originalIndex = dailyData.indexOf(t);
                ulDaily.appendChild(createTaskEl(t, 'daily', selectedDate, originalIndex));
            });
            contentDaily.appendChild(ulDaily);
        } else {
            contentDaily.innerHTML += `<div class="empty-state relative z-10"><span class="text-xs text-[#8D6E63] opacity-60">ì˜¤ëŠ˜ì˜ ëª©í‘œë¥¼ ì„¸ì›Œë³´ì„¸ìš”!</span></div>`;
        }
        secDaily.appendChild(contentDaily);
        container.appendChild(secDaily);
        
        // Weekly Section
        const secWeekly = document.createElement('section');
        secWeekly.className = 'mt-8 pt-6 border-t border-dashed border-[#D7CCC8]';
        const weekKey = getWeekKey(currentWeekBaseDate);
        const weeklyData = appData.weekly[weekKey] || { tasks: [] };
        secWeekly.innerHTML = `
            <div class="flex justify-between items-center mb-4 px-1">
                <h3 class="font-hand text-xl text-[#8D6E63]">Weekly</h3>
                <div class="flex items-center gap-2">
                    <button onclick="window.moveWeek(-1)" class="text-[#A1887F] hover:text-[#5D4037]">â—€</button>
                    <span class="text-xs font-bold text-[#5D4037]">${getWeekRangeStr(currentWeekBaseDate)}</span>
                    <button onclick="window.moveWeek(1)" class="text-[#A1887F] hover:text-[#5D4037]">â–¶</button>
                    <button onclick="window.openWeeklyGenerator()" class="ml-1 text-[10px] text-[#8D6E63] border border-[#D7CCC8] px-2 py-1 rounded bg-white hover:bg-[#EFEBE9]">ìˆ˜ì •</button>
                    <button onclick="window.openAddTaskModal(null, 'weekly')" class="border border-[#D7CCC8] bg-white rounded-full w-6 h-6 flex items-center justify-center text-[#8D6E63] text-sm ml-1 hover:bg-[#EFEBE9]">+</button>
                </div>
            </div>`;
        const contentWrap = document.createElement('div');
        contentWrap.className = 'px-6 pb-5 pt-1 relative z-10 flex flex-col gap-4';
        const currentSun = getSunday(currentWeekBaseDate);
        for(let i=0; i<7; i++) {
            const d = new Date(currentSun); d.setDate(d.getDate() + i);
            const dayStr = getLocalDateStr(d);
            const dayTasks = weeklyData.tasks.filter(t => !t.isMessage && t.specificDate === dayStr);
            const daySection = document.createElement('div');
            const isToday = dayStr === getTodayStr();
            const headerColor = i === 0 ? 'text-red-500' : 'text-[#8D6E63]';
            const headerBg = isToday ? 'bg-[#FFE0B2]' : 'bg-white/50';
            daySection.innerHTML = `<div class="flex items-center mb-1"><span class="${headerBg} px-2 py-0.5 rounded text-xs font-bold ${headerColor} font-sans">${dayNames[i]} ${d.getMonth()+1}.${d.getDate()}</span></div>`;
            if (dayTasks.length > 0) {
                const ul = document.createElement('ul');
                ul.className = 'pl-2 border-l-2 border-[#D7CCC8]/30 ml-2 space-y-2';
                dayTasks.forEach(t => {
                    const originalIdx = weeklyData.tasks.indexOf(t);
                    const taskEl = createTaskEl(t, 'weekly', weekKey, originalIdx);
                    ul.appendChild(taskEl);
                });
                daySection.appendChild(ul);
            }
            contentWrap.appendChild(daySection);
        }
        secWeekly.appendChild(contentWrap);
        container.appendChild(secWeekly);
    }

    function renderProjects(container) {
        const sec = document.createElement('section');
        sec.innerHTML = `<h3 class="font-hand text-xl text-[#556B2F] mb-3 px-1">Projects</h3>`;
        sec.innerHTML += `<button onclick="window.openProjectModal()" class="w-full mb-4 py-4 border-2 border-dashed border-[#A1887F] text-[#8D6E63] font-hand text-xl rounded-2xl bg-white text-center hover:bg-[#FDFCF5]">+ í”„ë¡œì íŠ¸ ì‹¬ê¸°</button>`;
        const scrollDiv = document.createElement('div');
        scrollDiv.className = 'flex flex-col gap-4 pb-4 px-1 overflow-y-auto max-h-[70vh]';
        scrollDiv.id = 'projectScrollContainer';
        const today = new Date(); today.setHours(0,0,0,0);

        appData.projects.forEach(p => {
             if (!p.completed && p.endDate) { const endD = new Date(p.endDate); if (endD < today) { p.completed = true; saveData(); } }
             if(p.completed) return;

             const card = document.createElement('div');
             card.className = 'wood-frame p-4 bg-white border border-[#C5E1A5] relative w-full shadow-sm';
             card.innerHTML = `
                <div class="absolute top-2 right-2 flex gap-1 z-10">
                    <button class="p-1 text-[#A1887F] hover:text-[#8D6E63]" onclick="completeProject('${p.id}', true)">âœ”</button>
                    <button class="p-1 text-[#D7CCC8] hover:text-[#FF7F50]" onclick="deleteProject('${p.id}')">âœ•</button>
                </div>
                <div class="mb-3">
                    <p class="text-[10px] text-[#A1887F] font-bold uppercase">${p.dateDisplay}</p>
                    <h4 class="font-bold text-lg text-[#5D4037] mt-1">${p.title}</h4>
                </div>`;
                
             const tips = p.tasks.filter(t => t.isTip);
             if(tips.length > 0) {
                 const tipBox = document.createElement('div');
                 tipBox.className = 'proj-tip-box collapsed'; 
                 tipBox.onclick = () => tipBox.classList.toggle('collapsed');
                 tipBox.innerHTML = `<div class="flex justify-between items-center mb-1 cursor-pointer"><span class="proj-tip-label">TIP (Click)</span><span class="text-[10px]">â–¼</span></div>`;
                 tips.forEach(t => tipBox.innerHTML += `<div class="text-sm">â€¢ ${t.text}</div>`);
                 card.appendChild(tipBox);
             }

             card.innerHTML += `<div class="border-t border-dashed border-[#C5E1A5] pt-2 mt-2 mb-2 flex justify-between items-center">
                    <span class="text-xs font-bold text-[#556B2F]">Plan</span>
                    <button onclick="openProjectPlanModal('${p.id}')" class="text-[10px] bg-[#F1F8E9] text-[#33691E] px-2 py-1 rounded-full border border-[#AED581] hover:bg-[#AED581] hover:text-white">AI ê³„íš</button>
                </div>`;

             const grouped = {};
             p.tasks.forEach((t, idx) => {
                 if(t.isTip) return;
                 const d = t.date || 'ê¸°íƒ€';
                 if(!grouped[d]) grouped[d] = [];
                 grouped[d].push({...t, idx});
             });
             
             const listCont = document.createElement('div');
             listCont.className = 'max-h-96 overflow-y-auto pl-1 text-sm custom-scrollbar';
             const sortedDates = Object.keys(grouped).sort();
             const pastDatesDiv = document.createElement('div'); pastDatesDiv.className = 'proj-past-dates';
             let hasPast = false;

             sortedDates.forEach(date => {
                 const isPast = (new Date(date) < today && date.match(/\d{4}-\d{2}-\d{2}/));
                 const dateGroup = document.createElement('div');
                 dateGroup.innerHTML = `<div class="proj-date-header ${isPast ? 'opacity-50' : ''}">${date}</div>`;
                 const ul = document.createElement('ul');
                 grouped[date].forEach(item => {
                      if(item.type === 'header') ul.innerHTML += `<div class="proj-msg-box">${item.text}</div>`;
                      else {
                          const li = createTaskEl(item, 'project', p.id, item.idx, null);
                          if(!item.depth || item.depth===0) { const chk = li.querySelector('.custom-checkbox'); if(chk) chk.style.display = 'none'; }
                          if(item.depth) li.classList.add(`task-depth-${Math.min(item.depth,2)}`);
                          ul.appendChild(li);
                      }
                 });
                 dateGroup.appendChild(ul);
                 if (isPast) { hasPast = true; pastDatesDiv.appendChild(dateGroup); } else listCont.appendChild(dateGroup);
             });

             if (hasPast) {
                 const toggleBtn = document.createElement('button');
                 toggleBtn.className = 'text-xs text-[#BCAAA4] w-full py-1 mb-2 border border-[#EFEBE9] rounded bg-[#FDFCF5] hover:bg-[#EFEBE9]';
                 toggleBtn.innerText = 'â–¼ ì§€ë‚œ ì¼ì • ë³´ê¸°';
                 toggleBtn.onclick = () => { pastDatesDiv.classList.toggle('show'); toggleBtn.innerText = pastDatesDiv.classList.contains('show') ? 'â–² ì§€ë‚œ ì¼ì • ì ‘ê¸°' : 'â–¼ ì§€ë‚œ ì¼ì • ë³´ê¸°'; };
                 listCont.prepend(pastDatesDiv); listCont.prepend(toggleBtn);
             }
             card.appendChild(listCont);
             scrollDiv.appendChild(card);
        });
        sec.appendChild(scrollDiv);
        container.appendChild(sec);
        if(lastProjectScrollTop > 0) setTimeout(()=>scrollDiv.scrollTop = lastProjectScrollTop,0);
    }

    function renderCalendar(container) {
        const y = calendarDate.getFullYear();
        const m = calendarDate.getMonth() + 1;
        const lastDay = new Date(y, m, 0).getDate();

        // 1. í†µê³„ (ì´ í• ì¼ ê°œìˆ˜ ëŒ€ë¹„ ì™„ë£Œìœ¨)
        let totalTasks = 0;
        let doneTasks = 0;
        for(let i=1; i<=lastDay; i++) {
            const dStr = `${y}-${m.toString().padStart(2,'0')}-${i.toString().padStart(2,'0')}`;
            const tasks = appData.daily[dStr] || [];
            const realTasks = tasks.filter(t => !t.isMessage);
            totalTasks += realTasks.length;
            doneTasks += realTasks.filter(t => t.done).length;
        }
        const rate = totalTasks === 0 ? 0 : Math.round((doneTasks / totalTasks) * 100);

        const statsDiv = document.createElement('div');
        statsDiv.className = 'bg-white p-4 rounded-2xl border border-[#EFEBE9] mb-4 shadow-sm';
        statsDiv.innerHTML = `
            <div class="flex justify-between items-center mb-2">
                <span class="font-hand text-lg text-[#5D4037]">${m}ì›”ì˜ ê¸°ë¡</span>
                <span class="text-xl font-bold text-[#FF8A65]">${rate}%</span>
            </div>
            <div class="w-full h-2 bg-[#EFEBE9] rounded-full overflow-hidden">
                <div class="h-full bg-[#8FBC8F] transition-all duration-1000" style="width:${rate}%"></div>
            </div>
            <div class="text-[10px] text-right mt-1 text-[#BCAAA4]">${doneTasks}ê°œ ì™„ë£Œ / ì´ ${totalTasks}ê°œ</div>
        `;
        container.appendChild(statsDiv);

        const wrapper = document.createElement('div');
        wrapper.className = 'wood-frame p-5 bg-white min-h-[400px] flex flex-col';
        wrapper.innerHTML = `<div class="flex justify-between items-center mb-6"><button onclick="moveMonth(-1)" class="text-[#8D6E63]">â—€</button><h2 class="font-hand text-2xl text-[#5D4037]">${y}.${m}</h2><button onclick="moveMonth(1)" class="text-[#8D6E63]">â–¶</button></div>`;
        const grid = document.createElement('div'); 
        grid.className = 'grid grid-cols-7 gap-1 text-center mb-4';
        ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '].forEach(d => grid.innerHTML+=`<div class="text-xs text-[#A1887F] mb-2 font-bold">${d}</div>`);
        const firstDay = new Date(y, m-1, 1).getDay();
        for(let i=0; i<firstDay; i++) grid.innerHTML += `<div></div>`;
        for(let i=1; i<=lastDay; i++) {
            const dStr = `${y}-${m.toString().padStart(2,'0')}-${i.toString().padStart(2,'0')}`;
            const hasTask = appData.daily[dStr] && appData.daily[dStr].some(t=>t.done);
            const isSel = achievementViewDate === dStr;
            const cell = document.createElement('div');
            cell.className = `h-10 rounded-lg flex flex-col items-center justify-center cursor-pointer hover:bg-[#F1F8E9] transition ${isSel ? 'bg-[#DCEDC8] border border-[#AED581]' : ''}`;
            cell.innerHTML = `<span class="text-sm ${isSel?'font-bold':''}">${i}</span>${hasTask ? '<span class="text-[8px] text-[#FF8A65]">â—</span>' : ''}`;
            cell.onclick = () => { achievementViewDate = dStr; renderApp(); };
            grid.appendChild(cell);
        }
        wrapper.appendChild(grid);

        const detail = document.createElement('div');
        detail.className = 'mt-auto pt-4 border-t border-[#EFEBE9]';
        const summary = appData.dailySummaries[achievementViewDate];
        if(summary) {
            detail.innerHTML = `
                <div class="bg-[#F1F8E9] p-4 rounded-xl text-xs leading-relaxed border border-[#AED581] mb-2 font-wando text-[#33691E]">
                    <div class="font-bold text-center mb-2 text-[#556B2F]">~ ${achievementViewDate} íšŒê³  ~</div>
                    ${summary.replace(/\n/g, '<br>')}
                </div>
                <button onclick="saveSummaryImage('${achievementViewDate}')" class="w-full bg-[#8D6E63] text-white py-3 rounded-xl font-bold text-sm shadow-md hover:bg-[#6D4C41] transition">íšŒê³  ì¹´ë“œ ì €ì¥</button>
            `;
        } else {
             detail.innerHTML = `<button onclick="generateDailySummary('${achievementViewDate}')" class="w-full bg-white border border-[#D7CCC8] text-[#8D6E63] py-2 rounded-xl text-sm hover:bg-[#FDFCF5] transition">ì˜¤ëŠ˜ íšŒê³ í•˜ê¸°</button>`;
        }
        wrapper.appendChild(detail);
        container.appendChild(wrapper);
    }

    function createTaskEl(task, type, key, index, numberPrefix = null) {
        const li = document.createElement('li');
        li.className = `timeline-container flex flex-col mb-4 todo-item ${task.done ? 'completed' : ''}`;
        
        if (type === 'weekly') {
            li.classList.add('weekly-item'); li.classList.add('task-group-border'); 
            const coreText = task.text.replace(/\d{1,2}:\d{2}.*/, '').trim();
            li.style.borderColor = stringToPastelColor(coreText); 
        } else if (type !== 'project') {
            const dot = document.createElement('div'); dot.className = 'timeline-dot';
            const line = document.createElement('div'); line.className = 'timeline-line';
            li.appendChild(line); li.appendChild(dot);
        } else {
            li.style.paddingLeft='0'; li.style.marginBottom='0.5rem';
        }

        const content = document.createElement('div');
        content.className = 'relative z-10 w-full pl-2';
        let displayTime = ''; let displayText = task.text;
        if(type === 'project' && numberPrefix) { if (!task.depth || task.depth === 0) displayText = `${numberPrefix}. ${displayText}`; }
        if(type === 'daily') {
            if(task.manualTimeRange) displayTime = task.manualTimeRange;
            else { const m = displayText.match(/(\d{1,2}:\d{2})\s*[~-]\s*(\d{1,2}:\d{2})/); if(m) { displayTime = m[0]; displayText = displayText.replace(m[0], '').trim(); } }
        }
        if(displayTime) content.innerHTML += `<div class="task-time-label">${displayTime}</div>`;

        const row = document.createElement('div');
        row.className = 'flex justify-between items-start';
        const leftCol = document.createElement('div');
        leftCol.className = 'flex-1 todo-text text-sm leading-relaxed cursor-pointer hover:text-[#8D6E63]';
        leftCol.innerText = displayText;
        leftCol.onclick = () => window.openEditTimeModal(type, key, index, task);
        row.appendChild(leftCol);

        const rightCol = document.createElement('div');
        rightCol.className = 'flex items-center gap-2 shrink-0';
        if(type === 'daily' && !task.done) {
            if(!task.actualStartTime) {
                const btn = document.createElement('button');
                btn.className = 'text-[10px] bg-[#FFF9C4] text-[#FBC02D] px-2 py-0.5 rounded-full font-bold hover:bg-[#FFF59D] font-hand border border-[#FFF59D]';
                btn.innerText = 'Start';
                btn.onclick = (e) => { e.stopPropagation(); openTimerModal({type, key, index, task}); };
                rightCol.appendChild(btn);
            } else if (task.actualStartTime && !task.actualEndTime) {
                 const btn = document.createElement('button');
                 btn.className = 'text-[10px] bg-[#FFCCBC] text-[#D84315] px-2 py-0.5 rounded-full font-bold animate-pulse font-hand border border-[#FFAB91]';
                 btn.innerText = 'Ing...';
                 btn.onclick = (e) => { e.stopPropagation(); openTimerModal({type, key, index, task}); };
                 rightCol.appendChild(btn);
            }
        }
        const chk = document.createElement('input');
        chk.type = 'checkbox';
        chk.className = 'custom-checkbox';
        chk.checked = task.done;
        chk.onclick = (e) => { e.preventDefault(); e.stopPropagation(); openFeedbackModal({type, key, index, task}); };
        if(type === 'project' && (!task.depth || task.depth === 0)) chk.style.display = 'none';
        rightCol.appendChild(chk);
        row.appendChild(rightCol);
        content.appendChild(row);

        if (type !== 'weekly' && task.advice && !task.done) content.innerHTML += `<div class="mt-1 text-[11px] text-[#A1887F] bg-[#EFEBE9]/30 px-2 py-1 rounded block">${task.advice}</div>`;
        if(task.feedback) content.innerHTML += `<div class="mt-1 text-[10px] text-[#8D6E63] italic">ğŸ’¬ ${task.feedback}</div>`;
        li.appendChild(content);
        return li;
    }

    // Modal Helpers
    function openAddTaskModal(existing=null, type='daily') {
        editingTask = existing;
        currentTaskTypeForAdd = type;
        const modalTitle = document.getElementById('taskModalTitle');
        modalTitle.innerText = existing ? 'í•  ì¼ ìˆ˜ì •' : 'í•  ì¼ ì¶”ê°€';
        document.getElementById('addTaskModal').classList.remove('hidden');
        if (existing) {
            document.getElementById('manualTaskText').value = existing.task.text;
            if (existing.task.specificDate) document.getElementById('weeklyTaskDate').value = existing.task.specificDate;
            if (existing.task.manualTimeRange) {
                const parts = existing.task.manualTimeRange.split('~');
                if (parts[0]) { const s = parts[0].trim().split(':'); document.getElementById('startHour').value = s[0]; document.getElementById('startMin').value = s[1]; }
                if (parts[1]) { const e = parts[1].trim().split(' ')[0].split(':'); if(e.length===2) { document.getElementById('endHour').value = e[0]; document.getElementById('endMin').value = e[1]; } }
            }
        } else {
            editingTask = null;
            document.getElementById('manualTaskText').value = '';
            document.getElementById('startHour').value = ''; document.getElementById('startMin').value = '';
            document.getElementById('endHour').value = ''; document.getElementById('endMin').value = '';
            document.getElementById('weeklyTaskDate').value = '';
        }
        const dailyWrapper = document.getElementById('dailyTimeInputWrapper');
        const weeklyWrapper = document.getElementById('weeklyDateInputWrapper');
        if (currentTaskTypeForAdd === 'weekly') { dailyWrapper.classList.add('hidden'); weeklyWrapper.classList.remove('hidden'); }
        else { dailyWrapper.classList.remove('hidden'); weeklyWrapper.classList.add('hidden'); }
        const btnDelete = document.getElementById('btnDeleteTask');
        if(btnDelete) { if(editingTask) btnDelete.classList.remove('hidden'); else btnDelete.classList.add('hidden'); }
    }
    function confirmTaskAction() {
        const text = document.getElementById('manualTaskText').value;
        if (!text) return alert('ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        const sh = document.getElementById('startHour').value; const sm = document.getElementById('startMin').value;
        const eh = document.getElementById('endHour').value; const em = document.getElementById('endMin').value;
        let timeStr = null; if(sh && sm && eh && em) timeStr = `${sh}:${sm} ~ ${eh}:${em}`; else if(sh && sm) timeStr = `${sh}:${sm} ~`;
        const specificDate = document.getElementById('weeklyTaskDate').value;

        if (editingTask) {
            const changes = { text: text };
            if (currentTaskTypeForAdd === 'weekly') { changes.specificDate = specificDate; changes.manualTimeRange = null; }
            else { changes.manualTimeRange = timeStr; changes.specificDate = null; }
            updateTask(editingTask.type, editingTask.key, editingTask.index, changes);
        } else {
            if (currentTaskTypeForAdd === 'weekly') {
                const wk = getWeekKey(new Date());
                if(!appData.weekly[wk]) appData.weekly[wk] = { tasks: [] };
                appData.weekly[wk].tasks.push({ text: text, done: false, manualTimeRange: null, specificDate: specificDate, feedback: null, isMessage: false });
            } else {
                if(!appData.daily[selectedDate]) appData.daily[selectedDate] = [];
                appData.daily[selectedDate].push({ text: text, done: false, manualTimeRange: timeStr, feedback: null, isMessage: false });
            }
            saveData(); renderApp();
        }
        closeModal('addTaskModal');
    }
    window.deleteTaskFromModal = function() { if (!editingTask) return; if (confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) { deleteTaskItem(editingTask.type, editingTask.key, editingTask.index); closeModal('addTaskModal'); } };
    function openEditTimeModal(type, key, index, task) { openAddTaskModal({type, key, index, task}, type); }
    function openInputModal(title, cb) { document.getElementById('inputModalTitle').innerText = title; document.getElementById('inputModalField').value = ''; document.getElementById('inputModal').classList.remove('hidden'); document.getElementById('inputModalField').focus(); inputCallback = cb; }
    function closeInputModal() { document.getElementById('inputModal').classList.add('hidden'); inputCallback = null; }
    function confirmInput() { if(inputCallback) inputCallback(document.getElementById('inputModalField').value); closeInputModal(); }
    function switchProjMode(m) { projMode = m; document.getElementById('pm-range').classList.toggle('active', m==='range'); document.getElementById('pm-select').classList.toggle('active', m==='select'); document.getElementById('projModeRange').classList.toggle('hidden', m!=='range'); document.getElementById('projModeSelect').classList.toggle('hidden', m!=='select'); if(m==='select') renderProjCal(); }
    function renderProjCal() {
        const y = projCalDate.getFullYear(); const m = projCalDate.getMonth();
        document.getElementById('projCalTitle').innerText = `${y}.${m+1}`;
        const container = document.getElementById('projCalGrid');
        container.innerHTML = '<div>ì¼</div><div>ì›”</div><div>í™”</div><div>ìˆ˜</div><div>ëª©</div><div>ê¸ˆ</div><div>í† </div>';
        const firstDay = new Date(y, m, 1).getDay(); const lastDate = new Date(y, m+1, 0).getDate();
        for(let i=0; i<firstDay; i++) container.innerHTML += '<div></div>';
        for(let i=1; i<=lastDate; i++) {
            const dateStr = `${y}-${(m+1).toString().padStart(2,'0')}-${i.toString().padStart(2,'0')}`;
            const el = document.createElement('div'); el.className = 'mini-cal-cell';
            if(selectedProjDates.has(dateStr)) el.classList.add('selected');
            el.innerText = i;
            el.onclick = () => { if(selectedProjDates.has(dateStr)) selectedProjDates.delete(dateStr); else selectedProjDates.add(dateStr); renderProjCal(); document.getElementById('selectedCount').innerText = selectedProjDates.size; };
            container.appendChild(el);
        }
    }
    function moveProjCal(d) { projCalDate.setMonth(projCalDate.getMonth() + d); renderProjCal(); }
    function confirmCreateProject() {
        const title = document.getElementById('projTitle').value;
        const desc = document.getElementById('projDesc').value;
        if(!title) return alert('í”„ë¡œì íŠ¸ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
        let dateDisplay = ''; let type = ''; let dateArray = null; let startDate = null; let endDate = null;
        if(projMode === 'range') {
            const start = document.getElementById('projStart').value; const end = document.getElementById('projEnd').value;
            if(!start || !end) return alert('ê¸°ê°„ì„ ì„¤ì •í•´ì£¼ì„¸ìš”');
            dateDisplay = `${start} ~ ${end}`; type = 'range'; startDate = start; endDate = end;
        } else {
            if(selectedProjDates.size === 0) return alert('ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”');
            const sorted = Array.from(selectedProjDates).sort();
            dateDisplay = `ì´ ${selectedProjDates.size}ì¼ (${sorted[0]}...)`; type = 'select'; dateArray = sorted; startDate = sorted[0]; endDate = sorted[sorted.length-1];
        }
        appData.projects.push({ id: Date.now()+'', title: title, desc: desc, dateDisplay: dateDisplay, dates: type === 'select' ? dateArray : null, startDate: startDate, endDate: endDate, tasks:[], completed: false });
        saveData(); renderApp(); closeModal('projectInputModal');
    }
    function openProjectModal() { document.getElementById('projTitle').value = ''; document.getElementById('projDesc').value = ''; document.getElementById('projStart').value = ''; document.getElementById('projEnd').value = ''; selectedProjDates.clear(); switchProjMode('range'); document.getElementById('projectInputModal').classList.remove('hidden'); }
    function openProjectPlanModal(pid) {
        activeProjectId = pid;
        const p = appData.projects.find(x => x.id === pid);
        const currentYear = new Date().getFullYear();
        let dateContext = "";
        if (p.dates && p.dates.length > 0) dateContext = `ì„ íƒëœ ë‚ ì§œë“¤: ${p.dates.join(', ')}`; else if (p.dateDisplay) dateContext = `ê¸°ê°„: ${p.dateDisplay}`;
        const defaultPrompt = `í”„ë¡œì íŠ¸: ${p.title}\nëª©í‘œ: ${p.desc || 'ëª©í‘œ ì—†ìŒ'}\n${dateContext}\n(ì°¸ê³ : ì˜¤ëŠ˜ì€ ${currentYear}ë…„ì´ì•¼. ë‚ ì§œ ê³„ì‚° ì‹œ ì—°ë„ë¥¼ ${currentYear}ë…„ìœ¼ë¡œ ë§ì¶°ì¤˜.)\n\nìœ„ ì¼ì •ì„ ê³ ë ¤í•˜ì—¬ êµ¬ì²´ì ì¸ ì‹¤í–‰ ê³„íšì„ ì§œì¤˜.\n[í•„ìˆ˜ í˜•ì‹]\n1. ë‚ ì§œë³„ êµ¬ë¶„: ë‚ ì§œ í—¤ë”ëŠ” ë°˜ë“œì‹œ '[Day N: YYYY-MM-DD]' í˜•ì‹ìœ¼ë¡œ ì¨ì¤˜.\n(ì˜ˆ: [Day 1: ${currentYear}-05-01])\n2. í•  ì¼: í—¤ë” ì•„ë˜ì— í•  ì¼ì„ ë‚˜ì—´í•´.\n3. í•˜ìœ„ í•­ëª©: í•˜ìœ„ ë‹¨ê³„ê°€ í•„ìš”í•˜ë©´ ë“¤ì—¬ì“°ê¸°(ìŠ¤í˜ì´ìŠ¤ 2ì¹¸)ë‚˜ '>'ë¥¼ ì‚¬ìš©í•´ì¤˜.\n4. íŒ/ì¡°ì–¸: íŒì´ë‚˜ ì¡°ì–¸ì€ '[TIP] ë‚´ìš©' í˜•ì‹ìœ¼ë¡œ ì¨ì¤˜.\nì‘ì„± ì˜ˆì‹œ:\n[Day 1: ${currentYear}-05-01]\n- ìë£Œ ìˆ˜ì§‘í•˜ê¸°\n  - êµ¬ê¸€ í•™ìˆ  ê²€ìƒ‰\n  - ë„ì„œê´€ ë°©ë¬¸\n[TIP] ë¬´ë¦¬í•˜ì§€ ë§ê³  30ë¶„ì”© ë‚˜ëˆ ì„œ í•˜ì„¸ìš”.\n[Day 2: ${currentYear}-05-02]\n- ì´ˆì•ˆ ì‘ì„±\n`;
        document.getElementById('projectPlanPrompt').value = p.customPrompt || defaultPrompt;
        document.getElementById('projectPlanModal').classList.remove('hidden');
    }
    function confirmProjectPlan() {
        const prompt = document.getElementById('projectPlanPrompt').value;
        const p = appData.projects.find(x => x.id === activeProjectId);
        if(p) { p.customPrompt = prompt; saveData(); }
        showLoading("zipipoê°€ í”„ë¡œì íŠ¸ ê³„íšì„ ì„¸ìš°ëŠ” ì¤‘");
        closeModal('projectPlanModal');
        callGemini(`ì—­í• : í”„ë¡œì íŠ¸ ë§¤ë‹ˆì €.\nìš”ì²­: ${prompt}\nê·œì¹™: ìœ„ì—ì„œ ì œì‹œí•œ [í•„ìˆ˜ í˜•ì‹]ì„ ì—„ê²©íˆ ì¤€ìˆ˜í•´ì¤˜.`, (text) => {
            const lines = text.split('\n');
            const newTasks = [];
            let currentDate = null;
            lines.forEach(line => {
                const clean = line.trim();
                if(!clean) return;
                const dayMatch = clean.match(/\[Day \d+: (\d{4}-\d{2}-\d{2})\]/);
                if(dayMatch) { currentDate = dayMatch[1]; return; }
                const tipMatch = clean.match(/\[TIP\] (.*)/);
                if(tipMatch) { newTasks.push({ text: tipMatch[1], isTip: true }); return; }
                if(clean.startsWith('-') || clean.startsWith('â€¢') || clean.startsWith('>')) {
                    let taskText = clean.replace(/^[-â€¢>]\s*/, '').trim();
                    let depth = 0;
                    if(line.startsWith('    ') || line.startsWith('\t\t')) depth = 2;
                    else if(line.startsWith('  ') || line.startsWith('\t')) depth = 1;
                    newTasks.push({ text: taskText, date: currentDate, depth: depth, done: false });
                } else if(!clean.includes('[') && clean.length > 2) {
                     newTasks.push({ text: clean, type: 'header', date: currentDate });
                }
            });
            const p = appData.projects.find(x => x.id === activeProjectId);
            if(p) { p.tasks = newTasks; saveData(); renderApp(); }
            hideLoading();
        });
    }

    // Init
    setInterval(() => { const now = getLocalDateStr(new Date()); if (now !== lastKnownToday) { lastKnownToday = now; selectedDate = now; currentWeekBaseDate = new Date(); renderApp(); } }, 60000); 
    renderHeader(); initTimeSelects(); loadData(); renderApp();
    const savedKey = localStorage.getItem(STORAGE_KEY_API); if(!savedKey) toggleApiKeyInput();
</script>
</body>
</html>
